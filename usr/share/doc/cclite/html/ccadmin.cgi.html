<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>ccadmin.cgi</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>ccadmin.cgi</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<pre>#!/usr/bin/perl
<span class="k">my</span> <span class="i">$test</span> = <span class="n">0</span><span class="sc">;</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$test</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="i">STDOUT</span> <span class="q">&quot;Content-Type: text/html; charset=utf-8\n\n&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&lt;DATA&gt;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">eval</span> <span class="i">$data</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;&lt;H1&gt;Syntax  error!&lt;/H1&gt;\n&lt;PRE&gt;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;&lt;/PRE&gt;\n&quot;</span><span class="sc">;</span>
        <span class="k">exit</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>
<span class="c">###__END__</span>

<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS</span>
<span class="c">#OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,</span>
<span class="c">#OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,</span>
<span class="c">#ANY IMPLIED WARRANTIES OF MERCHANTABILITY,</span>
<span class="c">#FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.</span>
<span class="c">#WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,</span>
<span class="c">#INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,</span>
<span class="c">#INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,</span>
<span class="c">#LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,</span>
<span class="c">#REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER</span>
<span class="c">#WHICH THE LIABILITY MAY BE ASSERTED,</span>
<span class="c">#EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.</span>
<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#</span>

</pre><p></p>
<hr />
<h1><a name="name">NAME</a></h1>
<p>ccadmin.cgi</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>administration controller for Cclite</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<pre>
 this is the version 2 administration controller for cclite:</pre>
<pre>
 - multiple registry, registry passed in %fields
 - multiple transaction, logon and transfer can be one operation
 - maximum simplicity, nearly everything is passed as %fields
 - sha1, ip + user + value based hashing
 - internal key never transmitted over network
 - mysql based database + DBI + ODBC (can be access, for example)
 - web services retained
 - multilingual elements provided by translating screens + cookie
 - maximum use of static html for lightweight running</pre>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>cclite.cgi</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced</p>
<pre>

=cut</pre>
<pre>
<span class="k">BEGIN</span> <span class="s">{</span>
    <span class="k">use</span> <span class="w">CGI::Carp</span> <span class="q">qw(fatalsToBrowser set_message)</span><span class="sc">;</span>
    <span class="i">set_message</span><span class="s">(</span>
<span class="q">&quot;Please use the &lt;a title=\&quot;cclite google group\&quot; href=\&quot;http://groups.google.co.uk/group/cclite\&quot;&gt;Cclite Google Group&lt;/a&gt; for help, if necessary&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>
<span class="k">use</span> <span class="w">lib</span> <span class="q">&#39;../../lib&#39;</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash</p>

<pre>
<span class="c"># no soap and associated modules required,</span>
<span class="c"># if you declare multiregistry=no in cclite.cf</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">multiregistry</span>} <span class="k">eq</span> <span class="q">&quot;yes&quot;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">require</span> <span class="w">SOAP::Lite</span><span class="sc">;</span>    <span class="c"># uses this for remote lookups etc.</span>
    <span class="w">import</span> <span class="w">SOAP::Lite</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># no rss and XML::Rss and associated modules required,</span>
<span class="c"># if you declare userss=no in cclite.cf</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">userss</span>} <span class="k">eq</span> <span class="q">&quot;yes&quot;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">require</span> <span class="w">Ccrss</span><span class="sc">;</span>         <span class="c"># uses this for remote lookups etc.</span>
    <span class="w">import</span> <span class="w">Ccrss</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">HTML::SimpleTemplate</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>              <span class="c"># use the cookie module</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>                   <span class="c"># use the utilities module</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>            <span class="c"># use the validation and javascript routines</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>                <span class="c"># use the main motor</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>       <span class="c"># new style configuration</span>

<span class="k">use</span> <span class="w">Ccadmin</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccchecker</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">locale</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>              <span class="c"># probably should be via Cclite.pm only, not directly</span>

<span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$cookies</span><span class="cm">,</span>
    <span class="i">$templatename</span><span class="cm">,</span> <span class="i">$registry_private_value</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># for the moment</span>

<span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$configref</span>     = \<span class="i">%configuration</span><span class="sc">;</span>

<span class="c"># message language now decided by decide_language 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%fields</span> = <span class="i">cgiparse</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$offset</span> = <span class="i">$fields</span>{<span class="w">offset</span>}<span class="sc">;</span>

<span class="c">#  this should use the version modules, but that makes life more</span>
<span class="c"># complex for intermediate users</span>
<span class="i">$fields</span>{<span class="w">version</span>} = <span class="i">$configuration</span>{<span class="w">version</span>}<span class="sc">;</span>

<span class="c"># This is the token that is to be carried everywhere, preventing</span>
<span class="c"># session hijack etc. It&#39;s probably going to be a GnuPg public key</span>
<span class="c"># anyway it&#39;s a public key of some kind related to the cclite installations</span>
<span class="c"># private key, not transmitted and protected by passphrase</span>
<span class="i">$registry_private_value</span> = <span class="i">$token</span> =
  <span class="i">$configuration</span>{<span class="w">registrypublickey</span>}<span class="sc">;</span>    <span class="c"># for the moment, calculated later</span>

<span class="c"># means that multiregistry indication is accessible without passing</span>
<span class="c"># configuration information everywhere</span>
<span class="i">$fields</span>{<span class="w">multiregistry</span>} = <span class="i">$configuration</span>{<span class="w">multiregistry</span>}<span class="sc">;</span>

<span class="c"># means service charge will be tested against this maximum if there&#39;s</span>
<span class="c"># a numeric value in this field</span>
<span class="i">$fields</span>{<span class="w">servicechargelimit</span>} = <span class="i">$configuration</span>{<span class="w">servicechargelimit</span>}<span class="sc">;</span>

<span class="c"># number of records per page in lists ex-db tables, change at will</span>
<span class="k">my</span> <span class="i">$limit</span> = <span class="i">$fields</span>{<span class="w">limit</span>} || <span class="i">$configuration</span>{<span class="w">linesperpage</span>}<span class="sc">;</span>

<span class="c"># Switches on/off decimals, sent to index page</span>
<span class="i">$fields</span>{<span class="w">usedecimals</span>} = <span class="i">$configuration</span>{<span class="w">usedecimals</span>}<span class="sc">;</span>

<span class="c"># now take these from configuration because of unreliable $ENV{SERVER_NAME} 11/2009</span>
<span class="c">#FIXME: But creates problem with certain admin actions...modify currency etc...</span>
<span class="i">$fields</span>{<span class="w">home</span>}   = <span class="i">$configuration</span>{<span class="w">home</span>}<span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">domain</span>} = <span class="i">$configuration</span>{<span class="w">domain</span>}<span class="sc">;</span>

<span class="c"># get the html path, this is needed to create extra subdirectories for graphs etc.</span>
<span class="i">$fields</span>{<span class="w">htmlpath</span>} = <span class="i">$configuration</span>{<span class="w">htmlpath</span>}<span class="sc">;</span>

<span class="c"># change these to suit</span>
<span class="k">my</span> <span class="i">$home</span>      = <span class="i">$fields</span>{<span class="w">home</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$user_home</span> = <span class="i">$home</span><span class="sc">;</span>
<span class="i">$user_home</span> =~ <span class="q">s/(\/protected)\/ccadmin.cgi/\/cclite.cgi/</span><span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">home</span>} = <span class="i">$user_home</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$fields</span>{<span class="w">action</span>} <span class="k">eq</span> <span class="q">&quot;logoff&quot;</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="c">#---------------------------------------------------------------------------</span>
<span class="c"># change the language default here, languages should be ISO 639 lower case</span>
<span class="c">#</span>
<span class="k">my</span> <span class="i">$language</span> = <span class="i">decide_language</span><span class="s">(</span><span class="i">$fieldsref</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$pagename</span> = <span class="i">$fields</span>{<span class="w">name</span>} || <span class="q">&quot;front.html&quot;</span><span class="sc">;</span>    <span class="c"># default is the index page</span>

<span class="k">my</span> <span class="i">$action</span> = <span class="i">$fields</span>{<span class="w">action</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$table</span>  = <span class="i">$fields</span>{<span class="w">subaction</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$db</span>     = <span class="i">$cookieref</span>-&gt;{<span class="w">registry</span>} || <span class="i">$fields</span>{<span class="w">registry</span>}<span class="sc">;</span>

<span class="c"># A template object referencing a particular directory</span>
<span class="k">my</span> <span class="i">$template_path</span> = <span class="q">&quot;../../templates/html/$language/admin&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$pages</span>         = <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="i">$template_path</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$user_pages</span>    = <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="q">&quot;../../templates/html/$language&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># FIXME:</span>
<span class="c"># this sequence deals with the security of admin actions, probably</span>
<span class="c"># need to be abstracted away from both ccadmin.cgi and cclite.cgi, duplicated</span>

<span class="c"># need to be an admin, need to be logged on, back to logon</span>
<span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">userLevel</span>} <span class="s">)</span>
    &amp;&amp; <span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">userLevel</span>} <span class="k">ne</span> <span class="q">&#39;admin&#39;</span> <span class="s">)</span> <span class="s">)</span>
<span class="s">{</span>

    <span class="i">$fields</span>{<span class="w">menustyle</span>} = <span class="q">&quot;grey&quot;</span><span class="sc">;</span>
    <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pages</span> = <span class="i">$user_pages</span><span class="sc">;</span>
    <span class="i">display_template</span><span class="s">(</span>
        <span class="q">&quot;1&quot;</span><span class="cm">,</span>         <span class="i">$user_home</span><span class="cm">,</span>
        <span class="q">&quot;&quot;</span><span class="cm">,</span>          <span class="i">$messages</span>{<span class="w">notanadmin</span>}<span class="cm">,</span>
        <span class="i">$user_pages</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span>
        <span class="i">$fieldsref</span><span class="cm">,</span>  <span class="i">$cookies</span><span class="cm">,</span>
        <span class="i">$token</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># just to give upper case display for admin menu</span>
<span class="i">$fields</span>{<span class="w">registrytitle</span>} = <span class="q">&quot;\u$fieldsref-&gt;{name}&quot;</span><span class="sc">;</span>

<span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

<span class="c"># grumble about installer etc.</span>
<span class="s">(</span> <span class="k">my</span> <span class="i">$installer_present</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;errors&#39;</span>} <span class="s">)</span> = <span class="i">install_grumble</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;installer_link&#39;</span>} = <span class="i">get_installer_link</span><span class="s">(</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span><span class="i">$installer_present</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># display fields and status for all the batch file paths</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$errors</span><span class="cm">,</span> <span class="i">$report_ref</span><span class="cm">,</span> <span class="i">$file_ref</span> <span class="s">)</span> =
  <span class="i">get_set_batch_files</span><span class="s">(</span> <span class="q">&#39;get&#39;</span><span class="cm">,</span> <span class="i">$configref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$report_ref</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="w">displaybatchfiles</span>} .= <span class="i">$report_ref</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c"># there is a token but it&#39;s been modified or spoofed</span>
<span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">userLogin</span>} <span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

    <span class="c"># calculate token to compare with cookie version</span>
    <span class="k">my</span> <span class="i">$compare_token</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$compare_token</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span> =
      <span class="i">calculate_token</span><span class="s">(</span> <span class="i">$registry_private_value</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span>
        <span class="i">$ENV</span>{<span class="w">REMOTE_ADDR</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="w">token</span>} <span class="s">)</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$compare_token</span> <span class="k">ne</span> <span class="i">$cookieref</span>-&gt;{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

        <span class="c"># attempt to exit cleanly</span>
        <span class="i">$action</span> = <span class="q">&#39;logoff&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># no userLogin or no token, don&#39;t allow anything, go back to logon</span>
<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

    <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pages</span> = <span class="i">$user_pages</span><span class="sc">;</span>
    <span class="i">display_template</span><span class="s">(</span>
        <span class="q">&quot;1&quot;</span><span class="cm">,</span>         <span class="i">$user_home</span><span class="cm">,</span>
        <span class="q">&quot;&quot;</span><span class="cm">,</span>          <span class="i">$messages</span>{<span class="w">notanadmin</span>}<span class="cm">,</span>
        <span class="i">$user_pages</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span>
        <span class="i">$fieldsref</span><span class="cm">,</span>  <span class="i">$cookies</span><span class="cm">,</span>
        <span class="i">$token</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>

<span class="s">}</span>

<span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;count&#39;</span>} =
  <span class="i">get_logged_in_count</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># Controller based on the action field</span>
<span class="c"># &#39;local&#39; is added to routines that are invoked locally to fill the class field</span>
<span class="c"># when they are invoked via soaplite, this is filled automatically</span>
<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;insert&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;find&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">find_records</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>     <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39; &#39;</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span>  <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;delete&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">delete_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;modify&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$home</span><span class="cm">,</span>      <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
    = <span class="i">modify_database_record</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;display&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">show_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;update&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">update_database_record</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># shutdown for maintenance</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;offline&quot;</span> <span class="s">)</span> <span class="s">{</span>

    <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
          <span class="i">go_offline</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># bring up after maintenance</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;online&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">go_online</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># add a registry partner either local or soap proxy</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;addpartner&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_partner</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_partners&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># update preferences, probably in cclite...</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;prefs&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">update_prefs</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_prefs&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># get locked accounts</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;getlocked&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">get_locked</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># get locked accounts</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;unlockuser&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">unlock_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;template&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> = <span class="i">display_template</span><span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="c"># these are specific actions which belong to the admin application</span>
<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;addcurrency&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_currency</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;servicecharge&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span> <span class="s">)</span> =
    <span class="i">apply_service_charge</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;createrss&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">create_rss_feed</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$user_home</span><span class="cm">,</span> <span class="q">&#39;desc&#39;</span><span class="cm">,</span> <span class="q">&#39;hugh,barnard@laposte.net&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
        <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="c"># show registry currencies</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showcurrencies&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">get_many_items</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="q">&#39;id&#39;</span><span class="cm">,</span>    <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span>          <span class="i">$token</span><span class="cm">,</span>
        <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># show partner registries</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showpartners&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">get_many_items</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_partners&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="q">&#39;id&#39;</span><span class="cm">,</span>    <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span>        <span class="i">$token</span><span class="cm">,</span>
        <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># build batch files for registry, used principally to fix problems and for cpanel</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;setbatchdirs&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="i">get_set_batch_files</span><span class="s">(</span> <span class="q">&#39;set&#39;</span><span class="cm">,</span> <span class="i">$configref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;logon&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">logon_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;logoff&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="i">logoff_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$user_pages</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
    <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;functiondoc&quot;</span> <span class="s">)</span> &amp;&amp; <span class="i">functiondoc</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="w">librarypath</span>} <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;lang&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>     <span class="i">$html</span><span class="cm">,</span>
        <span class="i">$pages</span><span class="cm">,</span>   <span class="i">$pagename</span><span class="cm">,</span>    <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span>
    <span class="s">)</span>
    = <span class="i">change_language</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># show balance and volume</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showbalvol&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;manager&#39;</span><span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># pro-tem, read the mail file</span>
<span class="c">#</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;readmail&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">read_mail_transactions</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;addcategory&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_category</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># display the a template, if requested</span>
<span class="i">$action</span> =~ <span class="q">/template/</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> = <span class="i">display_template</span><span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># display an action result, all actions are consumed</span>
<span class="i">display_template</span><span class="s">(</span>
    <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
    <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
<span class="s">)</span><span class="sc">;</span>
<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>

</pre></body>

</html>
