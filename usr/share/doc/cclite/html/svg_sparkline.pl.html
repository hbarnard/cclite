<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Tue Oct 25 20:41:48 2011 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>svg_sparkline.pl</title>
<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
</head>
<body>
<a name="-top-"></a>
<h1>svg_sparkline.pl</h1>
<hr />
<!-- contents of filename: svg_sparkline.pl -->
<pre>
#!/usr/bin/perl
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">LWP::Simple</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">SVG</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI</span> <span class="q">qw(:standard)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$counter</span><span class="sc">;</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">@dates</span><span class="cm">,</span> <span class="i">@adj_closes</span><span class="cm">,</span> <span class="i">@volumes</span> <span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$min</span><span class="cm">,</span>   <span class="i">$max</span><span class="cm">,</span>        <span class="i">$maxvol</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#form parameters</span>
<span class="k">my</span> <span class="i">$symbol</span> = <span class="i">param</span><span class="s">(</span><span class="q">&#39;symbol&#39;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$full</span>   = <span class="i">param</span><span class="s">(</span><span class="q">&#39;full&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#my $symbol = &#39;MSFT&#39;;</span>

<span class="c">#-------------------------------------------------------------------------------------------------------------</span>
<span class="c">#PROCESS THE CSV FILE</span>
<span class="c">#-------------------------------------------------------------------------------------------------------------</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$day</span><span class="cm">,</span> <span class="i">$month</span><span class="cm">,</span> <span class="i">$year</span> <span class="s">)</span> = <span class="s">(</span><span class="k">localtime</span><span class="s">)</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span> ]<span class="sc">;</span>
<span class="k">my</span> <span class="i">$url</span> =
    <span class="q">&quot;http://ichart.yahoo.com/table.csv?&quot;</span>
  . <span class="q">&quot;ignore=.csv&amp;s=&quot;</span>
  . <span class="i">$symbol</span> . <span class="q">&quot;&amp;a=&quot;</span>
  . <span class="i">$month</span> . <span class="q">&quot;&amp;b=&quot;</span>
  . <span class="i">$day</span> . <span class="q">&quot;&amp;c=&quot;</span>
  . <span class="s">(</span> <span class="i">$year</span> + <span class="n">1899</span> <span class="s">)</span> . <span class="q">&quot;&amp;d=&quot;</span>
  . <span class="i">$month</span> . <span class="q">&quot;&amp;e=&quot;</span>
  . <span class="i">$day</span> . <span class="q">&quot;&amp;f=&quot;</span>
  . <span class="s">(</span> <span class="i">$year</span> + <span class="n">1900</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#print $url . &quot;\n&quot;;</span>
<span class="c">#get the file from yahoo</span>
<span class="k">my</span> <span class="i">$content</span> = <span class="i">get</span><span class="s">(</span><span class="i">$url</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#split the rows</span>
<span class="k">my</span> <span class="i">@lines</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\n/</span><span class="cm">,</span> <span class="i">$content</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#go through each line</span>
<span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span><span class="i">@lines</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span> =~ <span class="q">/[0-9]{1,2}\-/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$open</span><span class="cm">,</span> <span class="i">$high</span><span class="cm">,</span> <span class="i">$low</span><span class="cm">,</span> <span class="i">$close</span><span class="cm">,</span> <span class="i">$volume</span><span class="cm">,</span> <span class="i">$adj_close</span> <span class="s">)</span> =
          <span class="k">split</span><span class="s">(</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$row</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$dates</span>[<span class="i">$counter</span>]      = <span class="i">$date</span><span class="sc">;</span>
        <span class="i">$adj_closes</span>[<span class="i">$counter</span>] = <span class="i">$adj_close</span><span class="sc">;</span>
        <span class="i">$volumes</span>[<span class="i">$counter</span>]    = <span class="i">$volume</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$counter</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$min</span>    = <span class="i">$adj_close</span><span class="sc">;</span>
            <span class="i">$max</span>    = <span class="i">$adj_close</span><span class="sc">;</span>
            <span class="i">$maxvol</span> = <span class="i">$volume</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$min</span>] &gt; <span class="i">$adj_close</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$min</span>    = <span class="i">$counter</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] &lt; <span class="i">$adj_close</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$max</span>    = <span class="i">$counter</span><span class="sc">;</span> <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$volumes</span>[<span class="i">$maxvol</span>] &lt; <span class="i">$volume</span> <span class="s">)</span>    <span class="s">{</span> <span class="i">$maxvol</span> = <span class="i">$counter</span><span class="sc">;</span> <span class="s">}</span>

        <span class="s">}</span>

        <span class="i">$counter</span>++<span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c">#-------------------------------------------------------------------------------------------------------------</span>
<span class="c">#Calculations</span>
<span class="c">#-------------------------------------------------------------------------------------------------------------</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$txsize</span><span class="cm">,</span> <span class="i">$tysize</span><span class="cm">,</span> <span class="i">$xsize</span><span class="cm">,</span> <span class="i">$ysize</span><span class="cm">,</span> <span class="i">$xpos</span><span class="cm">,</span> <span class="i">$ypos</span> <span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$step</span><span class="cm">,</span> <span class="i">$smallfontsize</span><span class="cm">,</span> <span class="i">$bigfontsize</span><span class="cm">,</span> <span class="i">$lastmove</span><span class="cm">,</span> <span class="i">$color</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#total sparkline size</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">&#39;xsize&#39;</span><span class="s">)</span> == <span class="q">&#39;&#39;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">$txsize</span> = <span class="n">220</span><span class="sc">;</span>
<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
    <span class="i">$txsize</span> = <span class="i">param</span><span class="s">(</span><span class="q">&#39;xsize&#39;</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">param</span><span class="s">(</span><span class="q">&#39;ysize&#39;</span><span class="s">)</span> == <span class="q">&#39;&#39;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">$tysize</span> = <span class="n">50</span><span class="sc">;</span>
<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
    <span class="i">$tysize</span> = <span class="i">param</span><span class="s">(</span><span class="q">&#39;ysize&#39;</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#font size for small labels</span>
<span class="i">$smallfontsize</span> = <span class="i">$tysize</span> / <span class="n">5</span><span class="sc">;</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">$smallfontsize</span> &lt; <span class="n">7</span> <span class="s">)</span> <span class="s">{</span> <span class="i">$smallfontsize</span> = <span class="n">7</span><span class="sc">;</span> <span class="s">}</span>

<span class="c">#font size for big labels</span>
<span class="i">$bigfontsize</span> = <span class="i">$tysize</span> / <span class="n">2.5</span><span class="sc">;</span>

<span class="c">#initial x and y position of the path</span>
<span class="i">$xpos</span> = <span class="i">$bigfontsize</span> * <span class="n">2</span><span class="sc">;</span>
<span class="i">$ypos</span> = <span class="i">$tysize</span> - <span class="i">$smallfontsize</span><span class="sc">;</span>

<span class="c">#total size of the path</span>
<span class="i">$xsize</span> = <span class="i">$txsize</span> - <span class="i">$xpos</span> * <span class="n">2.5</span><span class="sc">;</span>
<span class="i">$ysize</span> = <span class="i">$tysize</span> - <span class="i">$ypos</span> / <span class="n">1.3</span><span class="sc">;</span>

<span class="c">#step</span>
<span class="i">$step</span> = <span class="i">$xsize</span> / --<span class="i">$counter</span><span class="sc">;</span>

<span class="c">#last move</span>
<span class="i">$lastmove</span> = <span class="i">$adj_closes</span>[<span class="n">0</span>] - <span class="i">$adj_closes</span>[<span class="n">1</span>]<span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> <span class="i">$lastmove</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">$color</span> = <span class="q">&#39;blue&#39;</span><span class="sc">;</span>
<span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
    <span class="i">$color</span> = <span class="q">&#39;red&#39;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#-------------------------------------------------------------------------------------------------------------</span>
<span class="c">#SVG Creation &amp; Output</span>
<span class="c">#-------------------------------------------------------------------------------------------------------------</span>
<span class="k">print</span><span class="s">(</span><span class="q">&quot;Content-Type: image/svg+xml\n\n&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># create an SVG object</span>
<span class="k">my</span> <span class="i">$svg</span> = <span class="w">SVG</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">width</span> <span class="cm">=&gt;</span> <span class="i">$txsize</span><span class="cm">,</span> <span class="w">height</span> <span class="cm">=&gt;</span> <span class="i">$tysize</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#create path</span>
<span class="k">my</span> <span class="i">$path</span><span class="sc">;</span>

<span class="c">#v&Atilde;&#149;(i) = (v(i) -  minA)/(maxA - minA)* (new_maxA)</span>

<span class="i">$path</span> =
    <span class="q">&quot;M &quot;</span> 
  . <span class="i">$xpos</span> . <span class="q">&quot; &quot;</span>
  . <span class="s">(</span> <span class="i">$ypos</span> -
      <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$counter</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
      <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
      <span class="i">$ysize</span> <span class="s">)</span>
  . <span class="q">&quot; &quot;</span><span class="sc">;</span>

<span class="k">for</span> <span class="s">(</span> <span class="k">my</span> <span class="i">$i</span> = <span class="i">$counter</span> - <span class="n">1</span> <span class="sc">;</span> <span class="i">$i</span> &gt; <span class="n">0</span> <span class="sc">;</span> <span class="i">$i</span>-- <span class="s">)</span> <span class="s">{</span>
    <span class="i">$path</span> =
        <span class="i">$path</span> . <span class="q">&quot; L &quot;</span>
      . <span class="s">(</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$i</span> <span class="s">)</span> * <span class="i">$step</span> <span class="s">)</span> . <span class="q">&quot; &quot;</span>
      . <span class="s">(</span> <span class="i">$ypos</span> -
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$i</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
          <span class="i">$ysize</span> <span class="s">)</span>
      . <span class="q">&quot; &quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$full</span> <span class="k">eq</span> <span class="q">&#39;true&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$svg</span><span class="i">-&gt;line</span><span class="s">(</span>
            <span class="w">x1</span> <span class="cm">=&gt;</span> <span class="s">(</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$i</span> <span class="s">)</span> * <span class="i">$step</span> <span class="s">)</span><span class="cm">,</span>
            <span class="w">x2</span> <span class="cm">=&gt;</span> <span class="s">(</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$i</span> <span class="s">)</span> * <span class="i">$step</span> <span class="s">)</span><span class="cm">,</span>
            <span class="w">y1</span> <span class="cm">=&gt;</span> <span class="i">$tysize</span> - <span class="n">1</span><span class="cm">,</span>
            <span class="w">y2</span> <span class="cm">=&gt;</span> <span class="i">$tysize</span> -
              <span class="i">$volumes</span>[ <span class="i">$counter</span> - <span class="i">$i</span> ] * <span class="s">(</span> <span class="i">$tysize</span> / <span class="n">1.3</span> <span class="s">)</span> / <span class="i">$volumes</span>[<span class="i">$maxvol</span>]<span class="cm">,</span>
            <span class="q">&#39;opacity&#39;</span>      <span class="cm">=&gt;</span> <span class="n">.3</span><span class="cm">,</span>
            <span class="q">&#39;fill&#39;</span>         <span class="cm">=&gt;</span> <span class="q">&#39;#000000&#39;</span><span class="cm">,</span>
            <span class="q">&#39;stroke-width&#39;</span> <span class="cm">=&gt;</span> <span class="i">$step</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="i">$svg</span><span class="i">-&gt;path</span><span class="s">(</span> <span class="w">d</span> <span class="cm">=&gt;</span> <span class="i">$path</span><span class="cm">,</span> <span class="q">&#39;fill&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;none&#39;</span><span class="cm">,</span> <span class="w">stroke</span> <span class="cm">=&gt;</span> <span class="q">&#39;#909090&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#--------------------------------</span>
<span class="c">#create min,max and last points</span>
<span class="c">#--------------------------------</span>

<span class="c">#min</span>
<span class="i">$svg</span><span class="i">-&gt;circle</span><span class="s">(</span>
    <span class="w">cx</span> <span class="cm">=&gt;</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$min</span> <span class="s">)</span> * <span class="i">$step</span><span class="cm">,</span>
    <span class="w">cy</span> <span class="cm">=&gt;</span> <span class="s">(</span>
        <span class="i">$ypos</span> -
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$min</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
          <span class="i">$ysize</span>
    <span class="s">)</span><span class="cm">,</span>
    <span class="q">&#39;stroke&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;none&#39;</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>   <span class="cm">=&gt;</span> <span class="q">&#39;red&#39;</span><span class="cm">,</span>
    <span class="q">&#39;r&#39;</span>      <span class="cm">=&gt;</span> <span class="n">1.5</span>
<span class="s">)</span><span class="sc">;</span>

<span class="c">#max</span>
<span class="i">$svg</span><span class="i">-&gt;circle</span><span class="s">(</span>
    <span class="w">cx</span> <span class="cm">=&gt;</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$max</span> <span class="s">)</span> * <span class="i">$step</span><span class="cm">,</span>
    <span class="w">cy</span> <span class="cm">=&gt;</span> <span class="s">(</span>
        <span class="i">$ypos</span> -
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
          <span class="i">$ysize</span>
    <span class="s">)</span><span class="cm">,</span>
    <span class="q">&#39;stroke&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;none&#39;</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>   <span class="cm">=&gt;</span> <span class="q">&#39;green&#39;</span><span class="cm">,</span>
    <span class="q">&#39;r&#39;</span>      <span class="cm">=&gt;</span> <span class="n">1.5</span>
<span class="s">)</span><span class="sc">;</span>

<span class="c">#last</span>
<span class="i">$svg</span><span class="i">-&gt;circle</span><span class="s">(</span>
    <span class="w">cx</span> <span class="cm">=&gt;</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="n">1</span> <span class="s">)</span> * <span class="i">$step</span><span class="cm">,</span>
    <span class="w">cy</span> <span class="cm">=&gt;</span> <span class="s">(</span>
        <span class="i">$ypos</span> -
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="n">0</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
          <span class="i">$ysize</span>
    <span class="s">)</span><span class="cm">,</span>
    <span class="q">&#39;stroke&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;none&#39;</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>   <span class="cm">=&gt;</span> <span class="q">&#39;blue&#39;</span><span class="cm">,</span>
    <span class="q">&#39;r&#39;</span>      <span class="cm">=&gt;</span> <span class="n">1.5</span>
<span class="s">)</span><span class="sc">;</span>

<span class="c">#--------------------------------</span>
<span class="c">#create last and symbol labels</span>
<span class="c">#--------------------------------</span>
<span class="c">#last</span>
<span class="i">$svg</span><span class="i">-&gt;text</span><span class="s">(</span>
    <span class="w">x</span> <span class="cm">=&gt;</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="n">1</span> <span class="s">)</span> * <span class="i">$step</span> + <span class="i">$smallfontsize</span> / <span class="n">2</span><span class="cm">,</span>
    <span class="w">y</span> <span class="cm">=&gt;</span> <span class="i">$tysize</span> / <span class="n">1.6</span><span class="cm">,</span>
    <span class="q">&#39;font-size&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$bigfontsize</span> . <span class="q">&#39;px&#39;</span><span class="cm">,</span>
    <span class="q">&#39;font-family&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Trebuchet MS&#39;</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>        <span class="cm">=&gt;</span> <span class="i">$color</span>
<span class="s">)</span><span class="i">-&gt;cdata</span><span class="s">(</span> <span class="i">$adj_closes</span>[<span class="n">0</span>] <span class="s">)</span><span class="sc">;</span>

<span class="c">#symbol label</span>
<span class="i">$svg</span><span class="i">-&gt;text</span><span class="s">(</span>
    <span class="w">x</span>             <span class="cm">=&gt;</span> <span class="n">3</span><span class="cm">,</span>
    <span class="w">y</span>             <span class="cm">=&gt;</span> <span class="i">$tysize</span> / <span class="n">1.6</span><span class="cm">,</span>
    <span class="q">&#39;font-size&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$bigfontsize</span> . <span class="q">&#39;px&#39;</span><span class="cm">,</span>
    <span class="q">&#39;font-family&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Trebuchet MS&#39;</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>        <span class="cm">=&gt;</span> <span class="q">&#39;#666666&#39;</span>
<span class="s">)</span><span class="i">-&gt;cdata</span><span class="s">(</span><span class="i">$symbol</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#--------------------------------</span>
<span class="c">#create min and max labels</span>
<span class="c">#--------------------------------</span>
<span class="c">#min</span>
<span class="i">$svg</span><span class="i">-&gt;text</span><span class="s">(</span>
    <span class="w">x</span> <span class="cm">=&gt;</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$min</span> <span class="s">)</span> * <span class="i">$step</span><span class="cm">,</span>
    <span class="w">y</span> <span class="cm">=&gt;</span> <span class="s">(</span>
        <span class="i">$ypos</span> -
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$min</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
          <span class="i">$ysize</span>
      <span class="s">)</span> + <span class="i">$smallfontsize</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>        <span class="cm">=&gt;</span> <span class="q">&#39;red&#39;</span><span class="cm">,</span>
    <span class="q">&#39;text-anchor&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;middle&#39;</span><span class="cm">,</span>
    <span class="q">&#39;font-size&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$smallfontsize</span> . <span class="q">&#39;px&#39;</span><span class="cm">,</span>
    <span class="q">&#39;font-family&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Lucida Grande,Verdana&#39;</span><span class="cm">,</span>
    <span class="q">&#39;opacity&#39;</span>     <span class="cm">=&gt;</span> <span class="q">&#39;0.6&#39;</span>
<span class="s">)</span><span class="i">-&gt;cdata</span><span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span><span class="sc">;</span>

<span class="c">#max</span>
<span class="i">$svg</span><span class="i">-&gt;text</span><span class="s">(</span>
    <span class="w">x</span> <span class="cm">=&gt;</span> <span class="i">$xpos</span> + <span class="s">(</span> <span class="i">$counter</span> - <span class="i">$max</span> <span class="s">)</span> * <span class="i">$step</span><span class="cm">,</span>
    <span class="w">y</span> <span class="cm">=&gt;</span> <span class="s">(</span>
        <span class="i">$ypos</span> -
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> /
          <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] - <span class="i">$adj_closes</span>[<span class="i">$min</span>] <span class="s">)</span> *
          <span class="i">$ysize</span>
      <span class="s">)</span> - <span class="i">$smallfontsize</span> / <span class="n">2</span><span class="cm">,</span>
    <span class="q">&#39;fill&#39;</span>        <span class="cm">=&gt;</span> <span class="q">&#39;green&#39;</span><span class="cm">,</span>
    <span class="q">&#39;text-anchor&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;middle&#39;</span><span class="cm">,</span>
    <span class="q">&#39;font-size&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$smallfontsize</span> . <span class="q">&#39;px&#39;</span><span class="cm">,</span>
    <span class="q">&#39;font-family&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Lucida Grande,Verdana&#39;</span><span class="cm">,</span>
    <span class="q">&#39;opacity&#39;</span>     <span class="cm">=&gt;</span> <span class="q">&#39;0.6&#39;</span>
<span class="s">)</span><span class="i">-&gt;cdata</span><span class="s">(</span> <span class="i">$adj_closes</span>[<span class="i">$max</span>] <span class="s">)</span><span class="sc">;</span>

<span class="c">#----------------------------------</span>
<span class="c">#create full chart</span>
<span class="c">#----------------------------------</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">$full</span> <span class="k">eq</span> <span class="q">&#39;true&#39;</span> <span class="s">)</span> <span class="s">{</span>

    <span class="c">#change label</span>
    <span class="i">$svg</span><span class="i">-&gt;text</span><span class="s">(</span>
        <span class="w">x</span>             <span class="cm">=&gt;</span> <span class="i">$txsize</span> - <span class="i">$smallfontsize</span> * <span class="n">4</span><span class="cm">,</span>
        <span class="w">y</span>             <span class="cm">=&gt;</span> <span class="i">$smallfontsize</span> + <span class="n">1</span><span class="cm">,</span>
        <span class="q">&#39;fill&#39;</span>        <span class="cm">=&gt;</span> <span class="i">$color</span><span class="cm">,</span>
        <span class="q">&#39;text-anchor&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;start&#39;</span><span class="cm">,</span>
        <span class="q">&#39;font-size&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$smallfontsize</span> + <span class="n">1</span> . <span class="q">&#39;px&#39;</span><span class="cm">,</span>
        <span class="q">&#39;font-family&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Lucida Grande,Verdana&#39;</span><span class="cm">,</span>
        <span class="q">&#39;opacity&#39;</span>     <span class="cm">=&gt;</span> <span class="q">&#39;0.6&#39;</span>
      <span class="s">)</span>
      <span class="i">-&gt;cdata</span><span class="s">(</span>
        <span class="k">sprintf</span><span class="s">(</span> <span class="q">&quot;%.2f&quot;</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$adj_closes</span>[<span class="n">0</span>] / <span class="i">$adj_closes</span>[<span class="n">1</span>] - <span class="n">1</span> <span class="s">)</span> * <span class="n">100</span> <span class="s">)</span>
          . <span class="q">&quot;%&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#volume</span>
    <span class="i">$svg</span><span class="i">-&gt;text</span><span class="s">(</span>
        <span class="w">x</span>             <span class="cm">=&gt;</span> <span class="i">$txsize</span> - <span class="i">$smallfontsize</span> * <span class="n">3</span><span class="cm">,</span>
        <span class="w">y</span>             <span class="cm">=&gt;</span> <span class="i">$tysize</span> - <span class="i">$smallfontsize</span> / <span class="n">2.5</span><span class="cm">,</span>
        <span class="q">&#39;fill&#39;</span>        <span class="cm">=&gt;</span> <span class="q">&#39;#666666&#39;</span><span class="cm">,</span>
        <span class="q">&#39;text-anchor&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;start&#39;</span><span class="cm">,</span>
        <span class="q">&#39;font-size&#39;</span>   <span class="cm">=&gt;</span> <span class="i">$smallfontsize</span> . <span class="q">&#39;px&#39;</span><span class="cm">,</span>
        <span class="q">&#39;font-family&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;Lucida Grande,Verdana&#39;</span><span class="cm">,</span>
        <span class="q">&#39;opacity&#39;</span>     <span class="cm">=&gt;</span> <span class="q">&#39;0.6&#39;</span>
    <span class="s">)</span><span class="i">-&gt;cdata</span><span class="s">(</span> <span class="k">sprintf</span><span class="s">(</span> <span class="q">&quot;%.1f&quot;</span><span class="cm">,</span> <span class="i">$volumes</span>[<span class="n">0</span>] / <span class="n">1000000</span> <span class="s">)</span> . <span class="q">&quot;M&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#dates</span>
<span class="c">#$svg-&gt;text(x=&gt;$xpos,</span>
<span class="c"># 			y=&gt;$smallfontsize +1,</span>
<span class="c"># 			&#39;font-size&#39;=&gt; $smallfontsize . &#39;px&#39;,</span>
<span class="c"># 			&#39;font-family&#39;=&gt;&#39;Trebuchet MS&#39;,</span>
<span class="c"># 			&#39;text-anchor&#39;=&gt;&#39;middle&#39;,</span>
<span class="c"># 			&#39;fill&#39;=&gt;&#39;#999999&#39;</span>
<span class="c"># 			)-&gt;cdata($dates[$counter]);</span>

<span class="c">#$svg-&gt;text(x=&gt;$xpos + ($counter-1) * $step,</span>
<span class="c"># 			y=&gt;$smallfontsize +1,</span>
<span class="c"># 			&#39;font-size&#39;=&gt; $smallfontsize . &#39;px&#39;,</span>
<span class="c"># 			&#39;font-family&#39;=&gt;&#39;Trebuchet MS&#39;,</span>
<span class="c"># 			&#39;fill&#39;=&gt;&#39;#999999&#39;</span>
<span class="c"># 			)-&gt;cdata($dates[0]);</span>

<span class="k">my</span> <span class="i">$out</span> = <span class="i">$svg</span><span class="i">-&gt;xmlify</span><span class="sc">;</span>
<span class="k">print</span> <span class="i">$out</span><span class="sc">;</span>

<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
</pre>
</body>
</html>
