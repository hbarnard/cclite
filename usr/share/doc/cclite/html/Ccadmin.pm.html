<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccadmin.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccadmin.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#_guess_config_values">_guess_config_values</a></li>
			<li><a href="#update_configuration">update_configuration</a></li>
			<li><a href="#update_configuration2">update_configuration2</a></li>
			<li><a href="#add_currency">add_currency</a></li>
			<li><a href="#add_category">add_category</a></li>
			<li><a href="#do_modify_currency">do_modify_currency</a></li>
			<li><a href="#do_delete_currency">do_delete_currency</a></li>
			<li><a href="#add_registry">add_registry</a></li>
			<li><a href="#show_registries">show_registries</a></li>
			<li><a href="#add_partner">add_partner</a></li>
			<li><a href="#process_batch_transactions">process_batch_transactions</a></li>
			<li><a href="#do_delete_registry">do_delete_registry</a></li>
			<li><a href="#apply_service_charge">apply_service_charge</a></li>
			<li><a href="#get_set_batch_files">get_set_batch_files</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccadmin-">package Ccadmin</a>
<ul>
<li><a href="#_guess_config_values-">_guess_config_values</a></li>
<li><a href="#update_config1-">update_config1</a></li>
<li><a href="#update_config2-">update_config2</a></li>
<li><a href="#add_currency-">add_currency</a></li>
<li><a href="#add_category-">add_category</a></li>
<li><a href="#do_modify_currency-">do_modify_currency</a></li>
<li><a href="#do_delete_currency-">do_delete_currency</a></li>
<li><a href="#add_registry-">add_registry</a></li>
<li><a href="#show_registries-">show_registries</a></li>
<li><a href="#add_partner-">add_partner</a></li>
<li><a href="#process_batch_transactions-">process_batch_transactions</a></li>
<li><a href="#do_delete_registry-">do_delete_registry</a></li>
<li><a href="#apply_service_charge-">apply_service_charge</a></li>
<li><a href="#get_set_batch_files-">get_set_batch_files</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccadmin.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Administration actions package</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>Administrative actions
Actions on currencies and registries may need to be moved to a secure package
that is not present in the public space!!  This package should possibly
be used and then removed.</p>
<p>WARNING</p>
<p>These are powerful administrative operations, this module
should often be removed from the server once sufficient
registries/currency systems are set up</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cclitedb.pm
Ccvalidate.pm
Ccu.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced
</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccadmin-"></a><span class="k">package </span><span class="i">Ccadmin</span><span class="sc">;</span>

<span class="k">our</span> <span class="i">$log</span> = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;Ccadmin&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="c">###use Digest::SHA2;    # now needs 256, recent collision work</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>

<span class="c"># should be a core module both *nix and Windows</span>
<span class="k">use</span> <span class="w">File::Path</span> <span class="q">qw(make_path remove_tree)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(add_currency</span>
  <span class="q">update_config1</span>
  <span class="q">update_config2</span>
  <span class="q">add_category</span>
  <span class="q">do_modify_currency</span>
  <span class="q">do_delete_currency</span>
  <span class="q">add_registry</span>
  <span class="q">add_partner</span>
  <span class="q">get_set_batch_files</span>
  <span class="q">show_registries</span>
  <span class="q">do_modify_registry</span>
  <span class="q">do_delete_registry</span>
  <span class="q">apply_service_charge</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash</p>
<pre>
<span class="k">our</span> <span class="i">%messages</span>    = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="_guess_config_values">_guess_config_values</a></h3>
<p>present fairly sensible configuration values
for a new installation, the current software version is 'guessed' here...</p>
<pre>
<a name="_guess_config_values-"></a><span class="k">sub </span><span class="m">_guess_config_values</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$hash_type</span><span class="cm">,</span> <span class="i">$currdir</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="c">###print &quot;root is $ENV{DOCUMENT_ROOT}&quot; ;</span>

    <span class="c">#FIXME: this is ugly, called in main script and called here...</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span> = <span class="i">get_os_and_distribution</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">multiregistry</span>}          = <span class="q">&quot;no&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">domain</span>}                 = <span class="i">$domain</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">language</span>}               = <span class="q">&quot;en&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">menustyle</span>}              = <span class="q">&quot;notused&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">defaultaction</span>}          = <span class="q">&quot;showyellowdir&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">linesperpage</span>}           = <span class="n">15</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">initialuserstatus</span>}      = <span class="q">&quot;unconfirmed&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">initialpaymentstatus</span>}   = <span class="q">&quot;waiting&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">systemmailaddress</span>}      = <span class="q">&quot;cclite\@$domain&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">systemmailpassword</span>}     = <span class="q">&quot;not-used&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">systemmailreplyaddress</span>} = <span class="q">&quot;cclite\056noreply\@$domain&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">templates</span>}              = <span class="q">&quot;${currdir}/templates/html&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">net_smtp</span>}               = <span class="n">1</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">ping_interval</span>}          = <span class="q">&quot;notused&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">secure</span>}                 = <span class="q">&quot;no&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">smtp</span>}                   = <span class="i">$domain</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">htmlpath</span>}               = <span class="i">$ENV</span>{<span class="w">DOCUMENT_ROOT</span>}<span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">literalspath</span>}           = <span class="q">&quot;${currdir}/literals&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">librarypath</span>}            = <span class="q">&quot;${currdir}lib&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">mailpath</span>}               = <span class="q">&quot;\/var\/spool\/mail&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">supportmail</span>}            = <span class="q">&quot;support\@$domain&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">dbuser</span>}                 = <span class="q">&quot;change-me-please&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">dbpassword</span>}             = <span class="q">&quot;change-me-please&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">registrypublickey</span>}      = <span class="q">&quot;notused&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">userss</span>}                 = <span class="q">&quot;no&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">version</span>}                = <span class="q">&quot;0.8.0&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">servicechargelimit</span>}     = <span class="q">&quot;notused&quot;</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">smslocal</span>}               = <span class="q">&quot;1&quot;</span><span class="sc">;</span>

    <span class="c"># Log4perl configuration file path</span>
    <span class="i">$configuration</span>{<span class="w">loggerconfig</span>} = <span class="q">&quot;$currdir/config/logging.cf&quot;</span><span class="sc">;</span>

    <span class="c">#FIXME: experimental don&#39;t use at present</span>
    <span class="i">$configuration</span>{<span class="w">usedecimals</span>} = <span class="q">&quot;no&quot;</span><span class="sc">;</span>

    <span class="c">#FIXME: eliminate double separators, check_path?</span>
    <span class="i">$configuration</span>{<span class="w">literalspath</span>} =~ <span class="q">s/\/\//\//</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">templates</span>}    =~ <span class="q">s/\/\//\//</span><span class="sc">;</span>

    <span class="i">$configuration</span>{<span class="w">hash_type</span>} = <span class="i">$hash_type</span><span class="sc">;</span>

<span class="c"># base for where to find csv batch files, if $curr contains public_html cpanel assumed</span>
<span class="c">#</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$currdir</span> !~ <span class="q">/public_html/</span> &amp;&amp; <span class="i">$os</span> <span class="k">ne</span> <span class="q">&#39;windows&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$configuration</span>{<span class="w">csvpath</span>} = <span class="q">&quot;/var/cclite/batch&quot;</span><span class="sc">;</span>
        <span class="i">$configuration</span>{<span class="w">smspath</span>} = <span class="q">&quot;/var/cclite/sms/inbox&quot;</span><span class="sc">;</span>

        <span class="c"># cpanel</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$currdir</span> =~ <span class="q">/public_html/</span> &amp;&amp; <span class="i">$os</span> <span class="k">ne</span> <span class="q">&#39;windows&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$configuration</span>{<span class="w">csvpath</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/var/cclite/batch&quot;</span><span class="sc">;</span>
        <span class="i">$configuration</span>{<span class="w">smspath</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/var/cclite/sms/inbox&quot;</span><span class="sc">;</span>

        <span class="c"># windows</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;windows&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$base_directory</span> = <span class="i">$ENV</span>{<span class="w">DOCUMENT_ROOT</span>}<span class="sc">;</span>

        <span class="c"># strip back to var, from document root, stay with c:\cclite..etc..</span>
        <span class="c"># C:/cclite-0.8.0-xp/var/www/cclite/public_html</span>
        <span class="c"># print &quot;base directory is $base_directory\n&quot; ;</span>
        <span class="i">$base_directory</span> =~ <span class="q">s/\/www\/cclite\/public_html//</span><span class="sc">;</span>
        <span class="i">$configuration</span>{<span class="w">csvpath</span>} = <span class="q">&quot;$base_directory/cclite/batch&quot;</span><span class="sc">;</span>
        <span class="i">$configuration</span>{<span class="w">smspath</span>} = <span class="q">&quot;$base_directory/cclite/sms/inbox&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="i">$configuration</span>{<span class="w">csvout</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/out/csv&quot;</span><span class="sc">;</span>

    <span class="c"># base for where to put the registry activity charts</span>
    <span class="i">$configuration</span>{<span class="w">chartdir</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/images/charts&quot;</span><span class="sc">;</span>

    <span class="c"># base for where to put printed output, generated by open office</span>
    <span class="i">$configuration</span>{<span class="w">printdir</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/out/printed&quot;</span><span class="sc">;</span>

    <span class="i">$configuration</span>{<span class="w">smsout</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/out/sms&quot;</span><span class="sc">;</span>

    <span class="c"># default is that gammu processing is with the rest of setup</span>
    <span class="i">$configuration</span>{<span class="w">smslocal</span>} = <span class="n">1</span><span class="sc">;</span>

    <span class="c"># base rss path, registry and language is added, everything now under &#39;out&#39;</span>
    <span class="i">$configuration</span>{<span class="w">rsspath</span>} = <span class="q">&quot;$ENV{DOCUMENT_ROOT}/out/rss&quot;</span><span class="sc">;</span>

    <span class="i">$home</span> =~ <span class="q">s!protected/ccinstall.cgi!cclite.cgi!</span><span class="sc">;</span>
    <span class="i">$configuration</span>{<span class="w">uhome</span>} = <span class="i">$home</span><span class="sc">;</span>
    <span class="k">return</span> \<span class="i">%configuration</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="update_configuration">update_configuration</a></h3>
<p>First part of configuration update, guess values and display
All the html has been moved into installvalues.html now, as of 11/2008
</p>
<pre>

=cut</pre>
<pre>
<a name="update_config1-"></a><span class="k">sub </span><span class="m">update_config1</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$new</span><span class="cm">,</span> <span class="i">$configuration</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$hash_type</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$title</span><span class="sc">;</span>

    <span class="c"># guess values, if new install otherwise read existing</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$new</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$configuration_ref</span> =
          <span class="i">_guess_config_values</span><span class="s">(</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$hash_type</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">%fields</span> = <span class="i">%$configuration_ref</span><span class="sc">;</span>
        <span class="i">$fields</span>{<span class="w">updatemessage</span>} .= <span class="i">$messages</span>{<span class="w">newinstall</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">%fields</span> = <span class="i">&amp;main::readconfiguration</span><span class="s">(</span><span class="i">$configuration</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$fields</span>{<span class="w">uhome</span>} = <span class="i">$fields</span>{<span class="w">home</span>}<span class="sc">;</span>

        <span class="c"># complain if config is not writable</span>
        <span class="k">unless</span> <span class="s">(</span> <span class="k">-w</span> <span class="i">$configuration</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$fields</span>{<span class="w">updatemessage</span>} .=
              <span class="q">&quot;$configuration $messages{cannotbewritten}&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> \<span class="i">%fields</span><span class="cm">,</span> <span class="q">&quot;installvalues.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#FIXME: this is ugly, called in main script and called here...</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span> = <span class="i">get_os_and_distribution</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fields</span>{<span class="w">os</span>}           = <span class="i">$os</span><span class="sc">;</span>
    <span class="i">$fields</span>{<span class="w">package_type</span>} = <span class="i">$package_type</span><span class="sc">;</span>
    <span class="i">$fields</span>{<span class="w">distribution</span>} = <span class="i">$distribution</span><span class="sc">;</span>

    <span class="c"># grey out sendmail path in installer, if windows...</span>
    <span class="i">$fields</span>{<span class="w">disablesendmail</span>} = <span class="q">&quot;disabled=\&quot;disabled\&quot;&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;windows&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># complain about hash only for new installs, otherwise too late</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$hash_type</span> <span class="k">eq</span> <span class="q">&quot;sha1&quot;</span> &amp;&amp; <span class="i">$new</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$fields</span>{<span class="w">updatemessage</span>} .= <span class="q">&quot;&lt;br/&gt;$messages{sha1warning}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

 <span class="c"># for memory: $refresh, $metarefresh, $error, $fieldsref, $pagename, $cookies )</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;/cgi-bin/protected/ccinstall.cgi&#39;</span><span class="cm">,</span>
        \<span class="i">%fields</span><span class="cm">,</span> <span class="q">&quot;installvalues.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="update_configuration2">update_configuration2</a></h3>
<p>create configuration file, if writable, otherwise display</p>
<pre>
<a name="update_config2-"></a><span class="k">sub </span><span class="m">update_config2</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$configuration</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$token</span><span class="sc">;</span>

    <span class="c"># write the new configuration to screen with a message</span>
    <span class="c"># if it can&#39;t be written directly into the configuration file</span>

    <span class="k">my</span> <span class="i">$configuration_string</span><span class="sc">;</span>    <span class="c"># this hold a cumulated set of text values</span>
                                 <span class="c"># so that people can cut and paste if necessary</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/action|saveadd/i</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#FIXME: kludge to deal with name collision between</span>
        <span class="c"># discovering the installer and what&#39;s needed as home</span>

        <span class="i">$fields</span>{<span class="i">$key</span>} =~ <span class="q">s!protected/ccinstall.cgi!cclite.cgi!</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> <span class="k">eq</span> <span class="q">&#39;home&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$configuration_string</span> .= <span class="q">&quot;$key=$fields{$key}&lt;br/&gt;\n&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># define something copiable for a cclite.cf that can&#39;t be written to...</span>
    <span class="c"># right click copy gives some guidance 10/2009</span>
    <span class="i">$configuration_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;br/&gt;</span>
<span class="hh">&lt;div id=&quot;copydiv&quot;&gt;</span>
<span class="hh">#============</span>
<span class="hh">&lt;br/&gt;</span>
<span class="hh">$configuration_string</span>
<span class="hh">#============</span>
<span class="hh">&lt;/div&gt;</span>
<span class="hh">&lt;br/&gt;</span>

<span class="h">EOT</span>

    <span class="c"># complain if config is not writable</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$configuration</span> &amp;&amp; !<span class="s">(</span> <span class="k">-w</span> <span class="i">$configuration</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># attempt to change to writable</span>
        <span class="k">system</span><span class="s">(</span><span class="q">&quot;chmod a+w $configuration&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">-w</span> <span class="i">$configuration</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

            <span class="k">my</span> <span class="i">$error</span> =
<span class="q">&quot;&lt;span class=\&quot;errors\&quot;&gt;attempted update: $configuration $messages{cannotbewritten}&lt;/span&gt;&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> \<span class="i">%fields</span><span class="cm">,</span> <span class="i">$configuration_string</span><span class="cm">,</span>
                <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">eval</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">CONFIG</span><span class="cm">,</span> <span class="q">&quot;&gt;$configuration&quot;</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c">#FIXME: kludge to deal with name collision between</span>
            <span class="c"># discovering the installer and what&#39;s needed as home</span>
            <span class="i">$fields</span>{<span class="i">$key</span>} =~ <span class="q">s!protected/ccinstall.cgi!cclite.cgi!</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> <span class="k">eq</span> <span class="q">&#39;home&#39;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="k">print</span> <span class="i">CONFIG</span> <span class="q">&quot;$key\=$fields{$key}\n&quot;</span><span class="sc">;</span>

        <span class="s">}</span>
        <span class="k">close</span><span class="s">(</span><span class="w">CONFIG</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># attempt to remove  writable</span>
        <span class="k">system</span><span class="s">(</span><span class="q">&quot;chmod a-w $configuration&quot;</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># but restore for current user: apache</span>
        <span class="k">system</span><span class="s">(</span><span class="q">&quot;chmod u+w $configuration&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span><span class="sc">;</span>
    <span class="c">###print &quot;error is $@&quot;;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">die</span> <span class="q">&quot;problem $@ $! trying to write $configuration&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;$@ &lt;br/&gt; $!&quot;</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

</pre><dl><dt><strong><a name="item_remove_for_present">remove_for_present</a></strong></dt>

<dd>
<pre>
        my $dberror = check_db_and_version($token);</pre>
<pre>
        if ( length($dberror) ) {
            if ( $dberror =~ /access denied/i ) {
                return ( 0, &quot;&quot;, &quot;&quot;, \%fields,
                    &quot;$messages{dbpasswordorser} $dberror&quot;,
                    &quot;result.html&quot;, &quot;&quot; );
            } elsif ( $dberror =~ /can\'t connect/i ) {
                return ( 0, &quot;&quot;, &quot;&quot;, \%fields,
                    &quot;$messages{mysqlnotrunning} $dberror&quot;,
                    &quot;result.html&quot;, &quot;&quot; );
            } elsif ( $dberror =~ /innodb/i ) {
                return ( 0, &quot;&quot;, &quot;&quot;, \%fields,
                    &quot;$messages{wrongdbversion} $dberror&quot;,
                    &quot;result.html&quot;, &quot;&quot; );
            } else {
                return ( 0, &quot;&quot;, &quot;&quot;, \%fields, $dberror, &quot;result.html&quot;, &quot;&quot; );
            }</pre>
<pre>
            # no db error
        } else {
=cut</pre>
<pre>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fields</span>{<span class="w">installer2</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> \<span class="i">%fields</span><span class="cm">,</span>
                <span class="q">&quot;$messages{configurationupdated} $configuration&quot;</span><span class="cm">,</span>
                <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

            <span class="k">my</span> <span class="i">$installer_url</span> =
<span class="q">&quot;http://$fields{domain}/cgi-bin/protected/ccinstall.cgi?action=template&amp;name=registry.html&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$installer_url</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> \<span class="i">%fields</span><span class="cm">,</span>
                <span class="i">$messages</span>{<span class="w">configurationupdated</span>}<span class="cm">,</span>
                <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span>
            <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
            <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
        <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

        <span class="c">#       }</span>

    <span class="s">}</span>
<span class="s">}</span>

</pre></dd></dl>
<p>
</p>
<h3><a name="add_currency">add_currency</a></h3>
<p>Create a currency. A currency belongs to a 
a specific registry within the root, this means
that each registry will have a currency record
for currencies that it handles, i.e. duplication</p>
<p>This needs some serious validation in Ccvalidate, no duplicate
currencies, no strange names etc.</p>
<pre>
<a name="add_currency-"></a><span class="k">sub </span><span class="m">add_currency</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="i">$class</span> = <span class="q">&quot;Ccadmin&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># not used here</span>
                               <span class="c"># check whether currency exists already</span>
                               <span class="c"># currencies are always lower case</span>
                               <span class="c"># currencies are always canonical lower case</span>
    <span class="i">$$fieldsref</span>{<span class="w">name</span>} =
      <span class="k">lc</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">cname</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># hack to deal with name collision</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_currencies&quot;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">name</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$currencyref</span>{<span class="w">name</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">currencyrejected</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">@validate</span> =
      <span class="i">validate_currency</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">@status</span> = <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">@validate</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$$fieldsref</span>{<span class="w">errors</span>} = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">currencyrejected</span>}<span class="cm">,</span>
            <span class="q">&quot;currency.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$$fieldsref</span>{<span class="w">code</span>} = <span class="k">uc</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">code</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># codes always uc</span>
    <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># if not a success, force the major status to cause of failure</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">currencycreated</span>}<span class="cm">,</span>
        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="add_category">add_category</a></h3>
<p>Create a yellow pages category 
This is new and flakey at present</p>
<p>Slightly improved as of 07/2007</p>
<pre>
<a name="add_category-"></a><span class="k">sub </span><span class="m">add_category</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="i">$class</span> = <span class="q">&quot;Ccadmin&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$categoryref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_categories&quot;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">name</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">###print &quot;in create category&quot; ;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$categoryref</span>{<span class="w">name</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">categorynameexists</span>}<span class="cm">,</span>
            <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#FIXME: hack to make sure that there&#39;s a category number, needs fixing</span>
    <span class="i">$$fieldsref</span>{<span class="w">category</span>} = <span class="q">&#39;1099&#39;</span><span class="sc">;</span>

    <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># if not a success, force the major status to cause of failure</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">categorycreated</span>}<span class="cm">,</span>
        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="do_modify_currency">do_modify_currency</a></h3>
<p>Modify a currency. A currency belongs to a 
a specific registry within the root, this means
that each registry will have a currency record
for currencies that it handles, i.e. duplication</p>
<p>This needs some serious validation in Ccvalidate, no duplicate
currencies, no strange names etc.</p>
<p>Now operative as of 07/2007 but form is pretty restrictive</p>
<pre>
<a name="do_modify_currency-"></a><span class="k">sub </span><span class="m">do_modify_currency</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="i">$class</span> = <span class="q">&quot;Ccadmin&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="w">language</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="do_delete_currency">do_delete_currency</a></h3>
<p>Delete a currency from a specific registry.
Means that trading concerning this currency has
stopped in this registry. This may not be a good
idea, has quite a few consequences</p>
<pre>
<a name="do_delete_currency-"></a><span class="k">sub </span><span class="m">do_delete_currency</span> <span class="s">{</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="add_registry">add_registry</a></h3>
<p>Create a registry which will contain user directories. The user directories
contain a record describing the user and a transaction directory which contains
transaction records</p>
<p>Currency must be added after registry creation, currently there's
a default creation of duckets and stars in the registry.sql</p>
<p>Augmented to create fields for remote processing. This registry
record is used to check whether the registry is local. It's
a matter of opinion whether there should be two different processes
one for local, one for remote..messier but more efficient?</p>
<p>Also need to deal with registry merge problem.</p>
<pre>
<a name="add_registry-"></a><span class="k">sub </span><span class="m">add_registry</span> <span class="s">{</span>

    <span class="c"># note, no database name, that&#39;s in $fieldsref ;</span>
    <span class="c"># odbc must be defined afterwards for Windows</span>
    <span class="c"># this builds the internal table structure etc.</span>
    <span class="c"># --new approach to this, connection to server only</span>
    <span class="c"># --followed by dbh-&gt;do 3/2005</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$configref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$structure</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@vstatus</span> =
      <span class="i">validate_registry</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span>
        <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># validate registry fields</span>
     <span class="c">#my $dbh=DBI-&gt;connect(&#39;dbi:mysql:&#39;,&#39;username&#39;,&#39;password&#39;, {RaiseError=&gt;1}) or die &quot;Couldn&#39;t connect:&quot;.DBI-&gt;errstr();</span>

    <span class="c"># first try and connect to proposed db to see whether it exists here</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> =
      <span class="i">Cclitedb::_registry_connect</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;newregistry&#39;</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># return signature: $refresh,$metarefresh,$error,$html,$pagename,$cookies</span>
    <span class="c"># access denied so wrong password</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$registryerror</span> =~ <span class="q">/access denied/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="q">&quot;$messages{usepassword} &lt;br/&gt; $registryerror&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># new way of finding &#39;real&#39; registries 8/2010: case insenstive don&#39;t want Dalston dalston DalstoN etc...</span>
    <span class="k">my</span> <span class="i">@registries</span> =
      <span class="i">show_registries</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;values&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># won&#39;t allow duplicates, will allow dalston1, dalston2 etc.</span>
    <span class="k">my</span> <span class="i">$regex</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;|&#39;</span><span class="cm">,</span> <span class="i">@registries</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$regex</span> = <span class="q">&quot;\^\($regex\)\$&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;newregistry&#39;</span>} =~ <span class="q">/$regex/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">registryexists</span>}<span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># registry connect is not generally exposed...</span>
    <span class="c"># connect to server and create db</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">Cclitedb::_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># access denied so wrong password</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$registryerror</span> =~ <span class="q">/access denied/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">usepassword</span>}<span class="sc">;</span>

        <span class="c"># highlight configuraton update</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;script&#39;</span>} = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;script&gt;</span>
<span class="hh">\$\(\&#39;#updateconfig\&#39;).css(&#39;color&#39;, &#39;red&#39;); ;</span>
<span class="hh">&lt;/script&gt;</span>
<span class="h">EOT</span>
    <span class="s">}</span>
    <span class="i">@status</span> = <span class="s">(</span> <span class="i">@vstatus</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$$fieldsref</span>{<span class="w">errors</span>} =
          <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;/div&gt;&lt;div class=\&quot;failedcheck\&quot;&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$$fieldsref</span>{<span class="w">errors</span>} =
          <span class="q">&quot;&lt;div class=\&quot;failedcheck\&quot;&gt;$$fieldsref{errors}&lt;/div&gt;&quot;</span><span class="sc">;</span>

        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;$$fieldsref{errors} &quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;registry.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># eval block for this 7/2010</span>
    <span class="k">eval</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$dbh</span><span class="i">-&gt;do</span><span class="s">(</span><span class="q">&quot;create database if not exists $$fieldsref{newregistry}&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span><span class="sc">;</span>
    <span class="k">die</span> <span class="q">&quot;ccinstall: $@&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$@</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># connect to db</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> =
      <span class="i">Cclitedb::_registry_connect</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">newregistry</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># sql creation is now versioned according to the software version</span>
    <span class="c"># and hash type which decides the hashes for the initial passwords</span>
    <span class="k">my</span> <span class="i">$sqlfile</span><span class="sc">;</span>

    <span class="c"># these just simplify the file path...</span>
    <span class="k">my</span> <span class="i">$hash_type</span> = <span class="i">$configref</span>-&gt;{<span class="q">&#39;hash_type&#39;</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$version</span>   = <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;version&#39;</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span>   <span class="i">$hash_type</span> <span class="k">eq</span> <span class="q">&#39;sha1&#39;</span>
        || <span class="i">$hash_type</span> <span class="k">eq</span> <span class="q">&#39;sha2&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$sqlfile</span> = <span class="q">&quot;../../sql/registry_${version}-${hash_type}.sql&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">die</span>
<span class="q">&quot;ccinstall: bad hash type, must be sha1 or sha2, or perhaps module is missing&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># and create structure of the new registry database</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">SQL</span><span class="cm">,</span> <span class="i">$sqlfile</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># break into individual statements</span>
        <span class="k">my</span> <span class="i">@sql</span> = <span class="q">&lt;SQL&gt;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sql</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">@sql</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">@sql</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/;/</span><span class="cm">,</span> <span class="i">$sql</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$statement</span> <span class="s">(</span><span class="i">@sql</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$statement</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># add the detailed registry description in om_registry, there now (11/2009)</span>
    <span class="c"># a record in om_registy waiting, deals with cpanel paradox, db created but</span>
    <span class="c"># &#39;empty&#39; om_registry table...hence stuckage...</span>
    <span class="c"># useid is 1 for using the id field..</span>

    <span class="i">$$fieldsref</span>{<span class="w">name</span>} = <span class="i">$$fieldsref</span>{<span class="w">newregistry</span>}<span class="sc">;</span>    <span class="c"># for the moment</span>

    <span class="c"># like the highlander, there can only be one (the first record), we hope...</span>
    <span class="c"># watch out for auto-increment when dumping db structures tooo</span>
    <span class="i">$$fieldsref</span>{<span class="w">id</span>} = <span class="n">1</span><span class="sc">;</span>

    <span class="i">update_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">newregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;en&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># previous 0.6.0 code keep for a while...</span>
    <span class="c">### add_database_record( $class, $$fieldsref{newregistry},</span>
    <span class="c">###    &#39;om_registry&#39;, $fieldsref, $token );</span>

    <span class="c"># set up directories for all batch processes</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$report_ref</span><span class="cm">,</span> <span class="i">$file_ref</span> <span class="s">)</span> =
      <span class="i">get_set_batch_files</span><span class="s">(</span> <span class="q">&#39;set&#39;</span><span class="cm">,</span> <span class="i">$configref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$display_files</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;\n&quot;</span><span class="cm">,</span> <span class="i">%$file_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    \u$$fieldsref{newregistry} $messages{registrycreated} &lt;br/&gt;</span>
<span class="hh">    &lt;a href=&quot;/cgi-bin/cclite.cgi&quot;&gt;$messages{nowlogonandcreate}&lt;/a&gt;</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&#39;result.html&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#----------------------------------------------------------------------------------</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_registries">show_registries</a></h3>
<p>Deduce databases that are probably registries and show them.
This is a heavy and somewhat clumsy operation.</p>
<p>FIXME: $table is used in a confusing way/two declarations...</p>
<pre>
<a name="show_registries-"></a><span class="k">sub </span><span class="m">show_registries</span> <span class="s">{</span>

    <span class="c"># note, no database name, that&#39;s in $fieldsref ;</span>
    <span class="c"># odbc must be defined afterwards for Windows</span>
    <span class="c"># this has a look in all the dbs to find ones with om_ named tables</span>
    <span class="c"># probably not the cleverest algorithm</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$mode</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$structure</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@registries</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return_url</span>     = <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="sc">;</span>    <span class="c"># that is ccinstall.cgi</span>
    <span class="k">my</span> <span class="i">$registry_count</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c">#FIXME: what&#39;s wrong with this message?</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;$messages{noregistriesfound}&quot;</span><span class="sc">;</span>

    <span class="c"># registry connect is not generally exposed...</span>
    <span class="c"># connect to server and create db</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$db_array</span> <span class="s">)</span> =
      <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;show databases&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">###print &quot;to here  $registry_error $db&quot;  ;</span>
    <span class="c">###exit 0 ;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$registry_error</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$table</span> = <span class="i">$registry_error</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$db_rec</span> <span class="s">(</span><span class="i">@$db_array</span><span class="s">)</span> <span class="s">{</span>

            <span class="k">my</span> <span class="i">$table_array</span> =
              <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$db_rec</span>[<span class="n">0</span>]<span class="cm">,</span> <span class="q">&quot;show tables&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>
                <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$table_rec</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="i">$table_rec</span> <span class="s">(</span><span class="i">@$table_array</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$$table_rec</span>[<span class="n">0</span>] =~ <span class="q">/om_currencies/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$registry_count</span>++<span class="sc">;</span>
                    <span class="k">push</span> <span class="i">@registries</span><span class="cm">,</span> <span class="i">$$db_rec</span>[<span class="n">0</span>]<span class="sc">;</span>
                    <span class="k">last</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$mode</span> <span class="k">eq</span> <span class="q">&#39;html&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$table</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$registry_count</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># make a table for the registries</span>

            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$registry</span> <span class="s">(</span><span class="i">@registries</span><span class="s">)</span> <span class="s">{</span>
                <span class="i">$table</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;tr&gt;&lt;td&gt;&lt;a title=&quot;logon to $registry&quot; href=&quot;/cgi-bin/cclite.cgi&quot;&gt;$registry&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

            <span class="s">}</span>

            <span class="i">$message</span> =
<span class="q">&quot;$messages{followingregistries}&lt;br/&gt;&lt;br/&gt;&lt;table border&gt;$table&lt;/table&gt;&quot;</span><span class="sc">;</span>

        <span class="s">}</span>

        <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$mode</span> <span class="k">eq</span> <span class="q">&#39;values&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">@registries</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span><span class="q">&quot;wrong mode for show_registry $mode&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c">#----------------------------------------------------------------------------------</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="add_partner">add_partner</a></h3>
<p>Add a partner to the partner table
$class added to some routines for cclite web services access</p>
<p>FIXME: no test on existence of local partner or remoter partner...</p>
<pre>
<a name="add_partner-"></a><span class="k">sub </span><span class="m">add_partner</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$class</span> = <span class="q">&quot;Cclitedb&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hash</span>       = <span class="q">&quot;&quot;</span><span class="sc">;</span>                 <span class="c"># for the moment, needs sha1 afterwards</span>
    <span class="k">my</span> <span class="i">$return_url</span> = <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="sc">;</span>
    <span class="i">@status</span> =
      <span class="i">validate_partner</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># test for duplicate registry name</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$partnerref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_partners&quot;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">dname</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$$messagesref</span>{<span class="w">partnerexists</span>} <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$partnerref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$$fieldsref</span>{<span class="w">errors</span>} = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;partners.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">getdateandtime</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">date</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c"># dname in form to avoid name collision</span>
    <span class="i">$$fieldsref</span>{<span class="w">name</span>} = <span class="i">$$fieldsref</span>{<span class="w">dname</span>}<span class="sc">;</span>

    <span class="c">#</span>
    <span class="c"># add to the  database</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">partneradded</span>}<span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="process_batch_transactions">process_batch_transactions</a></h3>
<p>Take batch transactions, mainly out of emailed csv records
and move them into a local registry, as 'waiting'. For the moment
they'll need approval afterwards</p>
<p>this will only accept transactions within a single registry and
currency at present</p>
<p>Development is stalled on this bit as of 8/8/2005, for example</p>
<pre>
<a name="process_batch_transactions-"></a><span class="k">sub </span><span class="m">process_batch_transactions</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># open file and strip off mail fields</span>
    <span class="c"># get columns from om_trades and form hash with the table</span>

    <span class="c"># update om_trades records as waiting</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="do_delete_registry">do_delete_registry</a></h3>
<p>Delete a registry
Means that trading concerning this all currencies has
and users has stopped. This may not be a good
idea, has quite a few consequences</p>
<p>To be implemented as a move to an invalid database name, perhaps</p>
<pre>
<a name="do_delete_registry-"></a><span class="k">sub </span><span class="m">do_delete_registry</span> <span class="s">{</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="apply_service_charge">apply_service_charge</a></h3>
<p>Apply the given amount, in the given currency
to all accounts except the sysaccount. This will generate an individual line
in the sysaccount at present</p>
<pre>
<a name="apply_service_charge-"></a><span class="k">sub </span><span class="m">apply_service_charge</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">%transaction</span><span class="cm">,</span> <span class="i">$html</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">@status</span> =
      <span class="i">validate_service_charge</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
        <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$$fieldsref</span>{<span class="w">errors</span>} = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;servicechg.html&quot;</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># look for sysaccount, return if not found</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>      <span class="i">$db</span><span class="cm">,</span>          <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&quot;userLevel&quot;</span><span class="cm">,</span> <span class="q">&quot;sysaccount&quot;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>     <span class="k">undef</span><span class="cm">,</span>
        <span class="k">undef</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no sysaccount found or database problem</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userId</span>} <span class="s">)</span> || <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$$fieldsref</span>{<span class="w">errors</span>} = <span class="q">&quot;$messages{nosysaccount}  or $status&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;servicechg.html&quot;</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$sysaccount</span> = <span class="i">$$userref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c"># set up transaction</span>
    <span class="c"># these are all the fixed fields for a service charge</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$db</span><span class="sc">;</span>

    <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>            <span class="c"># no home, not a web transaction</span>
                                             <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$db</span><span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$$fieldsref</span>{<span class="w">value</span>}<span class="sc">;</span>

    <span class="c">#tradeCurrency : ducket</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$fieldsref</span>{<span class="w">tradeCurrency</span>}<span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#tradeTitle : added by this routine</span>
    <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="i">$$fieldsref</span>{<span class="w">title</span>}<span class="sc">;</span>

    <span class="c">#tradeDescription</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$$fieldsref</span>{<span class="w">description</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$sysaccount</span><span class="sc">;</span>

    <span class="c">#tradeDestination :</span>
    <span class="i">$transaction</span>{<span class="w">tradeType</span>} = <span class="q">&#39;debit&#39;</span><span class="sc">;</span>

    <span class="c">#tradeDestination :</span>
    <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="q">&#39;accepted&#39;</span><span class="sc">;</span>

    <span class="c">#tradeDestination : not a true trade</span>
    <span class="i">$transaction</span>{<span class="w">tradeItem</span>} = <span class="q">&#39;other&#39;</span><span class="sc">;</span>

    <span class="c"># end of setup</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$user_hash_ref</span> <span class="s">)</span> = <span class="i">get_where_multiple</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>   <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userLevel&#39;</span><span class="cm">,</span> <span class="q">&#39;user&#39;</span><span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$colspan</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="k">scalar</span><span class="s">(</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$user_hash_ref</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span> <span class="c"># count the records returned</span>
    <span class="k">my</span> <span class="i">$maxi</span><span class="sc">;</span>

    <span class="c"># apply transaction to each user level user, not sysaccount or admin</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$user_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#tradeItem : test to see variables</span>
        <span class="c">#tradeSource : current user</span>
        <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$user_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>

        <span class="c"># call ordinary transaction</span>
        <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>

        <span class="c"># do a service charge transaction on each non-admin non-sysaccount user</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
          <span class="i">Cclite::transaction</span><span class="s">(</span> <span class="q">&#39;service&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="c">### print &quot;error is $error $output_message &lt;br/&gt;&quot; ;</span>

    <span class="s">}</span>

    <span class="i">$html</span> =
<span class="q">&quot;$$messagesref{servicechargeapplied} $$fieldsref{value} $$fieldsref{tradeCurrency} : $db&quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># now condense system account records into one record if required</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_set_batch_files">get_set_batch_files</a></h3>
<p>For the moment, just get a list of all the assumptions
about batch files. Next iteration get statuses, exists, readable etc.</p>
<p>Now with make_path should work for most OSes 12/2009

</p>

<pre>
<a name="get_set_batch_files-"></a><span class="k">sub </span><span class="m">get_set_batch_files</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$operation</span><span class="cm">,</span> <span class="i">$configref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$error</span><span class="sc">;</span>

<span class="c"># FIXME: this is not quite right, get should use cookies, set newregistry, probably</span>
    <span class="k">my</span> <span class="i">$registry</span> = <span class="i">$$cookieref</span>{<span class="w">registry</span>} || <span class="i">$$fieldsref</span>{<span class="w">newregistry</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$language</span> = <span class="i">$$cookieref</span>{<span class="w">language</span>} || <span class="i">$$configref</span>{<span class="w">language</span>} || <span class="q">&#39;en&#39;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">%$configref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">%file</span><span class="cm">,</span> <span class="i">%report</span><span class="cm">,</span> <span class="i">$html</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># make a subdirectory for graphs etc...</span>
    <span class="i">$file</span>{<span class="w">chartdir</span>} = <span class="q">&quot;$configuration{chartdir}/$registry&quot;</span><span class="sc">;</span>

    <span class="c"># make a subdirectory for rss feeds of form</span>
    <span class="i">$file</span>{<span class="w">rssdir</span>} = <span class="q">&quot;$configuration{rsspath}/$registry/$language&quot;</span><span class="sc">;</span>

    <span class="c"># make a subdirectory for printed documents, small ads, member lists</span>
    <span class="i">$file</span>{<span class="w">printdir</span>} = <span class="q">&quot;$configuration{printdir}/$registry/$language&quot;</span><span class="sc">;</span>

    <span class="c"># make a subdirectory for batch in and results out</span>
    <span class="i">$file</span>{<span class="w">csvdir</span>} = <span class="q">&quot;$configuration{csvpath}/$registry&quot;</span><span class="sc">;</span>
    <span class="i">$file</span>{<span class="w">csvout</span>} = <span class="q">&quot;$configuration{csvout}/$registry&quot;</span><span class="sc">;</span>

    <span class="c"># make a subdirectory for gammu and results out</span>
    <span class="i">$file</span>{<span class="w">smsdir</span>} = <span class="q">&quot;$configuration{smspath}/$registry&quot;</span><span class="sc">;</span>
    <span class="i">$file</span>{<span class="w">smsout</span>} = <span class="q">&quot;$configuration{smsout}/$registry&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$err_list</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$operation</span> <span class="k">eq</span> <span class="q">&#39;set&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">eval</span> <span class="s">{</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%file</span> <span class="s">)</span>
            <span class="s">{</span>

<span class="c">#FIXME: This is probably problenatic for Windows, but mkpath too...3/2010</span>
<span class="c">#FIXME: This is probably problenatic for Windows, needs latest version File::Path...8/2010</span>
<span class="c"># `mkdir -p $file{$key}`;</span>

                <span class="i">make_path</span><span class="s">(</span> <span class="i">$file</span>{<span class="i">$key</span>}<span class="cm">,</span> <span class="s">{</span> <span class="w">error</span> <span class="cm">=&gt;</span> \<span class="i">$err_list</span><span class="cm">,</span> <span class="s">}</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span> = <span class="q">&quot;$@ $!&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># report whether get or set, modified 12/2009</span>

    <span class="k">my</span> <span class="i">$first_pass</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%file</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$report</span>{<span class="i">$key</span>} = <span class="q">&quot;$messages{doesnotexist}, &quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$file</span>{<span class="i">$key</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$report</span>{<span class="i">$key</span>} .= <span class="i">$messages</span>{<span class="w">cannotbewritten</span>} <span class="k">if</span> <span class="s">(</span> !<span class="k">-w</span> <span class="i">$file</span>{<span class="i">$key</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c">###if ( length( $report{$key} ) &amp;&amp; $operation eq &#39;get&#39; ) {</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$report</span>{<span class="i">$key</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$start_literal</span> = <span class="q">&quot;$messages{batchfileproblems} $err_list &lt;br/&gt;&quot;</span>
              <span class="k">if</span> <span class="s">(</span><span class="i">$first_pass</span><span class="s">)</span><span class="sc">;</span>
            <span class="i">$first_pass</span> = <span class="n">0</span><span class="sc">;</span>

<span class="c"># mark with red and explanation when reporting, if it doesn&#39;t exist or is not writable</span>
            <span class="i">$report</span>{<span class="i">$key</span>} = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;span title=&quot;$file{$key} $report{$key}&quot; class=&quot;errors&quot;&gt;$start_literal $key&lt;/span&gt;</span>
<span class="h">EOT</span>

        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> \<span class="i">%report</span><span class="cm">,</span> \<span class="i">%file</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
