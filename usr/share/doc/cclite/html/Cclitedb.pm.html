<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Cclitedb.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Cclitedb.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#bugs">BUGS</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#add_database_record">add_database_record</a></li>
			<li><a href="#add_database_record_dbh">add_database_record_dbh</a></li>
			<li><a href="#show_record">show_record</a></li>
			<li><a href="#update_database_record">update_database_record</a></li>
			<li><a href="#delete_database_record">delete_database_record</a></li>
			<li><a href="#sqlcount">sqlcount</a></li>
			<li><a href="#sqlraw">sqlraw</a></li>
			<li><a href="#sqlraw_return_array">sqlraw_return_array</a></li>
			<li><a href="#find_database_records">find_database_records</a></li>
			<li><a href="#get_transaction_totals">get_transaction_totals</a></li>
			<li><a href="#get_suggest_sql">get_suggest_sql</a></li>
			<li><a href="#get_check_tag_sql">get_check_tag_sql</a></li>
			<li><a href="#get_user_display_data">get_user_display_data</a></li>
			<li><a href="#get_yellowpages_directory_data">get_yellowpages_directory_data</a></li>
			<li><a href="#get_yellowpages_tag_cloud_data">get_yellowpages_tag_cloud_data</a></li>
			<li><a href="#get_yellowpages_directory_print">get_yellowpages_directory_print</a></li>
			<li><a href="#get_statement_print">get_statement_print</a></li>
			<li><a href="#get_where">get_where</a></li>
			<li><a href="#get_where_multiple">get_where_multiple</a></li>
			<li><a href="#sqlfind">sqlfind</a></li>
			<li><a href="#modify_database_record">modify_database_record</a></li>
			<li><a href="#modify_database_record2">modify_database_record2</a></li>
			<li><a href="#get_table_columns">get_table_columns</a></li>
			<li><a href="#check_db_and_version">check_db_and_version</a></li>
			<li><a href="#get_table_text_columns">get_table_text_columns</a></li>
			<li><a href="#_registry_connect">_registry_connect</a></li>
			<li><a href="#registry_connect">registry_connect</a></li>
			<li><a href="#_sqlfind">_sqlfind</a></li>
			<li><a href="#_sqlgetall">_sqlgetall</a></li>
			<li><a href="#_sqlgetwhere">_sqlgetwhere</a></li>
			<li><a href="#_sqldelete">_sqldelete</a></li>
			<li><a href="#_sqlinsert">_sqlinsert</a></li>
			<li><a href="#_sqlupdate">_sqlupdate</a></li>
			<li><a href="#_sqlcount">_sqlcount</a></li>
			<li><a href="#_sql_balances_for_time_slices">_sql_balances_for_time_slices</a></li>
			<li><a href="#makebutton">makebutton</a></li>
			<li><a href="#_get_table_fields">_get_table_fields</a></li>
			<li><a href="#get_id_name">get_id_name</a></li>
			<li><a href="#_choosetemplate">_choosetemplate</a></li>
			<li><a href="#get_raw_stats_data">get_raw_stats_data</a></li>
			<li><a href="#get_raw_stats_data_for_balances">get_raw_stats_data_for_balances</a></li>
			<li><a href="#whos_online">whos_online</a></li>
			<li><a href="#log_entry">log_entry</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Cclitedb-">package Cclitedb</a>
<ul>
<li><a href="#add_database_record-">add_database_record</a></li>
<li><a href="#add_database_record_dbh-">add_database_record_dbh</a></li>
<li><a href="#show_record-">show_record</a></li>
<li><a href="#update_database_record-">update_database_record</a></li>
<li><a href="#delete_database_record-">delete_database_record</a></li>
<li><a href="#sqlcount-">sqlcount</a></li>
<li><a href="#sqlraw-">sqlraw</a></li>
<li><a href="#sqlraw_return_array-">sqlraw_return_array</a></li>
<li><a href="#find_database_records-">find_database_records</a></li>
<li><a href="#get_transaction_totals-">get_transaction_totals</a></li>
<li><a href="#get_suggest_sql-">get_suggest_sql</a></li>
<li><a href="#get_check_tag_sql-">get_check_tag_sql</a></li>
<li><a href="#get_user_display_data-">get_user_display_data</a></li>
<li><a href="#get_yellowpages_directory_data-">get_yellowpages_directory_data</a></li>
<li><a href="#get_yellowpages_tag_cloud_data-">get_yellowpages_tag_cloud_data</a></li>
<li><a href="#get_yellowpages_directory_print-">get_yellowpages_directory_print</a></li>
<li><a href="#get_statement_print-">get_statement_print</a></li>
<li><a href="#get_where-">get_where</a></li>
<li><a href="#get_where_multiple-">get_where_multiple</a></li>
<li><a href="#sqlfind-">sqlfind</a></li>
<li><a href="#modify_database_record-">modify_database_record</a></li>
<li><a href="#modify_database_record2-">modify_database_record2</a></li>
<li><a href="#get_table_columns-">get_table_columns</a></li>
<li><a href="#check_db_and_version-">check_db_and_version</a></li>
<li><a href="#get_table_text_columns-">get_table_text_columns</a></li>
<li><a href="#_registry_connect-">_registry_connect</a></li>
<li><a href="#registry_connect-">registry_connect</a></li>
<li><a href="#_sqlfind-">_sqlfind</a></li>
<li><a href="#_sqlgetall-">_sqlgetall</a></li>
<li><a href="#_sqlgetwhere-">_sqlgetwhere</a></li>
<li><a href="#_sqldelete-">_sqldelete</a></li>
<li><a href="#_sqlinsert-">_sqlinsert</a></li>
<li><a href="#_sqlupdate-">_sqlupdate</a></li>
<li><a href="#_sqlcount-">_sqlcount</a></li>
<li><a href="#_sql_give_volumes-">_sql_give_volumes</a></li>
<li><a href="#_sql_get_balance_by_currency-">_sql_get_balance_by_currency</a></li>
<li><a href="#_sql_balances_for_time_slices-">_sql_balances_for_time_slices</a></li>
<li><a href="#makebutton-">makebutton</a></li>
<li><a href="#get_table_fields-">get_table_fields</a></li>
<li><a href="#get_id_name-">get_id_name</a></li>
<li><a href="#_choosetemplate-">_choosetemplate</a></li>
<li><a href="#_format_number-">_format_number</a></li>
<li><a href="#get_raw_stats_data-">get_raw_stats_data</a></li>
<li><a href="#get_raw_stats_data_for_balances-">get_raw_stats_data_for_balances</a></li>
<li><a href="#whos_online-">whos_online</a></li>
<li><a href="#log_entry-">log_entry</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Cclitedb.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Database routines for Cclite</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains all the database routines and static SQL for cclite and some utility routines
to add a function:
 1.  add a routine to generate SQL here 
 2.  add it to the export list below
 3.  use it in on of the main programs
The token is calculated from session info, remote address and an internal registry
key. It diminishes session hijack risk
November 2004: Limit clauses added to _sqlgetwhere _sqlgetall _sqlfind
=head1 AUTHOR</p>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="bugs">BUGS</a></h1>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cclite.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005-20013 GPL Licenced 
=cut</p>
<pre>
<a name="package-Cclitedb-"></a><span class="k">package </span><span class="i">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">DBI</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>

<span class="c"># use this for tracing database calls</span>
<span class="c">#DBI-&gt;trace( 2, &#39;/var/cclite/log/debug.dbi.log&#39; );</span>

<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>    <span class="c"># for paging routine, at least</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="c">#---------------------------------------------------------</span>
<span class="c"># note the sql ones almost certainly shouldn&#39;t be exported!</span>

<span class="i">@EXPORT</span> = <span class="q">qw(check_db_and_version</span>
  <span class="q">add_database_record</span>
  <span class="q">add_database_record_dbh</span>
  <span class="q">update_database_record</span>
  <span class="q">modify_database_record</span>
  <span class="q">modify_database_record2</span>
  <span class="q">delete_database_record</span>
  <span class="q">find_database_records</span>
  <span class="q">log_entry</span>
  <span class="q">makebutton</span>
  <span class="q">makehome</span>
  <span class="q">sqlget</span>
  <span class="q">sqlgetall</span>
  <span class="q">sqlcount</span>
  <span class="q">get_average_transaction_size</span>
  <span class="q">get_check_tag_sql</span>
  <span class="q">get_id_name</span>
  <span class="q">get_suggest_sql</span>
  <span class="q">get_table_fields</span>
  <span class="q">get_raw_stats_data</span>
  <span class="q">get_raw_stats_data_for_balances</span>
  <span class="q">get_where</span>
  <span class="q">get_where_multiple</span>
  <span class="q">get_transaction_totals</span>
  <span class="q">get_yellowpages_tag_cloud_data</span>
  <span class="q">get_yellowpages_directory_data</span>
  <span class="q">get_yellowpages_directory_print</span>
  <span class="q">get_user_display_data</span>
  <span class="q">get_table_columns</span>
  <span class="q">registry_connect</span>
  <span class="q">server_hello</span>
  <span class="q">show_record</span>
  <span class="q">sqlinsert</span>
  <span class="q">sqlupdate</span>
  <span class="q">sqlgetpeople</span>
  <span class="q">sqlfind</span>
  <span class="q">sqlraw</span>
  <span class="q">sqlraw_return_array</span>
  <span class="q">sqldelete</span>
  <span class="q">whos_online</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="add_database_record">add_database_record</a></h3>
<p>Add a record to the cclite database
now very general should work out which fields to insert via 'describe'</p>
<pre>
<a name="add_database_record-"></a><span class="k">sub </span><span class="m">add_database_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$insert</span> = <span class="i">_sqlinsert</span><span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sth</span>    = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$insert</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>     = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$error</span>  = <span class="i">$sth</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="add_database_record_dbh">add_database_record_dbh</a></h3>
<p>Add a record to the cclite database
now very general should work out which fields to insert via 'describe'
Version to be used in transactions, connect is outside the routine</p>
<pre>
<a name="add_database_record_dbh-"></a><span class="k">sub </span><span class="m">add_database_record_dbh</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$insert</span> = <span class="i">_sqlinsert</span><span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span>    = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$insert</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rv</span>     = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span>  = <span class="i">$sth</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_record">show_record</a></h3>
<p>show detail for a database record
very rudimentary at present, packs up record into table
and returns as result</p>
<pre>
<a name="show_record-"></a><span class="k">sub </span><span class="m">show_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$id</span> = <span class="i">get_id_name</span><span class="s">(</span><span class="i">$table</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$returnref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="i">$id</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
        <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$returnref</span> <span class="s">)</span> <span class="s">{</span>

      <span class="c">#FIXME: disambiguate userLogin for display: duserLogin = display userLogin</span>
      <span class="c"># hence this should be used in any display templates</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> <span class="k">eq</span> <span class="q">&#39;userLogin&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;duserLogin&#39;</span>} = <span class="i">$returnref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="i">$key</span>} = <span class="i">$returnref</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &lt;tr&gt;&lt;td class=&quot;pme-key-1&quot;&gt;$key&lt;/td&gt;&lt;td class=&quot;pme-value-1&quot;&gt;$returnref-&gt;{$key}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>

    <span class="c"># default result.html is used, if no template is supplied</span>
    <span class="k">my</span> <span class="i">$template</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;resulttemplate&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$template</span> = <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;resulttemplate&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="update_database_record">update_database_record</a></h3>
<p>This is used by registry modification transaction, do not remove</p>
<p>Simplest one, but uses hash exclusively, will it work as a web service?
So far, we have:
update_database_record : raw
modify_database_record : produces form: keep and generalise
modify_database_record2 : where</p>
<p>Need to eliminate one of these!</p>
<p>FIXME: this has a pretty stupid return signature 08/2011</p>
<pre>
<a name="update_database_record-"></a><span class="k">sub </span><span class="m">update_database_record</span> <span class="s">{</span>

    <span class="c"># note useid is 1 for using the id field in where</span>
    <span class="c">#               2 for using the user logon</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$useid</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">%messages</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$message</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># deals with no language problem</span>
    <span class="c">#FIXME: In Ccsmsgateway language delivers notused why is this?</span>
    <span class="c"># duplicated language code with Ccu, name collision perhaps 08/2011</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$messagesref</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">%messages</span>    = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span>   <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_users&#39;</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;action&#39;</span>} <span class="k">eq</span> <span class="q">&#39;update&#39;</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;logontype&#39;</span>} <span class="k">ne</span> <span class="q">&#39;api&#39;</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="c"># boolean smsreceipt update</span>
        <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span>
          ? <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;userSmsreceipt&#39;</span>} = <span class="n">1</span> <span class="s">)</span>
          <span class="co">:</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;userSmsreceipt&#39;</span>} = <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$$fieldsref</span>{<span class="w">registry</span>} = <span class="i">$db</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@status</span> =
          <span class="i">Ccvalidate::validate_user</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">#FIXME: need to sort out status values throughout</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span>[<span class="n">0</span>] == <span class="n">-1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">shift</span> <span class="i">@status</span><span class="sc">;</span>
            <span class="i">$html</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># hash password: corrected 18/10/2009 for 0 zero url type</span>
        <span class="c"># recorrected 5/02/2014 url_type = 1</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">userPassword</span>} =
          <span class="i">Ccsecure::hash_password</span><span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="w">userPassword</span>} <span class="s">)</span>
          <span class="k">if</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># unlock the password if administrator and Password changed</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPasswordTries</span>}  = <span class="n">3</span><span class="sc">;</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPasswordStatus</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} = <span class="i">text_to_hash</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span>
          <span class="k">if</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} =
          <span class="i">format_for_standard_mobile</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} <span class="s">)</span>
          <span class="k">if</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># unlock the SMS PIN if administrator and PIN changed</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPinTries</span>}  = <span class="n">3</span><span class="sc">;</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPinStatus</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_users&#39;</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;action&#39;</span>} <span class="k">eq</span> <span class="q">&#39;update&#39;</span>
        &amp;&amp; <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;logontype&#39;</span>} <span class="k">eq</span> <span class="q">&#39;api&#39;</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="k">my</span> <span class="i">$allowed</span> =
          <span class="i">Cclite::check_ip_is_allowed</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span>
            <span class="i">$ENV</span>{<span class="q">&#39;REMOTE_ADDR&#39;</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$user_ref1</span> =
          <span class="i">Cclite::check_name_exists</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$user_ref2</span> =
          <span class="i">Cclite::check_email_exists</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;mode&#39;</span>}          = <span class="q">&#39;json&#39;</span><span class="sc">;</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;righthandside&#39;</span>} = <span class="q">&#39;&#39;</span><span class="sc">;</span>
        <span class="k">undef</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;action&#39;</span>}<span class="sc">;</span>

<span class="c"># don&#39;t allow direct add_user if non-allowed ip or non-existent login or duplicate email</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$allowed</span> || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$user_ref1</span><span class="s">)</span> <span class="s">)</span> || <span class="k">length</span><span class="s">(</span><span class="i">$user_ref2</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$message</span> = <span class="q">&#39;NOK&#39;</span><span class="sc">;</span>
            <span class="k">undef</span> <span class="i">$fieldsref</span><span class="sc">;</span> <span class="c">#FIXME: don&#39;t tell why, perhaps this is a misteake</span>
            <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} = <span class="q">&#39;json&#39;</span><span class="sc">;</span>

            <span class="c"># just return a generic json for the moment 03/2012</span>
            <span class="k">my</span> <span class="i">$refresh</span> =
              <span class="i">deliver_remote_data</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
                <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$message</span> = <span class="q">&#39;OK&#39;</span><span class="sc">;</span>
            <span class="i">$useid</span>   = <span class="q">&#39;2&#39;</span><span class="sc">;</span>    <span class="c">#use the logon for update</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#FIXME: better return needed if databases has gone away...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> &amp;&amp; <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$registry_error</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$update</span> = <span class="i">_sqlupdate</span><span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$useid</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$update</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#FIXME: Some tables still haven&#39;t literals</span>
    <span class="k">my</span> <span class="i">$table_literal</span> = <span class="i">$messages</span>{<span class="i">$table</span>} || <span class="i">$table</span><span class="sc">;</span>

    <span class="i">$html</span> = <span class="q">&quot;$table_literal record $$fieldsref{id} $$fieldsref{action}&quot;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} <span class="k">eq</span> <span class="q">&#39;json&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$refresh</span> =
          <span class="i">deliver_remote_data</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="q">&#39;OK&#39;</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="delete_database_record">delete_database_record</a></h3>
<p>Delete a database record. Compensates for different ids
within tables due to use of tiki schema. Ugly at present
but functioning</p>
<pre>
<a name="delete_database_record-"></a><span class="k">sub </span><span class="m">delete_database_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span><span class="sc">;</span>

    <span class="c">#FIXME: compensate for different id names in tables, ugly</span>
    <span class="k">my</span> <span class="i">%translate</span> = <span class="q">qw(om_trades tradeId om_users userId om_openid openId)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$translate</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$id</span> = <span class="i">$translate</span>{<span class="i">$table</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$id</span> = <span class="q">&quot;id&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$delete</span> = <span class="i">_sqldelete</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="i">$id</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$delete</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># this is not multilingual to be fixed</span>
    <span class="i">$html</span> = <span class="q">&quot;$table record $$fieldsref{$id} deleted&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlcount">sqlcount</a></h3>
<p>Count a set of records in the database, either to output
as a guide figure or to make pagination information</p>
<p>Can be done via sqlstring or where</p>
<p>This needs to return an error too</p>
<pre>
<a name="sqlcount-"></a><span class="k">sub </span><span class="m">sqlcount</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$value</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># count all the transactions belonging to the current user</span>
    <span class="k">my</span> <span class="i">$sqlcount</span> = <span class="i">_sqlcount</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$value</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$sqlcount</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@row</span>   = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="i">$row</span>[<span class="n">0</span>]<span class="sc">;</span>
    <span class="k">return</span> <span class="i">$count</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlraw">sqlraw</a></h3>
<p>Sql raw a given piece of sql. 
Does not allow update or delete used for complex joins etc.
change to hash_ref, self-describing but problematic in soap calls</p>
<pre>
<a name="sqlraw-"></a><span class="k">sub </span><span class="m">sqlraw</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># remove all modification attempts!</span>
    <span class="i">$sqlstring</span> =~ <span class="q">s/delete|insert|update//gi</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$sqlstring</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$rv</span>       = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="i">$id</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#print &quot;$sqlstring $rv $id $dbh&quot; ;</span>
    <span class="c">#print Dumper $hash_ref ;</span>
    <span class="c"># --- example of use---------------------------------</span>
    <span class="c"># $hash_ref = $sth-&gt;fetchall_hashref(&#39;id&#39;);</span>
    <span class="c"># print &quot;Name for id 42 is $hash_ref-&gt;{42}-&gt;{name}\n&quot;;</span>
    <span class="c">#----------------------------------------------------</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlraw_return_array">sqlraw_return_array</a></h3>
<p>returns an array, probably useful for web services
otherwise identical to sqlraw, probably should be
renamed to sql_raw_return_hash...</p>
<pre>
<a name="sqlraw_return_array-"></a><span class="k">sub </span><span class="m">sqlraw_return_array</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># remove all modification attempts!</span>
    <span class="i">$sqlstring</span> =~ <span class="q">s/delete|insert|update//gi</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># cumulate any detail error with registry error 10/2009</span>
    <span class="i">$registryerror</span> .= <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$sqlstring</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$array_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_arrayref</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="find_database_records">find_database_records</a></h3>
<p>Find strings within a table
Makes a large OR using LIKE.
Very inefficient but works at present</p>
<p>This will now deliver all transactions into a find
that is done by the manager...be careful</p>
<pre>
<a name="find_database_records-"></a><span class="k">sub </span><span class="m">find_database_records</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span>
        <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">get_table_text_columns</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$column_array_ref</span> = \<span class="i">@columns</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$row_ref</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="i">$string</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># make a massive where statement for all textual columns</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$column</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$column</span> = <span class="q">&quot;$column LIKE \&#39;%$fieldsref-&gt;{&#39;string&#39;}%\&#39;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$like</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot; or &quot;</span><span class="cm">,</span> <span class="i">@columns</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># constrain finds on om_trades to just the owner&#39;s records</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> &amp;&amp; !<span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

      <span class="c"># first select base set, only records for user, if not admin</span>
      <span class="c"># debits and opening balances are user sourced, credits are remote sourced</span>

        <span class="i">$like</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">and ((tradeSource = &#39;$$cookieref{userLogin}&#39; and (tradeType = &#39;debit&#39; or tradeType = &#39;open&#39;))</span>
<span class="hh"> or</span>
<span class="hh"> (tradeDestination = &#39;$$cookieref{userLogin}&#39; and  tradeType = &#39;credit&#39;)</span>
<span class="hh">)</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># count all the transactions belonging to the current user</span>
    <span class="c"># if om_trades otherwise count all records</span>
    <span class="c">#</span>
    <span class="i">$count</span> =
      <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="q">&quot;tradeSource&quot;</span><span class="cm">,</span>
        <span class="i">$$cookieref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$count</span> = <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#FIXME: this should be redundant: get the columns too</span>
    <span class="c">### my ( $registryerror, $column_array_ref ) =</span>
    <span class="c">####  sqlraw_return_array( $class, $db, &quot;describe $table&quot;, &quot;&quot;, $token );</span>

    <span class="k">my</span> <span class="i">$find</span> =
      <span class="i">_sqlfind</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># unhappily the id field used in each table is inconsistent</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">get_id_name</span><span class="s">(</span><span class="i">$table</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$find</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="i">$id</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$column_array_ref</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_transaction_totals">get_transaction_totals</a></h3>
<p>Get credit and debit transation totals for a given user, doesn't deal with admin yet..
Replaces pile of junk code in Cclite::show_balance_and_volume 4/2010</p>
<pre>
<a name="get_transaction_totals-"></a><span class="k">sub </span><span class="m">get_transaction_totals</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$months_back</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$volume_sql</span> = <span class="i">_sql_give_volumes</span><span class="s">(</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$months_back</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># balance now allows cut-off date, can be used for zero crossing calc...</span>
    <span class="k">my</span> <span class="i">$balance_sql</span> = <span class="i">_sql_get_balance_by_currency</span><span class="s">(</span> <span class="i">$user</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sth</span><span class="sc">;</span>
    <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$volume_sql</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$volume_hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="q">&#39;sort&#39;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$balance_sql</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$balance_hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="q">&#39;tradeId&#39;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$volume_hash_ref</span><span class="cm">,</span> <span class="i">$balance_hash_ref</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_suggest_sql">get_suggest_sql</a></h3>
<p>Get the sql statement for the appropriate autosuggest type
All this depends on cclite.js which fires various bits of jquery</p>
<pre>
<a name="get_suggest_sql-"></a><span class="k">sub </span><span class="m">get_suggest_sql</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$level</span><span class="cm">,</span> <span class="i">$userLogin</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$query_string</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sql</span><span class="sc">;</span>

    <span class="c"># deals with suggesting destination for trade or user search</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;user&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT userLogin FROM `om_users` </span>
<span class="hh"> WHERE (userLogin LIKE \&#39;\%$query_string\%\&#39;</span>
<span class="hh">        AND userLevel &lt;&gt; \&#39;sysaccount\&#39; </span>
<span class="hh">        AND userLogin &lt;&gt; \&#39;$userLogin\&#39; )</span>
<span class="hh"> LIMIT 0 , 10; </span>
                
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># suggest yellowpages responding to search</span>

    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;ad&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT subject FROM `om_yellowpages` </span>
<span class="hh">                        WHERE ( type LIKE \&#39;\%$query_string\%\&#39; </span>
<span class="hh">                        OR category LIKE \&#39;\%$query_string\%\&#39; </span>
<span class="hh">                        OR keywords LIKE \&#39;\%$query_string\%\&#39;</span>
<span class="hh">                        OR subject LIKE \&#39;\%$query_string\%\&#39; )</span>
<span class="hh">LIMIT 0 , 10 ;</span>

<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># suggests replies to trade search</span>

    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;trade&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># admin can search for any trade</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$level</span> <span class="k">eq</span> <span class="q">&#39;admin&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT tradeTitle,tradeStatus FROM `om_trades` </span>
<span class="hh">         WHERE (tradeTitle LIKE \&#39;\%$query_string\%\&#39; </span>
<span class="hh">                OR tradeHash LIKE \&#39;\%$query_string\%\&#39; </span>
<span class="hh">                OR tradeStatus LIKE \&#39;\%$query_string\%\&#39;) </span>
<span class="hh">LIMIT 0 , 10 ;</span>
 

<span class="h">EOT</span>

            <span class="c"># non admin can search within trades that concern them</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT tradeTitle,tradeStatus FROM `om_trades` </span>
<span class="hh">         WHERE ((tradeTitle LIKE \&#39;\%$query_string\%\&#39; </span>
<span class="hh">                OR tradeHash LIKE \&#39;\%$query_string\%\&#39; </span>
<span class="hh">                OR tradeStatus LIKE \&#39;\%$query_string\%\&#39;) </span>
<span class="hh">                AND (tradeSource = \&#39;$userLogin\&#39; OR tradeDestination = \&#39;$userLogin\&#39;))</span>
<span class="hh">LIMIT 0 , 10 ;</span>
 

<span class="h">EOT</span>

        <span class="s">}</span>

        <span class="c"># special case, will produce a reply when new user name is unique</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;newuser&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sql</span> =
<span class="q">&quot;SELECT userLogin FROM `om_users` WHERE userLogin LIKE \&#39;\%$query_string\%\&#39; LIMIT 0 , 10&quot;</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;newuseremail&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sql</span> =
<span class="q">&quot;SELECT userLogin FROM `om_users` WHERE userEmail LIKE \&#39;\%$query_string\%\&#39; LIMIT 0 , 10&quot;</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;newusermobile&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sql</span> =
<span class="q">&quot;SELECT userLogin FROM `om_users` WHERE userMobile LIKE \&#39;\%$query_string\%\&#39; LIMIT 0 , 10&quot;</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;tag&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sql</span> =
<span class="q">&quot;SELECT description FROM `om_categories` WHERE (description LIKE \&#39;\%$query_string\%\&#39; and category = &#39;9999&#39;) LIMIT 0 , 10&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$sql</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_check_tag_sql">get_check_tag_sql</a></h3>
<p>Check if free form category tag exists, to avoid
duplicating them. They always have 9999 category codes</p>
<pre>
<a name="get_check_tag_sql-"></a><span class="k">sub </span><span class="m">get_check_tag_sql</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$tag</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sql</span> =
<span class="q">&quot;SELECT description FROM `om_categories` WHERE (description = $tag and category = &#39;9999&#39;&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$sql</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_user_display_data">get_user_display_data</a></h3>
<p>Sql and retrieval for user display page. Moved into here 5/2010
to give better sql/code separation</p>
<p>As of May 2010, hashes are now returned and processed, making everything
less fragile with respect to database changes...</p>
<pre>
<a name="get_user_display_data-"></a><span class="k">sub </span><span class="m">get_user_display_data</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sqlstring</span><span class="sc">;</span>

    <span class="c">#FIXME: need to remove the simpler version</span>

    <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  SELECT DISTINCT u.userLogin,u.userName, userStatus,</span>
<span class="hh">                  u.userPostcode, u.userEmail,u.userMobile,</span>
<span class="hh">                  u.userTelephone, y.id, y.subject, y.description, </span>
<span class="hh">                  y.fromuserid, y.price, y.unit, y.tradeCurrency</span>
<span class="hh">  FROM om_yellowpages y, om_users u</span>
<span class="hh">  WHERE (</span>
<span class="hh">  y.fromuserid = u.userLogin AND u.userLogin = &#39;$user&#39;)</span>
<span class="h">EOT</span>

    <span class="c"># get equi-joined table</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_yellowpages_directory_data">get_yellowpages_directory_data</a></h3>
<p>This moves all the sql and retrieval for the Craigslist style directory
into its correct place, since it contains sql May 2010</p>
<p>As of May 2010, hashes are now returned and processed, making everything
less fragile with respect to database changes...</p>
<pre>
<a name="get_yellowpages_directory_data-"></a><span class="k">sub </span><span class="m">get_yellowpages_directory_data</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$interval</span><span class="cm">,</span> <span class="i">$detail</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$interval</span> ||= <span class="n">1</span><span class="sc">;</span>    <span class="c"># if there are items a week or less in a category</span>
                        <span class="c"># they&#39;ll show up as new</span>

    <span class="k">my</span> <span class="i">$sqldetail</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT c.description, count( * ) AS &#39;majorcount&#39;, y.type, y.category</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent</span>
<span class="hh">)</span>
<span class="hh">GROUP BY y.parent,y.category,y.type</span>
<span class="hh">ORDER BY c.description ASC</span>
<span class="h">EOT</span>

    <span class="c"># same data set as detail but count &#39;new&#39; ads</span>

    <span class="k">my</span> <span class="i">$sqltestifnew</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT  c.description, count( * ) AS &#39;majorcount&#39;, y.type, y.category</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE datediff(curdate(),y.date) &lt; 2</span>
<span class="hh">and</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent</span>
<span class="hh">GROUP BY y.parent</span>

<span class="h">EOT</span>

    <span class="k">my</span> <span class="i">$sqlmajor</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT  c.description, count( *) AS &#39;majorcount&#39;, y.type, y.category</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent</span>
<span class="hh">)</span>
<span class="hh">GROUP BY y.parent</span>
<span class="hh">ORDER BY y.parent ASC</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="i">$sqlmajor</span><span class="sc">;</span>

    <span class="c"># detail is supplied by $fieldsref-&gt;{&#39;getdetail&#39;}</span>
    <span class="i">$sqlstring</span> = <span class="i">$sqldetail</span> <span class="k">if</span> <span class="s">(</span><span class="i">$detail</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># look up categories which have new ads</span>
    <span class="k">my</span> <span class="i">%newads</span><span class="sc">;</span>

    <span class="c"># get a list of categories which have received ads recently</span>
    <span class="c"># put in a hash</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$new_items_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqltestifnew</span><span class="cm">,</span> <span class="q">&#39;description&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$yellowdirectory_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;description&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$new_items_hash_ref</span><span class="cm">,</span> <span class="i">$yellowdirectory_hash_ref</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_yellowpages_tag_cloud_data">get_yellowpages_tag_cloud_data</a></h3>
<p>July 2011, same signature as all the other parts of yellowpages
but for tag cloud retrieval. Main idea of this is for the listing
classification to become more flexible and multilingual</p>
<p>9999 category are free form keywords to keep them away from the static
classification scheme.</p>
<p>FIXME: keywords are a string of keywords, they are not properly normalised,
but I don't want millions of little tables</p>
<pre>
<a name="get_yellowpages_tag_cloud_data-"></a><span class="k">sub </span><span class="m">get_yellowpages_tag_cloud_data</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$interval</span><span class="cm">,</span> <span class="i">$detail</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT  y.id, y.keywords, y.type</span>
<span class="hh">FROM om_yellowpages y where category = &#39;9999&#39; order by `date` desc LIMIT 0,1000</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="i">$sqltestifnew</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT  y.id, y.keywords, y.type, y.category</span>
<span class="hh">FROM om_yellowpages y</span>
<span class="hh">WHERE where (category = &#39;9999&#39; and datediff(curdate(),y.date) &lt; 2) order by `date` desc LIMIT 0,1000</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$yellowdirectory_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sql</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$yellowdirectory_hash_ref</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_yellowpages_directory_print">get_yellowpages_directory_print</a></h3>
<p>This is the version for print format, a work in progress
as of December 2010</p>
<pre>
<a name="get_yellowpages_directory_print-"></a><span class="k">sub </span><span class="m">get_yellowpages_directory_print</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT concat(y.parent,y.category,y.type,y.id) as sortal,</span>
<span class="hh">y.category, y.type,y.parent,</span>
<span class="hh">u.userId,u.userEmail,u.userMobile,u.userTelephone, y.subject, </span>
<span class="hh">y.price, y.unit, y.tradeCurrency, y.description</span>
<span class="hh">FROM om_yellowpages y, om_users u</span>
<span class="hh">WHERE</span>
<span class="hh">y.fromuserid = u.userLogin</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$yellowdirectory_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;sortal&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT concat(y.parent,y.category,y.type,y.id) as sortal,c.description</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE</span>
<span class="hh">y.parent = c.parent AND y.category = c.category</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$category_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;sortal&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$yellowdirectory_hash_ref</span><span class="cm">,</span> <span class="i">$category_hash_ref</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_statement_print">get_statement_print</a></h3>
<p>This is the version for print format, a work in progress
as of December 2010</p>
<pre>
<a name="get_statement_print-"></a><span class="k">sub </span><span class="m">get_statement_print</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT </span>
<span class="hh">FROM om_trades y, om_users u</span>
<span class="hh">WHERE</span>
<span class="hh">y.trade = u.userLogin</span>

<span class="h">EOT</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$trade_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;sortal&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span><span class="i">$trade_hash_ref</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="get_where">get_where</a></h3>
<p>FIXME: This is throwing errors into the apache log
get a record via a single = field condition
should return one record only</p>
<pre>
<a name="get_where-"></a><span class="k">sub </span><span class="m">get_where</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$name</span><span class="cm">,</span>  <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$db</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>

        <span class="i">log_entry</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>
            <span class="i">$db</span><span class="cm">,</span>
            <span class="q">&#39;fatal&#39;</span><span class="cm">,</span>
<span class="q">&quot;$class, $db, $table, $fieldname, $name, $token, $offset, $limit g:$get  p:$package, f:$filename, l:$line&quot;</span><span class="cm">,</span>
            <span class="i">$token</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">return</span> <span class="s">(</span> <span class="q">&#39;blank database&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> &amp;&amp; <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$registryerror</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_hashref</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_where_multiple">get_where_multiple</a></h3>
<p>get multiple records via a field condition returns a hash as of 5/2010
this should completely replace get_where after a while
needs limit clause</p>
<pre>
<a name="get_where_multiple-"></a><span class="k">sub </span><span class="m">get_where_multiple</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$name</span><span class="cm">,</span>  <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="c">###local, dalston, om_currencies,*, *,  , *, ,</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># unhappily the id field used in each table is inconsistent</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">get_id_name</span><span class="s">(</span><span class="i">$table</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="i">$id</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlfind">sqlfind</a></h3>
<p>sql find for a given piece of sql. This is sometimes the motor
for a given application. To some extent, this is a 'tramp' function
as defined in coding complete, but it hides _sqlfind too...</p>
<p>'order' param after $sqlstring isn't filled at present</p>
<pre>
<a name="sqlfind-"></a><span class="k">sub </span><span class="m">sqlfind</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span>
        <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>    <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlfind</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># find id field of the table, not all called id, unhappily</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">get_id_name</span><span class="s">(</span><span class="i">$table</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="i">$id</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="modify_database_record">modify_database_record</a></h3>
<pre>
 Prepares to modify:
  - fetches a record by id
  - transfers fields to fieldsref
  - set up appropriate next action
  - display form if named, default if not
  - hardwired template logic probably needs to be moved</pre>
<pre>
<a name="modify_database_record-"></a><span class="k">sub </span><span class="m">modify_database_record</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$field</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># work out default template, results.html is not used nowadays</span>
    <span class="k">my</span> <span class="i">$default_template</span> = <span class="i">$table</span><span class="sc">;</span>
    <span class="i">$default_template</span> =~ <span class="q">s/om_//</span><span class="sc">;</span>
    <span class="i">$default_template</span> .= <span class="q">&quot;\056html&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$template</span> = <span class="i">$$fieldsref</span>{<span class="w">template</span>} || <span class="i">$default_template</span><span class="sc">;</span>

    <span class="c"># compensate for different id names, needs to be stripped</span>
    <span class="k">my</span> <span class="i">$idname</span> = <span class="i">get_id_name</span><span class="s">(</span><span class="i">$table</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$get</span><span class="sc">;</span>

<span class="c"># FIXME: subtle bug in registry detail retrieve and cpanel create (with empty table), therefore</span>
<span class="c"># get from table by name is safest currently 11/2009</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_users&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$get</span> = <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;userId&#39;</span>}<span class="cm">,</span>
            <span class="i">$table</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="i">$idname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$get</span> = <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="i">$idname</span>}<span class="cm">,</span>
            <span class="i">$table</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="i">$idname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_hashref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span>    = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$hash_ref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="modify_database_record2">modify_database_record2</a></h3>
<p>Did this never work? Just modified 2/5/2005 to produce
a where condition update.</p>
<p>Needs investigation and possible removal,
FIXME: This is called only once by modify_user im Cclite.pm at about 969</p>
<pre>
<a name="modify_database_record2-"></a><span class="k">sub </span><span class="m">modify_database_record2</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>    <span class="i">$name</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$offset</span><span class="sc">;</span>    <span class="c"># not used here</span>
    <span class="k">my</span> <span class="i">$limit</span><span class="sc">;</span>     <span class="c"># not used here</span>
                   <span class="c"># this needs to be replaced by fetchrow_hashref...</span>
    <span class="k">my</span> <span class="i">$counter</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># count the rows as they go by!</span>

    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_hashref</span><span class="sc">;</span>    <span class="c"># note fieldsref now comes from db</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_table_columns">get_table_columns</a></h3>
<p>Gets all the columns within a table via a
table describe. Used to prepare other operations</p>
<pre>
<a name="get_table_columns-"></a><span class="k">sub </span><span class="m">get_table_columns</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$sth</span><span class="cm">,</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">@row</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$show</span> = <span class="q">&quot;describe $table;&quot;</span><span class="sc">;</span>
        <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$show</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span> = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">$row</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="check_db_and_version">check_db_and_version</a></h3>
<p>checks for database password and no innodb problems
during install/configuration update</p>
<p>alpha quality code, new in December 2005</p>
<pre>
<a name="check_db_and_version-"></a><span class="k">sub </span><span class="m">check_db_and_version</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$token</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#---------------------------------------------------------</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">&amp;Cclitedb::_registry_connect</span><span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># return signature: $refresh,$metarefresh,$error,$html,$pagename,$cookies</span>
    <span class="c"># no connection to database, return reason</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$registryerror</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$registryerror</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># mysql version less than 4, no inno_db, return version</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="q">&quot;show variables;&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$m</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@row</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">last</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span>[<span class="n">0</span>] =~ <span class="q">/^have_innodb/i</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span>[<span class="n">1</span>] !~ <span class="q">/^YES/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;innodb  $row[1]&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># nothing comes back, ok</span>
    <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_table_text_columns">get_table_text_columns</a></h3>
<p>gets text type columns via describe
probably refactor this as a mode of get_table_columns?</p>
<pre>
<a name="get_table_text_columns-"></a><span class="k">sub </span><span class="m">get_table_text_columns</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$sth</span><span class="cm">,</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">@row</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$show</span> = <span class="q">&quot;describe $table;&quot;</span><span class="sc">;</span>
    <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$show</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rv</span> = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">$row</span>[<span class="n">0</span>] <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span>[<span class="n">1</span>] =~ <span class="q">/varchar|text|enum/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_registry_connect">_registry_connect</a></h3>
<p>connect to database (therefore a registry) or database server 
(with blank $db, to create registries)</p>
<p>Note that all _ prefixed are inner routines, shouldn't be exposed</p>
<pre>
<a name="_registry_connect-"></a><span class="k">sub </span><span class="m">_registry_connect</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbuser</span>     = <span class="i">$configuration</span>{<span class="w">dbuser</span>}<span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbpassword</span> = <span class="i">$configuration</span>{<span class="w">dbpassword</span>}<span class="sc">;</span>

    <span class="c">#FIXME: hack for database prefix in cpanel, registry creation connect</span>
    <span class="c"># has blank database so no prefix should be added...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="q">&#39;cpanelprefix&#39;</span>} <span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span><span class="i">$db</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$db</span> = <span class="i">$configuration</span>{<span class="q">&#39;cpanelprefix&#39;</span>} . <span class="q">&#39;_&#39;</span> . <span class="i">$db</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#open connection to MySql database</span>
    <span class="k">my</span> <span class="i">$dbh</span> = <span class="w">DBI</span><span class="w">-&gt;connect</span><span class="s">(</span> <span class="q">&quot;dbi:mysql:$db&quot;</span><span class="cm">,</span> <span class="i">$dbuser</span><span class="cm">,</span> <span class="i">$dbpassword</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$DBI::errstr</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="registry_connect">registry_connect</a></h3>
<p>FIXME: Exposed version of connect to database (therefore a registry) or database server 
(with blank $db, to create registries)</p>
<p>This is for the future with persistent database handles in mono-registry</p>
<pre>
<a name="registry_connect-"></a><span class="k">sub </span><span class="m">registry_connect</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbuser</span>     = <span class="i">$configuration</span>{<span class="w">dbuser</span>}<span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbpassword</span> = <span class="i">$configuration</span>{<span class="w">dbpassword</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#FIXME: hack for database prefix in cpanel</span>
    <span class="i">$db</span> = <span class="i">$configuration</span>{<span class="q">&#39;cpanelprefix&#39;</span>} . <span class="q">&#39;_&#39;</span> . <span class="i">$db</span>
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="q">&#39;cpanelprefix&#39;</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#open connection to MySql database</span>
    <span class="k">my</span> <span class="i">$dbh</span> = <span class="w">DBI</span><span class="w">-&gt;connect</span><span class="s">(</span> <span class="q">&quot;dbi:mysql:$db&quot;</span><span class="cm">,</span> <span class="i">$dbuser</span><span class="cm">,</span> <span class="i">$dbpassword</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$DBI::errstr</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlfind">_sqlfind</a></h3>
<p>find record via string, orders output set
if order parameter is present</p>
<pre>
<a name="_sqlfind-"></a><span class="k">sub </span><span class="m">_sqlfind</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldslist</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlfind</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit_clause</span><span class="sc">;</span>

    <span class="c"># get the tabular display fields for a givem table...</span>
    <span class="k">my</span> <span class="i">$table_fields</span> = <span class="i">get_table_fields</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldslist</span> <span class="s">)</span><span class="sc">;</span>

   <span class="c"># mild security don&#39;t deliver complete tables  unless admin 10.3.2007/06/2007</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$sqlstring</span> == <span class="n">1</span> || <span class="i">$sqlstring</span> <span class="k">eq</span> <span class="q">&quot;1=1&quot;</span> <span class="s">)</span> &amp;&amp; !<span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$offset</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$offset</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$limit_clause</span> = <span class="q">&quot;LIMIT $offset,$limit&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$order</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sqlfind</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   SELECT $table_fields from $table WHERE ($sqlstring) ORDER BY $order $limit_clause</span>
<span class="h">EOT</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$sqlfind</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   SELECT $table_fields from $table WHERE ($sqlstring) $limit_clause</span>
<span class="h">EOT</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$sqlfind</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlgetall">_sqlgetall</a></h3>
<p>select all the records in a table
uses limit and offset, if present</p>
<pre>
<a name="_sqlgetall-"></a><span class="k">sub </span><span class="m">_sqlgetall</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit_clause</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$offset</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$offset</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$limit_clause</span> = <span class="q">&quot;LIMIT $offset,$limit&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$sqlget</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   SELECT * </span>
<span class="hh">   from $table $limit_clause</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sqlget</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlgetwhere">_sqlgetwhere</a></h3>
<p>Used for getting the registry via name, 
can be used for usernames, also
As of 06/2007 now needs tidying up</p>
<pre>
<a name="_sqlgetwhere-"></a><span class="k">sub </span><span class="m">_sqlgetwhere</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldlist</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlgetwhere</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit_clause</span><span class="sc">;</span>

    <span class="c"># get the tabular display fields for a givem table...</span>
    <span class="k">my</span> <span class="i">$table_fields</span> = <span class="i">get_table_fields</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldlist</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$offset</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$offset</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$limit_clause</span> = <span class="q">&quot;LIMIT $offset,$limit&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$name</span> <span class="k">ne</span> <span class="q">&quot;*&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT $table_fields FROM $table WHERE $fieldname = \&#39;$name\&#39; ORDER BY $fieldname $limit_clause </span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT $table_fields FROM $table WHERE $fieldname = \&#39;$name\&#39; ORDER BY tradeDate DESC $limit_clause </span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c">#FIXME: These are pretty dangerous...</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT $table_fields FROM $table WHERE 1 ORDER BY $fieldname $limit_clause</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT $table_fields FROM $table WHERE 1 ORDER BY tradeDate DESC $limit_clause </span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span>
    <span class="c">###print &quot;where is $sqlgetwhere\n&quot; ;</span>
    <span class="k">return</span> <span class="i">$sqlgetwhere</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqldelete">_sqldelete</a></h3>
<p>delete record via id only</p>
<pre>
<a name="_sqldelete-"></a><span class="k">sub </span><span class="m">_sqldelete</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqldelete</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   DELETE FROM $table WHERE ($fieldname = &#39;$id&#39;)</span>
<span class="h">EOT</span>
    <span class="k">return</span> <span class="i">$sqldelete</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlinsert">_sqlinsert</a></h3>
<p>Insert a record now made general, will insert into any table, 
column definitions are provided via 'describe table_name' done before this
note please stick to 'id' for an id/primary key, makes life simpler
this is inherited from Mose etc... userId, tradeId hence the complex
regex test below.</p>
<p>FIXME: This only deals with autoincrement...not the case for om_openid, foreign key...
       Therefore test for om_openid but this is ugly..</p>
<pre>
<a name="_sqlinsert-"></a><span class="k">sub </span><span class="m">_sqlinsert</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$value_string</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">get_table_columns</span><span class="s">(</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsstring</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@columns</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$column_name</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">next</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$column_name</span> =~ <span class="q">/^id|^Id|^userId|^tradeId/</span>
            &amp;&amp; <span class="i">$tablename</span> <span class="k">ne</span> <span class="q">&#39;om_openid&#39;</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># don&#39;t put id into this</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="q">&quot;&#39;$fields{$column_name}&#39;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># string out the field values for the insert</span>
    <span class="i">$value_string</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@values</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlinsert</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   INSERT INTO $tablename (</span>
<span class="hh">     $fieldsstring</span>
<span class="hh">   ) VALUES (</span>
<span class="hh">    NULL,</span>
<span class="hh">    $value_string </span>
<span class="hh">   )</span>
<span class="h">EOT</span>
    <span class="i">$sqlinsert</span> =~ <span class="q">s/NULL,//</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$tablename</span> <span class="k">eq</span> <span class="q">&#39;om_openid&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$sqlinsert</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlupdate">_sqlupdate</a></h3>
<p>Update a record
only the fields supplied run into the update, unlike insert
in which ALL the columns are initialised.</p>
<pre>
<a name="_sqlupdate-"></a><span class="k">sub </span><span class="m">_sqlupdate</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$useid</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$value_string</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id_field</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">get_table_columns</span><span class="s">(</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsstring</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@columns</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$column_name</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="s">(</span> <span class="i">$id_field</span> = <span class="i">$column_name</span> <span class="s">)</span> &amp;&amp; <span class="k">next</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$column_name</span> =~ <span class="q">/^id|^userId|^tradeId|^openId/</span> &amp;&amp; <span class="i">$useid</span> == <span class="n">1</span> <span class="s">)</span>
          <span class="sc">;</span>    <span class="c"># don&#39;t put id into this</span>

        <span class="s">(</span> <span class="s">(</span> <span class="i">$id_field</span> = <span class="i">$column_name</span> <span class="s">)</span> &amp;&amp; <span class="k">next</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$column_name</span> =~ <span class="q">/userLogin/</span> &amp;&amp; <span class="i">$useid</span> == <span class="n">2</span> <span class="s">)</span>
          <span class="sc">;</span>    <span class="c"># don&#39;t put id into this</span>

        <span class="i">$value_string</span> .= <span class="q">&quot;$column_name \= \&#39;$fields{$column_name}\&#39;,\n&quot;</span>

  <span class="c">#FIXME: ugly hack to zeroise commitlimit field in om_registry if blank 11/2008</span>
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fields</span>{<span class="i">$column_name</span>} <span class="s">)</span>
            || <span class="i">$fields</span>{<span class="i">$column_name</span>} =~ <span class="q">m/commitlimit/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

 <span class="c">#FIXME: ugly hack to blank latest_news field in om_registry if blank 11/2009</span>
 <span class="c">#       prevented password change etc. badly expressed condition, watch this...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$tablename</span> <span class="k">eq</span> <span class="q">&#39;om_registry&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span> <span class="i">$fields</span>{<span class="w">latest_news</span>} || !<span class="k">defined</span> <span class="i">$fields</span>{<span class="w">latest_news</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$value_string</span> .= <span class="q">&quot;latest_news \= \&#39;\&#39;,\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="i">$value_string</span> =~ <span class="q">s/,$//</span><span class="sc">;</span>    <span class="c"># remove the last comma!</span>

    <span class="k">my</span> <span class="i">$sqlupdate</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   UPDATE $tablename </span>
<span class="hh">   SET</span>
<span class="hh">   $value_string </span>
<span class="hh">   WHERE ( $id_field = &#39;$fields{$id_field}&#39;)</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sqlupdate</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlcount">_sqlcount</a></h3>
<p>This is only tested for the transactions table at present
counts transactions for the logged in user.</p>
<pre>
<a name="_sqlcount-"></a><span class="k">sub </span><span class="m">_sqlcount</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$value</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlcount</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$sqlstring</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$sqlcount</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">     SELECT COUNT(*) FROM $table</span>
<span class="hh">      WHERE $fieldname = &#39;$value&#39;  GROUP BY $fieldname</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$sqlcount</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT COUNT(*) FROM $table</span>
<span class="hh">     WHERE $sqlstring  </span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># removed group by fieldname from second statement</span>
    <span class="k">return</span> <span class="i">$sqlcount</span><span class="sc">;</span>
<span class="s">}</span>

<a name="_sql_give_volumes-"></a><span class="k">sub </span><span class="m">_sql_give_volumes</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$months_back</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># sum by user except for manager, sum all transactions...</span>
    <span class="k">my</span> <span class="i">$user_string</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$user</span> <span class="k">eq</span> <span class="q">&#39;manager&#39;</span> <span class="s">)</span>
      ? <span class="s">(</span> <span class="i">$user_string</span> = <span class="q">&#39;&#39;</span> <span class="s">)</span>
      <span class="co">:</span> <span class="s">(</span> <span class="i">$user_string</span> =
          <span class="q">&quot;(tradeDestination = \&#39;$user\&#39; or tradeSource= \&#39;$user\&#39;) and&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT  concat(substring(tradeCurrency,1,3),year(tradeDate),month(tradeDate)) as sort,</span>
<span class="hh">monthname(tradeDate) as mth, substring(year(tradeDate),3,2) as yr, tradeCurrency as currency,</span>
<span class="hh">round(sum(tradeAmount)/2) as volume, round(count(*)/2) as cnt  from om_trades where</span>
<span class="hh">$user_string</span>
<span class="hh">(tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39;)</span>
<span class="hh">group by currency, yr, mth order by sort</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sql</span><span class="sc">;</span>

<span class="s">}</span>

<a name="_sql_get_balance_by_currency-"></a><span class="k">sub </span><span class="m">_sql_get_balance_by_currency</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># sum by user except for manager, sum all transactions...</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$user_string</span><span class="cm">,</span> <span class="i">$user_string1</span><span class="cm">,</span> <span class="i">$date_string</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$user</span> <span class="k">eq</span> <span class="q">&#39;manager&#39;</span> <span class="s">)</span>
      ? <span class="s">(</span> <span class="i">$user_string</span> = <span class="q">&#39;&#39;</span> <span class="s">)</span>
      <span class="co">:</span> <span class="s">(</span> <span class="i">$user_string</span> = <span class="q">&quot;tradeDestination = \&#39;$user\&#39; and&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$user</span> <span class="k">eq</span> <span class="q">&#39;manager&#39;</span> <span class="s">)</span>
      ? <span class="s">(</span> <span class="i">$user_string1</span> = <span class="q">&#39;&#39;</span> <span class="s">)</span>
      <span class="co">:</span> <span class="s">(</span> <span class="i">$user_string1</span> = <span class="q">&quot;tradeSource = \&#39;$user\&#39; and&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># balance up to certain date only...</span>
    <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$date</span><span class="s">)</span> <span class="s">)</span>
      ? <span class="s">(</span> <span class="i">$date_string</span> = <span class="q">&quot;and tradeStamp &lt;= cast($date as timestamp)&quot;</span> <span class="s">)</span>
      <span class="co">:</span> <span class="s">(</span> <span class="i">$date_string</span> = <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sql</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT tradeId,tradeCurrency as currency, sum(tradeAmount) as sum from om_trades </span>
<span class="hh">where tradeType = &#39;credit&#39; and</span>
<span class="hh">$user_string</span>
<span class="hh">( tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39; ) and</span>
<span class="hh">tradeDestination != &#39;cash&#39;</span>
<span class="hh">$date_string </span>
<span class="hh">group by currency</span>

<span class="hh">union</span>

<span class="hh">SELECT tradeId,tradeCurrency as currency, -(sum(tradeAmount)) as sum from om_trades </span>
<span class="hh">where tradeType = &#39;debit&#39; and</span>
<span class="hh">$user_string1</span>
<span class="hh">( tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39; ) and</span>
<span class="hh">tradeDestination != &#39;cash&#39;</span>
<span class="hh">$date_string </span>
<span class="hh">group by currency</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sql</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_sql_balances_for_time_slices">_sql_balances_for_time_slices</a></h3>
<p>Two queries, one to get the credits per unixtime
The second, indexed by unixtime to identifiy th corresponding debits
This doesn't work well at all, at present, so there is a fixed set of
queries running two months back. Next step will be the correlated
subquery, example below...no group by because we want total cumulative sum...</p>
<p>tradeStamp is multuiplied by 1000 to give milliseconds for flot</p>
<p>SELECT tradeId,tradeCurrency as currency,
       unix_timestamp(tradeStamp)*1000 as x_axis, 
       sum(tradeAmount) as y_axis
       from om_trades 
    where unix_timestamp(tradeStamp) &gt;= (unix_timestamp()-604800) 
       and tradeType = 'credit' and tradeDestination = 'test2' 
       and ( tradeStatus = 'waiting' or tradeStatus = 'accepted' ) 
       and tradeDestination != 'cash' 
    group by substr(tradeStamp,1,16), currency</p>
<p>SELECT tradeId,tradeCurrency as currency,
       unix_timestamp(tradeStamp)*1000 as x_axis, 
       -(sum(tradeAmount)) as sum
       from om_trades 
    where unix_timestamp(tradeStamp) &gt;= (unix_timestamp()-604800) 
      and tradeType = 'debit' and tradeSource = 'test2' 
      and ( tradeStatus = 'waiting' or tradeStatus = 'accepted' ) 
      and tradeDestination != 'cash' 
   group by substr(tradeStamp,1,16), currency</p>
<p>SELECT DayCount,
       Sales,
       Sales+COALESCE((SELECT SUM(Sales) 
                      FROM Sales b 
                      WHERE b.DayCount &lt; a.DayCount),0)
                         AS RunningTotal
FROM Sales a
ORDER BY DayCount</p>
<pre>
<a name="_sql_balances_for_time_slices-"></a><span class="k">sub </span><span class="m">_sql_balances_for_time_slices</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$slice</span><span class="cm">,</span> <span class="i">$seconds_back</span><span class="cm">,</span> <span class="i">$user_string1</span><span class="cm">,</span> <span class="i">$user_string2</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sql_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> SELECT tradeId, `code` as currency, tradeStamp,</span>
<span class="hh">       (unix_timestamp() - $seconds_back) as x_axis, </span>
<span class="hh">       sum(tradeAmount) as y_axis</span>
<span class="hh">       from om_trades , om_currencies </span>
<span class="hh">    where unix_timestamp(tradeStamp) &lt;= (unix_timestamp() - $seconds_back) </span>
<span class="hh">       and om_trades.tradeCurrency = `name`</span>
<span class="hh">       and tradeType = &#39;credit&#39; </span>
<span class="hh">       $user_string1</span>
<span class="hh">       and ( tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39; ) </span>
<span class="hh">       and tradeDestination != &#39;cash&#39; </span>
<span class="hh">    group by currency </span>
<span class="hh">UNION</span>
<span class="hh">SELECT tradeId, `code` as currency, tradeStamp,</span>
<span class="hh">      (unix_timestamp() - $seconds_back)  as x_axis, </span>
<span class="hh">       -(sum(tradeAmount)) as y_axis</span>
<span class="hh">       from om_trades, om_currencies </span>
<span class="hh">    where unix_timestamp(tradeStamp) &lt;= (unix_timestamp() - $seconds_back)</span>
<span class="hh">      and om_trades.tradeCurrency = `name`</span>
<span class="hh">      and tradeType = &#39;debit&#39; </span>
<span class="hh">      $user_string2</span>
<span class="hh">      and ( tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39; ) </span>
<span class="hh">      and tradeDestination != &#39;cash&#39; </span>
<span class="hh">   group by currency        </span>
         
<span class="h">EOT</span>

    <span class="k">return</span> <span class="s">(</span><span class="i">$sql_string</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="makebutton">makebutton</a></h3>
<p>FIXME: makebutton probably needs to go to Ccu.pm
Values in extras override database values if there's
name collision. It's assumed that the extras are tailor made</p>
<p>label is the label on the push button, action is the name
of the action in the controller.</p>
<pre>
<a name="makebutton-"></a><span class="k">sub </span><span class="m">makebutton</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$label</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$hash_ref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> =
      <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$formfields</span><span class="cm">,</span> <span class="i">$x</span><span class="cm">,</span> <span class="i">$senddetected</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fieldnames</span> = <span class="i">get_table_columns</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span> = <span class="i">get_id_name</span><span class="s">(</span><span class="i">$table</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field_name</span> <span class="s">(</span><span class="i">@fieldnames</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$field_name</span> !~ <span class="q">/Send|Go/</span> <span class="s">)</span> <span class="s">{</span>

<span class="c">#FIXME: only need id info within a delete or display button, should only need id, en principe!</span>
<span class="c"># fromuserid is used by yellow pages to get stats for the advertising user...</span>
            <span class="k">next</span>
              <span class="k">if</span> <span class="s">(</span>
                <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;delete&quot;</span> || <span class="i">$action</span> =~ <span class="q">/^display|show/</span> <span class="s">)</span>
                &amp;&amp; <span class="s">(</span>   <span class="i">$field_name</span> <span class="k">ne</span> <span class="i">$id</span>
                    &amp;&amp; <span class="i">$field_name</span> <span class="k">ne</span> <span class="q">&#39;userLogin&#39;</span>
                    &amp;&amp; <span class="i">$field_name</span> <span class="k">ne</span> <span class="q">&#39;fromuserid&#39;</span> <span class="s">)</span>
              <span class="s">)</span><span class="sc">;</span>

            <span class="k">my</span> <span class="i">$hidden_field</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input id=&quot;$field_name&quot; type=&quot;hidden&quot; name=&quot;$field_name&quot; value=&quot;$hash_ref-&gt;{$field_name}&quot;&gt;</span>
<span class="h">EOT</span>

            <span class="c">#FIXME: name collision, displayed user data and current user...</span>
            <span class="i">$hidden_field</span> =~ <span class="q">s/(name=\&quot;)(.*?)(\&quot;)/$1duserLogin$3/</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$field_name</span> <span class="k">eq</span> <span class="q">&#39;userLogin&#39;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c">#FIXME: hack because of &#39;name&#39; collision in currencies table</span>
            <span class="i">$hidden_field</span> =~ <span class="q">s/(name=\&quot;)name(\&quot;)/$1cname$2/</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_currencies&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$hidden_field</span> =~ <span class="q">s/(name=\&quot;)name(\&quot;)/$1dname$2/</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_partners&#39;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="i">$formfields</span> .= <span class="i">$hidden_field</span><span class="sc">;</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input  type=&quot;submit&quot; name=&quot;$field_name&quot; value=&quot;$field_name&quot;&gt;</span>
<span class="h">EOT</span>
            <span class="i">$senddetected</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># endif</span>

    <span class="s">}</span>    <span class="c"># end foreach</span>

<span class="c"># add a template into resulttemplate, should be display, displayyellow, displayuser etc. etc.</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> =~ <span class="q">/^display|show/</span> || <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;template&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$template</span> = <span class="i">_choosetemplate</span><span class="s">(</span> <span class="s">(</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$formfields</span> .= <span class="i">$template</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$senddetected</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#FIXME: class isn&#39;t picked up somewhere in this...</span>

        <span class="i">$class</span> ||= <span class="q">&#39;small&#39;</span><span class="sc">;</span>
        <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;subaction&quot; value=&quot;$table&quot;&gt;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;$action&quot;&gt;</span>
<span class="hh"> &lt;input class=&quot;$class&quot; type=&quot;submit&quot; name=&quot;go&quot; value=&quot;\u$label&quot;&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c">#FIXME: correct home for modifcation of partners and currencies</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&#39;template&#39;</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_partners&#39;</span> <span class="k">or</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_currencies&#39;</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="w">home</span>} =~ <span class="q">s/cclite.cgi/\/protected\/ccadmin.cgi/</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$button</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;form id=&quot;form&quot; class=&quot;pme-form&quot; action=&quot;$fieldsref-&gt;{home}&quot; method=&quot;POST&quot;&gt;</span>
<span class="hh">$formfields</span>
<span class="hh">&lt;/form&gt;</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$button</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_get_table_fields">_get_table_fields</a></h3>
<p>Choose fields for tabular style display according to table
Modify this to modify this to modify table display, the fields list must contain
the id field because the retrieval is via a hash since 4/2010</p>
<pre>
<a name="get_table_fields-"></a><span class="k">sub </span><span class="m">get_table_fields</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldlist</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%table_fields</span> = <span class="s">(</span>
        <span class="q">&#39;om_trades&#39;</span> <span class="cm">=&gt;</span>
<span class="q">&#39;tradeId,tradeStatus,tradeDate,tradeSource,tradeDestination,tradeMirror,tradeCurrency,tradeType,tradeAmount&#39;</span><span class="cm">,</span>
        <span class="q">&#39;om_yellowpages&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;id,fromuserid,status,date,type,keywords,subject&#39;</span><span class="cm">,</span>
        <span class="q">&#39;om_openid&#39;</span>      <span class="cm">=&gt;</span> <span class="q">&#39;openId,openIdDesc&#39;</span><span class="cm">,</span>
        <span class="q">&#39;om_partners&#39;</span>    <span class="cm">=&gt;</span> <span class="q">&#39;id,name,email,type,status&#39;</span><span class="cm">,</span>
        <span class="q">&#39;om_currencies&#39;</span>  <span class="cm">=&gt;</span> <span class="q">&#39;id,name,code,description,status&#39;</span><span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span>       <span class="cm">=&gt;</span> <span class="q">&#39;userId,userLogin,userName,userStatus&#39;</span><span class="cm">,</span>

    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># for the moment any value will do, other than *</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldlist</span> <span class="k">ne</span> <span class="q">&#39;*&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$table_fields</span>{<span class="i">$table</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&#39;*&#39;</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_id_name">get_id_name</a></h3>
<p>Gets the id field depending on the table name. The should all be the same
but since the database was a mixture of Mose, myself etc. they are not,
don't want to change now, will introduce serious incompatbilities</p>
<pre>
<a name="get_id_name-"></a><span class="k">sub </span><span class="m">get_id_name</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$table</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%id_fields</span> = <span class="q">qw(om_trades tradeId om_openid openId om_users userId)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$id_fields</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$id_fields</span>{<span class="i">$table</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&#39;id&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_choosetemplate">_choosetemplate</a></h3>
<p>FIXEME: Choose a template for display items when making
buttons. This is ugly, since choice of templates is
hardcoded into the code</p>
<pre>
<a name="_choosetemplate-"></a><span class="k">sub </span><span class="m">_choosetemplate</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%templates</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$template</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> =~ <span class="q">/^display|show/</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># display, displayyellow etc. etc.</span>
        <span class="i">%templates</span> = <span class="q">qw(om_yellowpages displayyellowpage.html</span>
          <span class="q">om_trades displaytransaction.html</span>
          <span class="q">om_users displayuser.html</span>
        <span class="q">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$templates</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$template</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;resulttemplate&quot; value=&quot;$templates{$table}&quot;&gt;</span>
<span class="h">EOT</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$template</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;resulttemplate&quot; value=&quot;result.html&quot;&gt;</span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;template&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">%templates</span> = <span class="q">qw(om_users users.html</span>
          <span class="q">om_currencies modcurrency.html</span>
          <span class="q">om_trades displaytransaction.html</span>
          <span class="q">om_yellowpages modifyyellowpage.html</span>
          <span class="q">om_partners modpartners.html</span>
        <span class="q">)</span><span class="sc">;</span>
        <span class="i">$template</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;name&quot; value=&quot;$templates{$table}&quot;&gt;</span>
<span class="h">EOT</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$template</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># stats and graphing transactions</span>

</pre><p></p>
<h3><a name="get_raw_stats_data">get_raw_stats_data</a></h3>
<p>Get trade volumes and averages and deliver to make a javascript Graph chart
This probably also gets delivered into cut down temporary
tables too...</p>
<p>1970-01-01 00:00:01'</p>
<p>tradeStamp(15,2) is minutes
tradeStamp(12,2) is hours
tradeStamp(9,2) is days
tradeStamp(6,2) is month</p>
<pre>
<a name="_format_number-"></a><span class="k">sub </span><span class="m">_format_number</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$number</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">length</span><span class="s">(</span><span class="i">$number</span><span class="s">)</span> == <span class="n">1</span> ? <span class="s">(</span> <span class="i">$number</span> = <span class="q">&quot;0$number&quot;</span> <span class="s">)</span> <span class="co">:</span> <span class="s">(</span> <span class="i">$number</span> = <span class="i">$number</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$number</span><span class="sc">;</span>
<span class="s">}</span>

<a name="get_raw_stats_data-"></a><span class="k">sub </span><span class="m">get_raw_stats_data</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$from_x_hours_back</span><span class="cm">,</span> <span class="i">$graph_type</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> =
      <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%types</span> = <span class="s">(</span>
        <span class="q">&#39;seconds&#39;</span><span class="cm">,</span> <span class="q">&#39;1,19&#39;</span><span class="cm">,</span> <span class="q">&#39;minutes&#39;</span><span class="cm">,</span> <span class="q">&#39;1,16&#39;</span><span class="cm">,</span> <span class="q">&#39;hours&#39;</span><span class="cm">,</span> <span class="q">&#39;1,13&#39;</span><span class="cm">,</span>
        <span class="q">&#39;days&#39;</span><span class="cm">,</span>    <span class="q">&#39;1,10&#39;</span><span class="cm">,</span> <span class="q">&#39;month&#39;</span><span class="cm">,</span>   <span class="q">&#39;1,7&#39;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%axis</span> = <span class="s">(</span>
        <span class="q">&#39;seconds&#39;</span><span class="cm">,</span> <span class="q">&#39;1,19&#39;</span><span class="cm">,</span> <span class="q">&#39;minutes&#39;</span><span class="cm">,</span> <span class="q">&#39;1,16&#39;</span><span class="cm">,</span> <span class="q">&#39;hours&#39;</span><span class="cm">,</span> <span class="q">&#39;9,5&#39;</span><span class="cm">,</span>
        <span class="q">&#39;days&#39;</span><span class="cm">,</span>    <span class="q">&#39;1,10&#39;</span><span class="cm">,</span> <span class="q">&#39;month&#39;</span><span class="cm">,</span>   <span class="q">&#39;1,7&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># default is one week, shpuldn&#39;t be necessary, set in javascript ;</span>
    <span class="i">$from_x_hours_back</span> ||= <span class="n">168</span><span class="sc">;</span>
    <span class="i">$type</span>              ||= <span class="q">&#39;minutes&#39;</span><span class="sc">;</span>

    <span class="c"># fill the &#39;missing&#39; sql_string variables</span>
    <span class="k">my</span> <span class="i">$slice</span>   = <span class="i">$types</span>{<span class="i">$type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$x_axis</span>  = <span class="i">$axis</span>{<span class="i">$type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$seconds</span> = <span class="i">$from_x_hours_back</span> * <span class="n">60</span> * <span class="n">60</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sql_string</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$graph_type</span> <span class="k">eq</span> <span class="q">&#39;average&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="q">&#39;usedecimals&#39;</span>} <span class="k">eq</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sql_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> SELECT tradeId, unix_timestamp(tradeStamp)*1000 as x_axis, format((avg(tradeAmount)/100),2) as y_axis, substr(tradeStamp,$slice) FROM om_trades o  </span>
<span class="hh">   where unix_timestamp(tradeStamp) &gt;= (unix_timestamp()-$seconds) </span>
<span class="hh">   group by substr(tradeStamp,$slice) ORDER BY tradeId asc;</span>
<span class="h">EOT</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$sql_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> SELECT tradeId, unix_timestamp(tradeStamp) as x_axis, format(avg(tradeAmount),2) as y_axis, substr(tradeStamp,$slice) FROM om_trades o  </span>
<span class="hh">   where unix_timestamp(tradeStamp) &gt;= (unix_timestamp()-$seconds) </span>
<span class="hh">   group by substr(tradeStamp,$slice) ORDER BY tradeId asc ;</span>
<span class="h">EOT</span>

        <span class="s">}</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$graph_type</span> <span class="k">eq</span> <span class="q">&#39;volume&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$sql_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT tradeId, unix_timestamp(tradeStamp)*1000 as x_axis, count(*)/2 as y_axis, substr(tradeStamp,$slice) FROM om_trades o  </span>
<span class="hh">   where unix_timestamp(tradeStamp) &gt;= (unix_timestamp()-$seconds) </span>
<span class="hh">   group by substr(tradeStamp,$slice) ORDER BY tradeId asc ;</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c">###print &quot;type is $type, graph type is $graph_type, seconds are $seconds, sqlstring is $sql_string&quot; ;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sql_string</span><span class="cm">,</span> <span class="q">&#39;tradeId&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$hash_ref</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_raw_stats_data_for_balances">get_raw_stats_data_for_balances</a></h3>
<p>This provides several hash refs one for each currency
Queries and processing more complex than averages and volumes
so moved into a separate piece of processing...</p>
<p>Some of this should be in Cclite.pm</p>
<pre>
<a name="get_raw_stats_data_for_balances-"></a><span class="k">sub </span><span class="m">get_raw_stats_data_for_balances</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$from_x_hours_back</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$user_string</span><span class="cm">,</span> <span class="i">$user_string1</span><span class="cm">,</span> <span class="i">%flot</span> <span class="s">)</span><span class="sc">;</span>   <span class="c"># %flot is keyed by currency...</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%types</span> = <span class="s">(</span>
        <span class="q">&#39;seconds&#39;</span><span class="cm">,</span> <span class="q">&#39;1,19&#39;</span><span class="cm">,</span> <span class="q">&#39;minutes&#39;</span><span class="cm">,</span> <span class="q">&#39;1,16&#39;</span><span class="cm">,</span> <span class="q">&#39;hours&#39;</span><span class="cm">,</span> <span class="q">&#39;1,13&#39;</span><span class="cm">,</span>
        <span class="q">&#39;days&#39;</span><span class="cm">,</span>    <span class="q">&#39;1,10&#39;</span><span class="cm">,</span> <span class="q">&#39;month&#39;</span><span class="cm">,</span>   <span class="q">&#39;1,7&#39;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%axis</span> = <span class="s">(</span>
        <span class="q">&#39;seconds&#39;</span><span class="cm">,</span> <span class="q">&#39;1,19&#39;</span><span class="cm">,</span> <span class="q">&#39;minutes&#39;</span><span class="cm">,</span> <span class="q">&#39;1,16&#39;</span><span class="cm">,</span> <span class="q">&#39;hours&#39;</span><span class="cm">,</span> <span class="q">&#39;9,5&#39;</span><span class="cm">,</span>
        <span class="q">&#39;days&#39;</span><span class="cm">,</span>    <span class="q">&#39;1,10&#39;</span><span class="cm">,</span> <span class="q">&#39;month&#39;</span><span class="cm">,</span>   <span class="q">&#39;1,7&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># default is one week, shpuldn&#39;t be necessary, set in javascript ;</span>
    <span class="i">$from_x_hours_back</span> ||= <span class="n">48</span><span class="sc">;</span>
    <span class="i">$type</span>              ||= <span class="q">&#39;seconds&#39;</span><span class="sc">;</span>

    <span class="c"># fill the &#39;missing&#39; sql_string variables</span>
    <span class="k">my</span> <span class="i">$slice</span>   = <span class="i">$types</span>{<span class="i">$type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$x_axis</span>  = <span class="i">$axis</span>{<span class="i">$type</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$seconds</span> = <span class="i">$from_x_hours_back</span> * <span class="n">3600</span><span class="sc">;</span>

    <span class="c"># if there&#39;s a user for balances add constraint for sql union bits</span>
    <span class="s">(</span> <span class="i">$user</span> <span class="k">eq</span> <span class="q">&#39;&#39;</span> <span class="s">)</span>
      ? <span class="s">(</span> <span class="i">$user_string</span> = <span class="q">&#39;&#39;</span> <span class="s">)</span>
      <span class="co">:</span> <span class="s">(</span> <span class="i">$user_string</span> = <span class="q">&quot;and tradeDestination = \&#39;$user\&#39; &quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$user</span> <span class="k">eq</span> <span class="q">&#39;&#39;</span> <span class="s">)</span>
      ? <span class="s">(</span> <span class="i">$user_string1</span> = <span class="q">&#39;&#39;</span> <span class="s">)</span>
      <span class="co">:</span> <span class="s">(</span> <span class="i">$user_string1</span> = <span class="q">&quot;and tradeSource = \&#39;$user\&#39; &quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#FIME: calculate ten points to make ten queries, not good but...</span>
    <span class="k">my</span> <span class="i">$points</span> =
      <span class="i">$seconds</span> / <span class="n">10</span><span class="sc">;</span>    <span class="c"># alway integer since multiplied by 3600 above...</span>
    <span class="k">my</span> <span class="i">$counter</span> = <span class="i">$seconds</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$x_axis</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="i">$counter</span> &gt;= <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$sql_string</span> =
          <span class="i">_sql_balances_for_time_slices</span><span class="s">(</span> <span class="i">$slice</span><span class="cm">,</span> <span class="i">$counter</span><span class="cm">,</span> <span class="i">$user_string</span><span class="cm">,</span>
            <span class="i">$user_string1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c">###print &quot;sql string is $sql_string&lt;br/&gt;&lt;br/&gt;&quot; ;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> =
          <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sql_string</span><span class="cm">,</span> <span class="q">&#39;tradeId&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">%totals_by_currency</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># do decimals, if configured</span>
            <span class="i">$hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;y_axis&#39;</span>} = <span class="k">sprintf</span> <span class="q">&quot;%.2f&quot;</span><span class="cm">,</span>
              <span class="s">(</span> <span class="i">$hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;y_axis&#39;</span>} / <span class="n">100</span> <span class="s">)</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">usedecimals</span>} <span class="k">eq</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span><span class="sc">;</span>

            <span class="i">$totals_by_currency</span>{ <span class="i">$hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;currency&#39;</span>} } +=
              <span class="i">$hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;y_axis&#39;</span>}<span class="sc">;</span>

        <span class="s">}</span>

        <span class="c"># add a record for each currency time series</span>
        <span class="k">my</span> <span class="i">$x_axis</span> = <span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> - <span class="i">$counter</span> <span class="s">)</span> * <span class="n">1000</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$sec</span><span class="cm">,</span> <span class="i">$min</span><span class="cm">,</span> <span class="i">$hour</span><span class="cm">,</span> <span class="i">$mday</span><span class="cm">,</span> <span class="i">$mon</span><span class="cm">,</span> <span class="i">$year</span><span class="cm">,</span> <span class="i">$wday</span><span class="cm">,</span> <span class="i">$yday</span><span class="cm">,</span> <span class="i">$isdst</span> <span class="s">)</span> =
          <span class="k">localtime</span><span class="s">(</span><span class="i">$x_axis</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$year</span> = <span class="i">$year</span> + <span class="n">1900</span><span class="sc">;</span>
        <span class="i">$mon</span>++<span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%totals_by_currency</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$flot</span>{<span class="i">$key</span>} .= <span class="q">&quot; [\&quot;$x_axis\&quot;, \&quot;$totals_by_currency{$key}\&quot;], \n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$counter</span> = <span class="i">$counter</span> - <span class="i">$points</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%flot</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># snip off last comma</span>
        <span class="i">$flot</span>{<span class="i">$key</span>} =~ <span class="q">s/\,\s*$//</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> \<span class="i">%flot</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="whos_online">whos_online</a></h3>
<p>Delivers a count and a list of those online
The count is used for closing down the registry</p>
<pre>
<a name="whos_online-"></a><span class="k">sub </span><span class="m">whos_online</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$get</span> = <span class="q">&quot;SELECT userLogin FROM om_users where userLoggedin = &#39;1&#39; &quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$array_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_arrayref</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$count</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="log_entry">log_entry</a></h3>
<p>Log entry into logging table. $type is taken from the standard list of types</p>
<pre>
    trace;  # Log a trace message
    debug;  # Log a debug message
    info ;  # Log a info message
    warn;   # Log a warn message
    error;  # Log a error message
    fatal;  # Log a fatal message</pre>
<p>So that there's compatiblity with log4perl etc.</p>

<pre>
<a name="log_entry-"></a><span class="k">sub </span><span class="m">log_entry</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$fieldsref</span>  = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%type_value</span> = <span class="q">qw(trace 5 debug 4 info 3 warn 2 error 1 fatal 0)</span><span class="sc">;</span>

    <span class="c"># something wrong in the code, if a valid logging type is not delivered</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$type_value</span>{<span class="i">$type</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} = <span class="q">&#39;fatal&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} = <span class="i">$type</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$timestamp</span> = <span class="i">sql_timestamp</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;message&#39;</span>} = <span class="i">$message</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;stamp&#39;</span>}   = <span class="i">$timestamp</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_log&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
