<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>read_pop_mail_gpg.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>read_pop_mail_gpg.pl</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#check_parameters">check_parameters</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#check_parameters-">package main</a>
<ul>
<li><a href="#check_parameters-">check_parameters</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>#!/usr/bin/perl 

</pre><p></p>
<hr />
<h1><a name="name">NAME</a></h1>
<p>read_pop_mail_gpg.pl</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Read gpg encrypted mail transactions, process and send motifications
Only currently deals with payments (send) and balance (balance) at present
all the parsing etc. is 'english' this needs to be dealt with real-soon</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>#---------------------------------------------------------------------------
#THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS
#OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,
#OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,
#ANY IMPLIED WARRANTIES OF MERCHANTABILITY,
#FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.
#WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,
#INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,
#INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,
#LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,
#REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER
#WHICH THE LIABILITY MAY BE ASSERTED,
#EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.
#---------------------------------------------------------------------------</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2004-2010 GPL Licenced</p>
<pre>
<span class="c"># these batch scripts are kept as eval, if they fail they print their problems</span>
<span class="c"># onto the status web page</span>

<span class="c">#print STDOUT &quot;Content-type: text/html\n\n&quot;;</span>

<span class="c">###my $data = join( &#39;&#39;, &lt;DATA&gt; );</span>
<span class="c">###eval $data;</span>
<span class="c">###if ($@) {</span>
<span class="c">###    print $@;</span>
<span class="c">###   exit 1;</span>
<span class="c">###}</span>
<span class="c">###__END__</span>

</pre><p></p>
<h3><a name="check_parameters">check_parameters</a></h3>
<p>Check that the set up can work and exit otherwise..
FIXME: Only checks non blank not valid file names</p>

<pre>
<a name="check_parameters-"></a><span class="k">sub </span><span class="m">check_parameters</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$temp_directory</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="cm">,</span>
        <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$debug</span><span class="cm">,</span> <span class="i">$trace</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@error_messages</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@error_nessages</span><span class="cm">,</span> <span class="q">&#39;registry blank&#39;</span>   <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$registry</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@error_nessages</span><span class="cm">,</span> <span class="q">&#39;passphrase blank&#39;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$passphrase</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@error_nessages</span><span class="cm">,</span> <span class="q">&#39;temporary directory blank&#39;</span>
      <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$temp_directory</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@error_nessages</span><span class="cm">,</span> <span class="q">&#39;message file blank&#39;</span>    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@error_nessages</span><span class="cm">,</span> <span class="q">&#39;encryption file blank&#39;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$encrypted</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$registry</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
            <span class="q">&#39;name&#39;</span><span class="cm">,</span>  <span class="i">$registry</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>        <span class="q">&#39;&#39;</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@error_nessages</span><span class="cm">,</span> <span class="i">$error</span> <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># print errors and exit, if problems with set up</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span> <span class="i">@error_messages</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$errors</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span> <span class="i">@error_messages</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$errors</span> <span class="sc">;</span>
        <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="c"># --- start of main script ---#</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">lib</span> <span class="q">&#39;../../../lib&#39;</span><span class="sc">;</span>

<span class="c"># this is mailbox access</span>
<span class="k">use</span> <span class="w">Net::POP3</span><span class="sc">;</span>

<span class="c"># this is used to parse addresses (logically enough...)</span>
<span class="k">use</span> <span class="w">Email::Address</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccmailgateway</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccrypto</span><span class="sc">;</span>

<span class="c">#use Ccinterfaces;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>

<span class="k">BEGIN</span> <span class="s">{</span>
    <span class="k">use</span> <span class="w">CGI::Carp</span> <span class="q">qw(fatalsToBrowser set_message)</span><span class="sc">;</span>
    <span class="i">set_message</span><span class="s">(</span>
<span class="q">&quot;Please use the &lt;a title=\&quot;cclite google group\&quot; href=\&quot;http://groups.google.co.uk/group/cclite\&quot;&gt;Cclite Google Group&lt;/a&gt; for help, if necessary&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># read configuration and messages</span>
<span class="k">my</span> <span class="i">%configuration</span>          = <span class="w">readconfiguration</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$configuration_hash_ref</span> = \<span class="i">%configuration</span><span class="sc">;</span>

<span class="c"># language now decided by decide_language 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># note this is a first version, these values will be configured  with the rest later</span>
<span class="c">#-------------------------------------------------------------------------------------------------------------</span>

<span class="k">my</span> <span class="i">%gpg_configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="q">&#39;../../../config/readmailgpg.cf&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$temp_directory</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;temp_directory&#39;</span>}<span class="sc">;</span>

<span class="k">my</span> <span class="i">$message</span> =
  <span class="q">&quot;$gpg_configuration{&#39;temp_directory&#39;}/$gpg_configuration{&#39;message&#39;}&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$reformat</span> =
  <span class="q">&quot;$gpg_configuration{&#39;temp_directory&#39;}/$gpg_configuration{&#39;reformat&#39;}&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$decrypt</span> =
  <span class="q">&quot;$gpg_configuration{&#39;temp_directory&#39;}/$gpg_configuration{&#39;decrypt&#39;}&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$encrypted</span> =
  <span class="q">&quot;$gpg_configuration{&#39;temp_directory&#39;}/$gpg_configuration{&#39;encrypted&#39;}&quot;</span><span class="sc">;</span>

<span class="c"># send receipts etc. encrypted with users public key</span>
<span class="k">my</span> <span class="i">$encrypt_notifications</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;encrypt_notifications&#39;</span>}<span class="sc">;</span>

<span class="c"># STDERR for gpg operations, if specified...</span>
<span class="k">my</span> <span class="i">$logfile</span> =
  <span class="q">&quot;$gpg_configuration{&#39;temp_directory&#39;}/$gpg_configuration{&#39;logfile&#39;}&quot;</span><span class="sc">;</span>

<span class="c"># turns gpg trace on and off, prints to STDOUT (or STDERR?)</span>
<span class="k">my</span> <span class="i">$trace</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;trace&#39;</span>}<span class="sc">;</span>

<span class="c"># sleep in seconds for processing loop</span>
<span class="k">my</span> <span class="i">$sleep</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;sleep&#39;</span>}<span class="sc">;</span>

<span class="c"># clearly this is very insecure, should be held as a smartcard token for example, this</span>
<span class="c"># passphrase unlocks the private key for decrpyting the incoming transactions</span>
<span class="c"># users private key on client is used to sign transactions</span>

<span class="c"># note the key and the running user must correspond, otherwise the key won&#39;t get released by gpg</span>
<span class="k">my</span> <span class="i">$passphrase</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;passphrase&#39;</span>}<span class="sc">;</span>

<span class="c"># this will leave data in the intermediate files and mail in the mailbox, if set to 1, avoids</span>
<span class="c"># resetting/resending etc. when debugging</span>
<span class="k">my</span> <span class="i">$debug</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;debug&#39;</span>}<span class="sc">;</span>

<span class="c"># for cron, replace these with hardcoded registry name, for example</span>
<span class="k">my</span> <span class="i">$hardcoded_registry</span> = <span class="i">$gpg_configuration</span>{<span class="q">&#39;hardcoded_registry&#39;</span>}<span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%gpg_configuration</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;$key = $gpg_configuration{$key}\n&quot;</span><span class="sc">;</span>

    <span class="s">}</span>
<span class="s">}</span>

<span class="k">my</span> <span class="i">%fields</span>    = <span class="i">cgiparse</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#FIXME: needs higher barrier than this and something a little more general</span>
<span class="k">my</span> <span class="i">$registry</span> = <span class="i">$$cookieref</span>{<span class="w">registry</span>} || <span class="i">$hardcoded_registry</span><span class="sc">;</span>

<span class="c"># check that the set up works before starting to process...</span>
<span class="i">check_parameters</span><span class="s">(</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$temp_directory</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="cm">,</span>
    <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$debug</span><span class="cm">,</span> <span class="i">$trace</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># store of references to transactions to be notified</span>
<span class="k">my</span> <span class="i">@notifications</span><span class="sc">;</span>

<span class="c"># read the current registry to pick up per-registry email values, that&#39;s where the email</span>
<span class="c"># transactions are picked up from</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
    <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
    <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>        <span class="q">&#39;&#39;</span><span class="cm">,</span>
    <span class="q">&#39;&#39;</span>
<span class="s">)</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">log_entry</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&quot;database error for $registry: $error&quot;</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">my</span> <span class="i">$username</span> = <span class="i">$registryref</span>-&gt;{<span class="w">postemail</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$password</span> = <span class="i">$registryref</span>-&gt;{<span class="w">postpass</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$host</span>     = <span class="i">$username</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$count</span>    = <span class="n">0</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$originator_email</span><span class="sc">;</span>

<span class="c">#FIXME: get the domain part as postbox...this is weak...</span>
<span class="i">$host</span> =~ <span class="q">s/^(.*?)\@(.*)$/$2/</span><span class="sc">;</span>

<span class="k">while</span> <span class="s">(</span><span class="n">1</span><span class="s">)</span> <span class="s">{</span>

    <span class="k">print</span> <span class="q">&quot;running&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;\nwarning debug mode!&quot;</span> <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">print</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>

    <span class="c"># clear up, just in case...</span>
    <span class="k">unlink</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$reformat</span><span class="cm">,</span> <span class="i">$decrypt</span><span class="cm">,</span> <span class="i">$encrypted</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pop</span> = <span class="w">Net::POP3</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="i">$host</span><span class="cm">,</span> <span class="w">Timeout</span> <span class="cm">=&gt;</span> <span class="n">60</span><span class="cm">,</span> <span class="w">Debug</span> <span class="cm">=&gt;</span> <span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$pop</span><span class="i">-&gt;login</span><span class="s">(</span> <span class="i">$username</span><span class="cm">,</span> <span class="i">$password</span> <span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$msgnums</span> = <span class="i">$pop</span><span class="i">-&gt;list</span><span class="sc">;</span>    <span class="c"># hashref of msgnum =&gt; size</span>
        <span class="k">my</span> <span class="i">@from_array</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@to_array</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$batch_email_box</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$msgnum</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$msgnums</span> <span class="s">)</span> <span class="s">{</span>

            <span class="k">my</span> <span class="i">$msg</span> = <span class="i">$pop</span><span class="i">-&gt;get</span><span class="s">(</span><span class="i">$msgnum</span><span class="s">)</span><span class="sc">;</span>

            <span class="c"># put the message in a file for decrypt and reformat</span>

            <span class="k">my</span> <span class="s">(</span> <span class="i">$subject</span><span class="cm">,</span> <span class="i">$parse_type</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c"># detect pgp, decryption attempy stops script, if no PGP banner</span>
            <span class="k">my</span> <span class="i">$pgp_detected</span> = <span class="n">0</span><span class="sc">;</span>

            <span class="k">open</span><span class="s">(</span> <span class="w">MAIL</span><span class="cm">,</span> <span class="q">&quot;&gt;$message&quot;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$part</span> <span class="s">(</span><span class="i">@$msg</span><span class="s">)</span> <span class="s">{</span>

                <span class="i">$pgp_detected</span> = <span class="n">1</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$part</span> =~ <span class="q">/BEGIN PGP MESSAGE/</span> <span class="s">)</span><span class="sc">;</span>

                <span class="k">print</span> <span class="i">MAIL</span> <span class="i">$part</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span> <span class="i">$part</span> =~ <span class="q">/From:/</span> <span class="s">)</span> <span class="s">{</span>

                    <span class="i">@from_array</span> = <span class="w">Email::Address</span><span class="w">-&gt;parse</span><span class="s">(</span><span class="i">$part</span><span class="s">)</span><span class="sc">;</span>

                    <span class="c"># deal with Yahoo parse etc. may need more tweaking...</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_array</span>[<span class="n">0</span>] =~ <span class="q">/\&lt;(.*?)\&gt;/</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="i">$from_array</span>[<span class="n">0</span>] = <span class="i">$1</span><span class="sc">;</span>
                    <span class="s">}</span>

                    <span class="c"># these are just to understand the data</span>
                    <span class="i">$originator_email</span> = <span class="i">$from_array</span>[<span class="n">0</span>]<span class="sc">;</span>

                <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$part</span> =~ <span class="q">/To:/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">@to_array</span> = <span class="w">Email::Address</span><span class="w">-&gt;parse</span><span class="s">(</span><span class="i">$part</span><span class="s">)</span><span class="sc">;</span>

                    <span class="c"># these are just to understand the data</span>
                    <span class="i">$batch_email_box</span> = <span class="i">$to_array</span>[<span class="n">0</span>]<span class="sc">;</span>

                <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$part</span> =~ <span class="q">/Subject:\s+(\S.*)/</span> <span class="s">)</span> <span class="s">{</span>

                    <span class="i">$subject</span> = <span class="i">$1</span><span class="sc">;</span>

                <span class="s">}</span>    <span class="c">#endif for message parse</span>

            <span class="s">}</span>    <span class="c"># end foreach of message parse all bits consumed</span>

            <span class="c"># current message is now in mail.txt for decryption</span>
            <span class="k">close</span><span class="s">(</span><span class="w">MAIL</span><span class="s">)</span><span class="sc">;</span>

            <span class="c"># non pgp mails are thrown away...</span>

<span class="c"># $transaction_found is true, if there&#39;s a transaction line beginning with &#39;send&#39; in the decrypted message</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$pgp_detected</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="s">(</span> <span class="i">$transaction_found</span><span class="cm">,</span> <span class="i">$transaction_unparsed</span> <span class="s">)</span> =
                  <span class="i">decode_decrypt_reformat</span><span class="s">(</span>
                    <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$reformat</span><span class="cm">,</span>
                    <span class="i">$decrypt</span><span class="cm">,</span>    <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$trace</span>
                  <span class="s">)</span><span class="sc">;</span>

                <span class="k">if</span> <span class="s">(</span><span class="i">$transaction_found</span><span class="s">)</span> <span class="s">{</span>
                    <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
                      <span class="i">mail_message_parse</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$originator_email</span><span class="cm">,</span>
                        <span class="i">$batch_email_box</span><span class="cm">,</span> <span class="i">$subject</span><span class="cm">,</span> <span class="i">$transaction_unparsed</span> <span class="s">)</span><span class="sc">;</span>

                    <span class="c"># add &#39;via email&#39; literal to description of transaction</span>
                    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>} =
                      <span class="q">&quot;$messages{&#39;viagpgmail&#39;} &quot;</span>
                      . <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#FIXME: we have output, error and text within transaction, needs simplifying</span>
                    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="w">error</span>} <span class="s">)</span>
                        &amp;&amp; <span class="i">$transaction_description_ref</span>-&gt;{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&#39;send&#39;</span> <span class="s">)</span>
                    <span class="s">{</span>
                        <span class="i">$transaction_description_ref</span>-&gt;{<span class="w">output_message</span>} =
                          <span class="i">mail_transaction</span><span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span>
                        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span>
                    <span class="s">{</span>

                        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;output_message&#39;</span>} =
                          <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;text&#39;</span>}<span class="sc">;</span>
                    <span class="s">}</span>

           <span class="c"># as mailbox is opened by pop and maybe need to encrypt notifications</span>
           <span class="c"># store in data structures amd do when mailbox closed for reading...</span>

                    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;originator_email&#39;</span>} =
                      <span class="i">$originator_email</span><span class="sc">;</span>

            <span class="c"># keep the references to be notified in an array of references...</span>
            <span class="c"># FIXME: maybe this should notify for every mail in the batch inbox?</span>
                    <span class="k">push</span> <span class="i">@notifications</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span><span class="sc">;</span>

                <span class="s">}</span>    <span class="c"># end of transaction found</span>

                <span class="i">$count</span>++<span class="sc">;</span>

                <span class="c"># pgp not detected, mail is thrown away...</span>
            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

                <span class="i">log_entry</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&quot;discarded non-pgp transaction\n&quot;</span><span class="cm">,</span>
                    <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="c"># these should be destroyed asap and possibly done in-memory</span>
            <span class="k">unlink</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$reformat</span><span class="cm">,</span> <span class="i">$decrypt</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

            <span class="i">$pop</span><span class="i">-&gt;delete</span><span class="s">(</span><span class="i">$msgnum</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$debug</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>    <span class="c">#end foreach of all messages</span>

    <span class="s">}</span>    <span class="c"># endif pop login</span>

    <span class="i">$pop</span><span class="i">-&gt;quit</span><span class="sc">;</span>

    <span class="c"># send encrypted notifications to originator...</span>
    <span class="i">send_notifications</span><span class="s">(</span> \<span class="i">@notifications</span><span class="cm">,</span> <span class="i">$passphrase</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$encrypted</span><span class="cm">,</span>
        <span class="i">$logfile</span><span class="cm">,</span> <span class="i">$encrypt_notifications</span><span class="cm">,</span> <span class="i">$trace</span><span class="cm">,</span> \<span class="i">%messages</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$count</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">sleep</span> <span class="i">$sleep</span><span class="sc">;</span>

<span class="s">}</span>
<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
