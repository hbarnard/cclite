<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>print_yellowpages.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>print_yellowpages.pl</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<ul>

		<ul>

			<li><a href="#print_yellow_dir">print_yellow_dir</a></li>
			<li><a href="#comments">comments</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#print_yellow_dir-">package main</a>
<ul>
<li><a href="#print_yellow_dir-">print_yellow_dir</a></li>
<li><a href="#style-">style</a></li>
<li><a href="#paragraph-">paragraph</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>#!/usr/bin/perl 

<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS</span>
<span class="c">#OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,</span>
<span class="c">#OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,</span>
<span class="c">#ANY IMPLIED WARRANTIES OF MERCHANTABILITY,</span>
<span class="c">#FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.</span>
<span class="c">#WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,</span>
<span class="c">#INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,</span>
<span class="c">#INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,</span>
<span class="c">#LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,</span>
<span class="c">#REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER</span>
<span class="c">#WHICH THE LIABILITY MAY BE ASSERTED,</span>
<span class="c">#EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.</span>
<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#</span>
<span class="c"># these batch scripts are kept as eval, if they fail they print their problems</span>
<span class="c"># onto the status web page</span>

<span class="k">print</span> <span class="i">STDOUT</span> <span class="q">&quot;Content-type: text/html\n\n&quot;</span><span class="sc">;</span>

<span class="c">#my $data = join( &#39;&#39;, &lt;DATA&gt; );</span>
<span class="c">#eval $data;</span>
<span class="c">#if ($@) {</span>
<span class="c">#    print $@;</span>
<span class="c">#    exit 1;</span>
<span class="c">#}</span>
<span class="c">#__END__</span>

</pre><p></p>
<h3><a name="print_yellow_dir">print_yellow_dir</a></h3>
<p>Main routine for printing the directory...</p>
<pre>
<a name="print_yellow_dir-"></a><span class="k">sub </span><span class="m">print_yellow_dir</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$document</span><span class="cm">,</span> <span class="i">$title</span><span class="cm">,</span> <span class="i">$table_lines</span><span class="cm">,</span> <span class="i">$column_headers_hash_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># starts at 1 to give headings ...</span>
    <span class="k">my</span> <span class="i">$item_counter</span>      = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_row_counter</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_counter</span>     = <span class="n">1</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$yellowdirectory_hash_ref</span><span class="cm">,</span> <span class="i">$category_hash_ref</span> <span class="s">)</span> =
      <span class="i">get_yellowpages_directory_print</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># how many records in total in the yellow pages</span>
    <span class="k">my</span> <span class="i">$total_lines</span> = <span class="k">scalar</span> <span class="k">keys</span> <span class="i">%$yellowdirectory_hash_ref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_count</span> = <span class="i">$total_lines</span> / <span class="i">$table_lines</span><span class="sc">;</span>
    <span class="i">$total_lines</span> % <span class="i">$table_lines</span> ? <span class="i">$table_count</span>++ <span class="co">:</span> <span class="i">$table_count</span><span class="sc">;</span>

    <span class="c"># write out empty table pages + page break paragraph, ready to fill</span>
    <span class="k">for</span> <span class="s">(</span> <span class="i">$x</span> = <span class="n">1</span> <span class="sc">;</span> <span class="i">$x</span> &lt;= <span class="i">$table_count</span> <span class="sc">;</span> <span class="i">$x</span>++ <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$table</span> = <span class="i">$document</span><span class="i">-&gt;appendTable</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$table_lines</span> + <span class="n">1</span> <span class="s">)</span><span class="cm">,</span> <span class="n">6</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">paragraph</span><span class="s">(</span> <span class="i">$document</span><span class="cm">,</span> <span class="i">$title</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Category&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Mobile&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Fixed&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Subject&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Description&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="q">&quot;t$x&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Price&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$yellowdirectory_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$current_table</span> = <span class="q">&#39;t&#39;</span> . <span class="i">$table_counter</span><span class="sc">;</span>

        <span class="c"># change this, to change expressed price...uses / to remain multilingual</span>
        <span class="k">my</span> <span class="i">$price_expression</span> =
<span class="q">&quot;$yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;price&#39;} $yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;tradeCurrency&#39;} \/  $yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;unit&#39;}&quot;</span><span class="sc">;</span>

        <span class="c"># category, name of category + wanted/offered</span>
        <span class="k">my</span> <span class="i">$category</span> =
<span class="q">&quot;$category_hash_ref-&gt;{$key}-&gt;{&#39;description&#39;}\:$yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;type&#39;}&quot;</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$category</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span>
            <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;userMobile&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span>
            <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;userTelephone&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span>
            <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;subject&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span>
            <span class="i">$yellowdirectory_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;description&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span>
            <span class="i">$price_expression</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># testing only</span>
        <span class="c">### $document-&gt;cellValue( $current_table, $item_counter, 5,</span>
        <span class="c">###     $yellowdirectory_hash_ref-&gt;{$key}-&gt;{&#39;sortal&#39;} );</span>

        <span class="i">$table_row_counter</span>++<span class="sc">;</span>
        <span class="i">$item_counter</span>++<span class="sc">;</span>

        <span class="c"># move to next table and reset table rows</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$table_row_counter</span> &gt; <span class="i">$table_lines</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$table_counter</span>++<span class="sc">;</span>
            <span class="i">$table_row_counter</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

<span class="s">}</span>

<a name="style-"></a><span class="k">sub </span><span class="m">style</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$document</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="i">$document</span><span class="i">-&gt;createStyle</span><span class="s">(</span>
        <span class="q">&quot;BlueStyle&quot;</span><span class="cm">,</span>
        <span class="w">parent</span>     <span class="cm">=&gt;</span> <span class="q">&#39;Text body&#39;</span><span class="cm">,</span>
        <span class="w">family</span>     <span class="cm">=&gt;</span> <span class="q">&#39;paragraph&#39;</span><span class="cm">,</span>
        <span class="w">properties</span> <span class="cm">=&gt;</span> <span class="s">{</span>
            <span class="w">area</span>       <span class="cm">=&gt;</span> <span class="q">&#39;text&#39;</span><span class="cm">,</span>
            <span class="q">&#39;fo:color&#39;</span> <span class="cm">=&gt;</span> <span class="i">rgb2oo</span><span class="s">(</span><span class="q">&#39;blue&#39;</span><span class="s">)</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<a name="paragraph-"></a><span class="k">sub </span><span class="m">paragraph</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$document</span><span class="cm">,</span> <span class="i">$text</span><span class="cm">,</span> <span class="i">$break</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$para</span> = <span class="i">$document</span><span class="i">-&gt;appendParagraph</span><span class="s">(</span>
        <span class="w">text</span>  <span class="cm">=&gt;</span> <span class="i">$text</span><span class="cm">,</span>
        <span class="i">style</span> <span class="cm">=&gt;</span> <span class="q">&quot;BlueStyle&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$document</span><span class="i">-&gt;setPageBreak</span><span class="s">(</span><span class="i">$para</span><span class="s">)</span> <span class="k">if</span> <span class="i">$break</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="comments">comments</a></h3>
<p>This is the first cut printed directory for yellowpages, part of an attempt to provide some low tech
add-ons to cclite, in the tradition of transition-style technology.</p>

<pre>
<span class="k">use</span> <span class="w">lib</span> <span class="q">&quot;../../../lib&quot;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>    <span class="c"># all this code is strict</span>
<span class="k">use</span> <span class="w">locale</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Log::Log4perl</span><span class="sc">;</span>

<span class="c">#Log::Log4perl-&gt;init( $configuration{&#39;loggerconfig&#39;} );</span>
<span class="c">#our $log = Log::Log4perl-&gt;get_logger(&quot;cclite&quot;);</span>

<span class="k">use</span> <span class="w">OpenOffice::OODoc</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccdirectory</span><span class="sc">;</span>    <span class="c"># yellow pages directory etc.</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>       <span class="c"># security and hashing</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>       <span class="c"># this probably should be delegated</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%fields</span> = <span class="i">cgiparse</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$registry</span>  = <span class="i">$$cookieref</span>{<span class="w">registry</span>} || <span class="q">&#39;dalston&#39;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$language</span>  = <span class="i">$$cookieref</span>{<span class="w">language</span>} || <span class="q">&#39;en&#39;</span><span class="sc">;</span>

<span class="c"># lines in one page of table</span>
<span class="k">my</span> <span class="i">$table_lines</span> = <span class="n">40</span><span class="sc">;</span>

<span class="c"># where to create the open-office output</span>
<span class="k">my</span> <span class="i">$output_file</span> = <span class="q">&quot;/home/hbarnard/cclite-support-files/testing/directory.odt&quot;</span><span class="sc">;</span>

<span class="c"># title of each page</span>
<span class="k">my</span> <span class="i">$title</span> = <span class="q">&quot;Yellow Pages&quot;</span><span class="sc">;</span>

<span class="c"># headings for table columns</span>
<span class="k">my</span> <span class="i">$column_headers_hash_ref</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Category&#39;</span>}    = <span class="q">&#39;Category&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Mobile&#39;</span>}      = <span class="q">&#39;Mobile&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Fixed&#39;</span>}       = <span class="q">&#39;Fixed&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Subject&#39;</span>}     = <span class="q">&#39;Subject&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Description&#39;</span>} = <span class="q">&#39;Description&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;Price&#39;</span>}       = <span class="q">&#39;Price&#39;</span><span class="sc">;</span>

<span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># write the printed document out by directory and language...</span>

<span class="k">my</span> <span class="i">$document</span> = <span class="i">odfDocument</span><span class="s">(</span>
    <span class="w">file</span>   <span class="cm">=&gt;</span> <span class="i">$output_file</span><span class="cm">,</span>
    <span class="w">create</span> <span class="cm">=&gt;</span> <span class="q">&#39;text&#39;</span>
<span class="s">)</span><span class="sc">;</span>
<span class="i">style</span><span class="s">(</span><span class="i">$document</span><span class="s">)</span><span class="sc">;</span>
<span class="i">paragraph</span><span class="s">(</span> <span class="i">$document</span><span class="cm">,</span> <span class="i">$title</span><span class="cm">,</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
<span class="i">print_yellow_dir</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$document</span><span class="cm">,</span> <span class="i">$title</span><span class="cm">,</span> <span class="i">$table_lines</span><span class="cm">,</span>
    <span class="i">$column_headers_hash_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="i">$document</span><span class="i">-&gt;save</span><span class="sc">;</span>
<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
