<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccmailgateway.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccmailgateway.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#_check_to_and_from">_check_to_and_from</a></li>
			<li><a href="#_fuzzy_ark_parse">_fuzzy_ark_parse</a></li>
			<li><a href="#mail_message_parse">mail_message_parse</a></li>
			<li><a href="#_mail_get_balance">_mail_get_balance</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccmailgateway-">package Ccmailgateway</a>
<ul>
<li><a href="#_check_to_and_from-">_check_to_and_from</a></li>
<li><a href="#_fuzzy_ark_parse-">_fuzzy_ark_parse</a></li>
<li><a href="#mail_message_parse-">mail_message_parse</a></li>
<li><a href="#_make_pretty_transaction_description-">_make_pretty_transaction_description</a></li>
<li><a href="#mail_transaction-">mail_transaction</a></li>
<li><a href="#_mail_get_balance-">_mail_get_balance</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccmailgateway.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for mail etc.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is the second generation mail transaction logic:</p>
<p>- better checking
- provides some feedback
- remote mailboxes rather than local read of mail file
- in separate module to prepare for gpg etc. etc.</p>
<p>Mail Transactions
-&gt; Confirm pin         p123456 confirm (to be done)
-&gt; Change pin          p123456 change p345678 (to be done)
-&gt; Pay                 send 5 &lt;currencyname&gt; to &lt;username&gt; at &lt;registry_name&gt; for stuff
-&gt; Query Balance       balance (to be done, like sms mailed balance transaction)</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 - 2008 GPL Licenced</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccmailgateway-"></a><span class="k">package </span><span class="i">Ccmailgateway</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="c">###use Ccsecure;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>    <span class="c"># new style configuration method</span>
<span class="c">###use Net::POP3;</span>
<span class="c">###use Net::SMTP;</span>

<span class="k">my</span> <span class="i">%configuration</span> = <span class="w">readconfiguration</span><span class="sc">;</span>
<span class="w">Log::Log4perl</span><span class="w">-&gt;init</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="q">&#39;loggerconfig&#39;</span>} <span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$log</span> = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;ccmailgateway&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(</span>
  <span class="q">mail_message_parse</span>
  <span class="q">mail_transaction</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash</p>
<pre>

=cut</pre>
<pre>
<span class="c"># changed to get language from decide_language 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="_check_to_and_from">_check_to_and_from</a></h3>
<p>Check the sender, receiver and currency exist in the registry
Also get userPublickeyid for the transaction originator so that the key
can be retrieved...</p>
<pre>
<a name="_check_to_and_from-"></a><span class="k">sub </span><span class="m">_check_to_and_from</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">###print &quot;transaction description is $transaction_description_ref-&gt;{&#39;text&#39;}\n&quot; ;</span>

    <span class="c"># this is an email address, need to escape at least @</span>
    <span class="k">my</span> <span class="i">$from</span> = <span class="k">quotemeta</span><span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;from&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span> <span class="i">$from</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>     <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span>  <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;destination&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span>      <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>         <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;name&#39;</span><span class="cm">,</span>          <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;currency&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span>          <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$error</span><span class="sc">;</span>

    <span class="c"># added test for blank from to guard against bad email parse etc..</span>
    <span class="i">$error</span> = <span class="q">&quot;$messages{&#39;unknownsender&#39;} &quot;</span>
      <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$from</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$error</span> .= <span class="q">&quot;$messages{&#39;unknownrecipient&#39;} &quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$error</span> .= <span class="q">&quot;$messages{&#39;unknowncurrency&#39;} &quot;</span>  <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

   <span class="c">#FIXME: cross registry is not allowed in batch processes at present 12/3/2010</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>} <span class="k">ne</span> <span class="i">$registry</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$error</span> .= <span class="q">&quot;$messages{&#39;nocrossregistry&#39;} &quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># one of the above lookups fails, reject the whole transaction</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> =
<span class="q">&quot;$transaction_description_ref-&gt;{&#39;from&#39;} transaction invalid: $transaction_description_ref-&gt;{&#39;error&#39;} $error&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_fuzzy_ark_parse">_fuzzy_ark_parse</a></h3>
<p>Items go two by two, I hate this but it seems more solid
than the all-at-once parser, for mail anyway...
FIXME: If you want another language you need to replace this..</p>
<pre>
<a name="_fuzzy_ark_parse-"></a><span class="k">sub </span><span class="m">_fuzzy_ark_parse</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># begin parse on whitespace</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%transaction_description</span><span class="cm">,</span> <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$found_count</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># used to count elements parsed</span>
    <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="c"># tokenise on white space...</span>
    <span class="k">my</span> <span class="i">@words</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\s+/</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># fuzzy ark parsing the terms mainly go two-by-two!</span>
    <span class="c"># count of found elements should be 5 in a valid transaction</span>

    <span class="k">my</span> <span class="i">$counter</span> = <span class="n">0</span><span class="sc">;</span>        <span class="c"># used for term lookahead</span>

    <span class="c"># this should be send, balance, confirm etc...</span>
    <span class="i">$transaction_description</span>{<span class="q">&#39;type&#39;</span>} = <span class="i">$words</span>[<span class="n">0</span>]<span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$word</span> <span class="s">(</span><span class="i">@words</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> =~ <span class="q">/^(\d+)$/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$transaction_description</span>{<span class="q">&#39;amount&#39;</span>} =
              <span class="i">$word</span><span class="sc">;</span>        <span class="c"># amount is the only numeric thing</span>
            <span class="i">$found_count</span>++<span class="sc">;</span>
            <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
              <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>    <span class="c"># currency is next to quantity</span>

<span class="c"># make singular for english language currencies dallies = dally, limes = lime...</span>
            <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =~ <span class="q">s/ies$/y/i</span><span class="sc">;</span>
            <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =~ <span class="q">s/s$//i</span><span class="sc">;</span>

            <span class="i">$found_count</span>++
              <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> <span class="k">eq</span> <span class="q">&quot;to&quot;</span> <span class="s">)</span> <span class="s">{</span>               <span class="c"># found &#39;to&#39;</span>
            <span class="i">$transaction_description</span>{<span class="q">&#39;destination&#39;</span>} =
              <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>    <span class="c"># touser is next</span>
            <span class="i">$found_count</span>++
              <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description</span>{<span class="q">&#39;destination&#39;</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> <span class="k">eq</span> <span class="q">&quot;at&quot;</span> <span class="s">)</span> <span class="s">{</span>               <span class="c"># found &#39;at&#39;</span>
            <span class="i">$transaction_description</span>{<span class="q">&#39;registry&#39;</span>} =
              <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>    <span class="c"># toregistry is next</span>
            <span class="i">$found_count</span>++
              <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>
        <span class="i">$counter</span>++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$input</span> =~ <span class="q">/for\s+(\w.*)$/i</span><span class="sc">;</span>              <span class="c"># description is everything at end</span>
         <span class="c"># look up sending user, receiving user and currency</span>
    <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
    <span class="i">$found_count</span>++ <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$found_count</span><span class="cm">,</span> \<span class="i">%transaction_description</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="mail_message_parse">mail_message_parse</a></h3>
<p>This is parse, validation both for mail and jabber, needs a new name perhaps
Will only do 'send' and 'balance' at the moment. This whole area probably
needs merging with SMS and smart phone widgets too...</p>
<pre>
<a name="mail_message_parse-"></a><span class="k">sub </span><span class="m">mail_message_parse</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$from</span><span class="cm">,</span> <span class="i">$to</span><span class="cm">,</span> <span class="i">$subject</span><span class="cm">,</span> <span class="i">$text</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># &#39;$to&#39; here is the registry batch email address, not the destination user!</span>
    <span class="c"># send 4 duckets to unknown at dalston for barking lessons</span>

    <span class="k">my</span> <span class="i">$parse_type</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span><span class="cm">,</span> <span class="i">$error_message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> = <span class="i">_fuzzy_ark_parse</span><span class="s">(</span><span class="i">$text</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#FIXME: this quoting needs to go down into the db layer...</span>
    <span class="c"># necessary for mail but not for jabber?</span>
    <span class="k">my</span> <span class="i">$quote_from</span> = <span class="k">quotemeta</span><span class="s">(</span><span class="i">$from</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>      <span class="i">$registry</span><span class="cm">,</span>   <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span> <span class="i">$quote_from</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>     <span class="q">&#39;&#39;</span><span class="cm">,</span>
        <span class="q">&#39;&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;userPublickeyid&#39;</span>} =
      <span class="i">$fromuserref</span>-&gt;{<span class="q">&#39;userPublickeyid&#39;</span>}<span class="sc">;</span>
    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;source&#39;</span>} = <span class="i">$fromuserref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>
    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;name&#39;</span>}   = <span class="i">$fromuserref</span>-&gt;{<span class="q">&#39;userName&#39;</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;send&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;text&#39;</span>} =
          <span class="i">_make_pretty_transaction_description</span><span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># need this later to deduce the payer...</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;from&#39;</span>}  = <span class="i">$from</span><span class="sc">;</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;title&#39;</span>} = <span class="i">$subject</span><span class="sc">;</span>

<span class="c"># check currency, registry and destination are OK, if not cumulate with errors</span>
<span class="c"># deduce tradeSource using &#39;from&#39; email, get public key id from originator record</span>

        <span class="s">(</span>

            <span class="i">$error_message</span> <span class="s">)</span> =
          <span class="i">_check_to_and_from</span><span class="s">(</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$text</span> = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;text&#39;</span>}<span class="sc">;</span>

        <span class="c"># there must be at least 4 components in a send message</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;error&#39;</span>} .=
          <span class="i">$messages</span>{<span class="q">&#39;incompletetransaction&#39;</span>}
          <span class="k">if</span> <span class="s">(</span> <span class="i">$count</span> &lt; <span class="n">4</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>

<span class="c"># FIXME: probably needs regression testing with non-encrpyted...</span>
<span class="c"># FIXME: no reason not to parse/allow multiregistry query via &#39;balance &lt;registryname&gt;&#39;</span>

        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

        <span class="c"># this is a balance request...</span>

        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;text&#39;</span>} =
          <span class="i">_mail_get_balance</span><span class="s">(</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$quote_from</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;currency&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;error&#39;</span>} =
          <span class="q">&quot;$messages{&#39;incompletetransaction&#39;}: $text&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;error&#39;</span>} .= <span class="i">$error_message</span>
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error_message</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<a name="_make_pretty_transaction_description-"></a><span class="k">sub </span><span class="m">_make_pretty_transaction_description</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pretty_description</span><span class="sc">;</span>

    <span class="c"># this is the description for the email...</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$transaction_description_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pretty_description</span> .= <span class="q">&quot;$key: $$transaction_description_ref{$key}\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$pretty_description</span><span class="sc">;</span>
<span class="s">}</span>

<a name="mail_transaction-"></a><span class="k">sub </span><span class="m">mail_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="sc">;</span>

    <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
    <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>            <span class="c"># no home, not a web transaction</span>
                                             <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;amount&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeStatus : default taken from configuration</span>
    <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$configuration</span>{<span class="q">&#39;initialpaymentstatus&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeCurrency : ducket</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;currency&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;title&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDescription : added by this routine</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} =
      <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} =
      <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;destination&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeItem : test to see variables</span>
    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;source&#39;</span>}<span class="sc">;</span>

    <span class="c"># remove html from response, this is not true csv though..</span>

    <span class="i">$transaction</span>{<span class="w">mode</span>} = <span class="q">&#39;csv&#39;</span><span class="sc">;</span>

    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$pages</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;mail&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="q">&quot;$output_message\n $transaction_description_ref-&gt;{&#39;text&#39;}&quot;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_mail_get_balance">_mail_get_balance</a></h3>
<p>FIXME: duplicate in Ccsmsgateway and needed for jabber
Send balance, via email at present, sms later...
To be done...</p>

<pre>
<a name="_mail_get_balance-"></a><span class="k">sub </span><span class="m">_mail_get_balance</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$quote_from</span><span class="cm">,</span> <span class="i">$currency</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>     <span class="i">$registry</span><span class="cm">,</span>   <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span> <span class="i">$quote_from</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>     <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%fields</span> = <span class="s">(</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$fromuserref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

    <span class="c"># html to return html, values to return raw balances and volumes</span>
    <span class="c"># for each currency</span>
    <span class="s">(</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span> =
      <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$fromuserref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;values&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># current balance for this particular currency</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currency</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$curr</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$balance_ref</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$message</span> .= <span class="q">&quot;$curr= $balance_ref-&gt;{$curr}\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$message</span> .= <span class="q">&quot;$currency = $balance_ref-&gt;{$currency}\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
