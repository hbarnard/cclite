<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Sat Apr 28 18:03:33 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>read_pop_mail.pl</title>
<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
</head>
<body>
<a name="-top-"></a>
<h1>read_pop_mail.pl</h1>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#__END__-">__END__</a></li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->
<hr />
<!-- contents of filename: read_pop_mail.pl -->
<pre>
#!/usr/bin/perl

<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS</span>
<span class="c">#OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,</span>
<span class="c">#OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,</span>
<span class="c">#ANY IMPLIED WARRANTIES OF MERCHANTABILITY,</span>
<span class="c">#FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.</span>
<span class="c">#WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,</span>
<span class="c">#INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,</span>
<span class="c">#INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,</span>
<span class="c">#LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,</span>
<span class="c">#REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER</span>
<span class="c">#WHICH THE LIABILITY MAY BE ASSERTED,</span>
<span class="c">#EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.</span>
<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#</span>
<span class="c"># these batch scripts are kept as eval, if they fail they print their problems</span>
<span class="c"># onto the status web page</span>

<span class="k">print</span> <span class="i">STDOUT</span> <span class="q">&quot;Content-type: text/html\n\n&quot;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$data</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&lt;DATA&gt;</span> <span class="s">)</span><span class="sc">;</span>
<span class="k">eval</span> <span class="i">$data</span><span class="sc">;</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="i">$@</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>
<a name="__END__-"></a><span class="k">__END__</span>


<span class="q"># --- start of main script ---#</span>

<span class="q">use strict;</span>
<span class="q">use Net::POP3;</span>

<span class="q">use lib &#39;../../../lib&#39;;</span>

<span class="q">use Ccconfiguration;</span>
<span class="q">use Ccmailgateway;</span>
<span class="q">use Cclitedb;</span>
<span class="q">use Cclite ;</span>
<span class="q">use Ccinterfaces;</span>
<span class="q">use Cccookie;</span>
<span class="q">use Ccu;</span>
<span class="q">use Ccsecure ;</span>

<span class="q">BEGIN {</span>
<span class="q">    use CGI::Carp qw(fatalsToBrowser set_message);</span>
<span class="q">    set_message(</span>
<span class="q">&quot;Please use the &lt;a title=\&quot;cclite google group\&quot; href=\&quot;http://groups.google.co.uk/group/cclite\&quot;&gt;Cclite Google Group&lt;/a&gt; for help, if necessary&quot;</span>
<span class="q">    );</span>

<span class="q">}</span>

<span class="q">my %configuration = readconfiguration();</span>
<span class="q"># message language now decided by decide_language, within readmessages 08/2011</span>
<span class="q">our %messages = readmessages();</span>

<span class="q"># for cron, replace these with hardcoded registry name and removed is_admin test</span>
<span class="q">my $hardcoded_registry  = &#39;&#39; ;</span>

<span class="q">my %fields = cgiparse();</span>
<span class="q">my $cookieref = get_cookie();</span>
<span class="q">my $registry  = $hardcoded_registry || $$cookieref{registry};</span>

<span class="q">#FIXME: needs slightly higher barrier than this...</span>

<span class="q">if (!length($registry) ) {</span>
<span class="q">	print &#39;no registry defined&#39; ;</span>
<span class="q">	exit 0 ;	</span>
	
<span class="q">}	</span>

<span class="q">if (! is_admin) {</span>
<span class="q">	print &quot;Content-type: text/html\n\n&quot;;</span>
<span class="q">	print $messages{&#39;notadmin&#39;} ;</span>
<span class="q">	exit 0 ;</span>
<span class="q">}</span>


<span class="q"># read the current registry to pick up per-registry email values</span>
<span class="q">my ($class,$token) ;</span>
<span class="q">my ( $error, $registryref ) =</span>
<span class="q">  get_where( $class, $registry, &#39;om_registry&#39;,&#39;*&#39;, &#39;name&#39;, $registry, $token, &#39;&#39;,</span>
<span class="q">    &#39;&#39; );</span>
    
<span class="q">if (length($error) ) {</span>
<span class="q">    log_entry($class, $registry,&quot;database error for $registry: $error&quot;,$token) ;</span>
<span class="q">    exit 0 ;</span>
<span class="q">}       </span>
    

<span class="q"># message language now decided by decide_language 08/2011    </span>
<span class="q">our %messages = readmessages();</span>

<span class="q">my $username = $registryref-&gt;{postemail};</span>
<span class="q">my $password = $registryref-&gt;{postpass};</span>
<span class="q">my $host     = $username;</span>
<span class="q">my $count = 0 ;</span>

<span class="q"># get the domain part as postbox...</span>
<span class="q">$host =~ s/^(.*?)\@(.*)$/$2/;</span>

<span class="q">my $pop = Net::POP3-&gt;new( $host, Timeout =&gt; 60, Debug =&gt; 0 );</span>

<span class="q">if ( $pop-&gt;login( $username, $password ) &gt; 0 ) {</span>
  
<span class="q">    my $msgnums = $pop-&gt;list;    # hashref of msgnum =&gt; size</span>
<span class="q">    foreach my $msgnum ( keys %$msgnums ) {</span>
<span class="q">        my $msg = $pop-&gt;get($msgnum);</span>
<span class="q">        my ( $from, $to, $subject, $parse_type, $transaction_description_ref ) ;</span>
<span class="q">        # make a message object</span>
<span class="q">        my $output_message;</span>
<span class="q">        foreach my $part (@$msg) {</span>
            
<span class="q">            if ( $part =~ /From:\s.*?\W([\.-\w]+@([-\w]+\.)+[A-Za-z]{2,4})\W/ )</span>
<span class="q">            {</span>
<span class="q">                $from = $1; </span>

<span class="q">            } elsif ( $part =~ /To:\s.*?\W([^@]+@([-\w]+\.)+[A-Za-z]{2,4})\W/ )</span>
<span class="q">            {</span>
<span class="q">                $to = $1;</span>

<span class="q"># want the send line but not twice if multipart/alternate, so reject if html fragments</span>
<span class="q">            } elsif ( $part =~ /(send.*?)/i &amp;&amp; $part !~ /\&lt;/ ) {</span>
            
<span class="q">                ( $parse_type, $transaction_description_ref ) =</span>
<span class="q">                  mail_message_parse( &#39;local&#39;, $registry, $from, $to, $subject, $part );</span>

                
<span class="q">                # add &#39;via email&#39; literal to description of transaction</span>
<span class="q">                $transaction_description_ref-&gt;{&#39;description&#39;}  = &quot;$messages{&#39;viaemail&#39;} &quot; . $transaction_description_ref-&gt;{&#39;description&#39;} ;</span>
    
<span class="q">                if ( !length( $transaction_description_ref-&gt;{error} ) ) {</span>
<span class="q">                    $output_message =</span>
<span class="q">                      mail_transaction($transaction_description_ref);</span>

<span class="q">                } else {</span>
<span class="q">                    $output_message = $transaction_description_ref-&gt;{error};</span>
<span class="q">                }  # endif parsed body of message</span>

<span class="q">             } elsif ( $part =~ /Subject:\s+(\S.*)/ ) {</span>

<span class="q">                $subject = $1;</span>

<span class="q">            } #endif for message parse</span>
            
<span class="q">        }  # end foreach of message parse all bits consumed</span>
<span class="q">          my ($accountname, $smtp) ;</span>
<span class="q">          notify_by_mail( &#39;local&#39;, $registry, $transaction_description_ref-&gt;{name},</span>
<span class="q">                          $transaction_description_ref-&gt;{from}, $transaction_description_ref-&gt;{from}, $transaction_description_ref-&gt;{from},</span>
<span class="q">                          $transaction_description_ref-&gt;{source}, $smtp, &#39;&#39;,</span>
<span class="q">                          $output_message, 5,&#39;&#39; );</span>
                          
<span class="q">            # reference to the current signature for notify...</span>
<span class="q">            # $class,       $registry,         $name,</span>
<span class="q">            # $email,       $systemfrom,       $return_address,</span>
<span class="q">            # $accountname, $smtp,             $urlstring,</span>
<span class="q">            # $text,        $notificationtype, $hash</span>
<span class="q">           $count++ ;         </span>
<span class="q">           $pop-&gt;delete($msgnum);</span>
<span class="q">        } #end foreach of all messages</span>
<span class="q">    } # endif pop login</span>

<span class="q">    $pop-&gt;quit;</span>
    
<span class="q">    # print into management status area, if at least one message was processed...</span>
<span class="q">    print &quot;processed $count transactions&quot; if ($count &gt; 0);</span>
<span class="q">exit 0 ;</span>

<a name="EOF-"></a></pre>
</body>
</html>
