<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>ccinstall.cgi</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>ccinstall.cgi</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">description</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#readconfiguration">readconfiguration</a></li>
			<li><a href="#get_os_and_distribution">get_os_and_distribution</a></li>
			<li><a href="#_format_base_directory">_format_base_directory</a></li>
			<li><a href="#write_log_config">write_log_config</a></li>
			<li><a href="#show_problems">show_problems</a></li>
			<li><a href="#check_template_path">check_template_path</a></li>
			<li><a href="#test_sha">test_sha</a></li>
			<li><a href="#test_dbi">test_dbi</a></li>
			<li><a href="#test_log">test_log</a></li>
			<li><a href="#check_log_path">check_log_path</a></li>
			<li><a href="#check_paths">check_paths</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#readconfiguration-">package main</a>
<ul>
<li><a href="#readconfiguration-">readconfiguration</a></li>
<li><a href="#get_os_and_distribution-">get_os_and_distribution</a></li>
<li><a href="#_format_base_directory-">_format_base_directory</a></li>
<li><a href="#write_log_config-">write_log_config</a></li>
<li><a href="#show_problems-">show_problems</a></li>
<li><a href="#check_template_path-">check_template_path</a></li>
<li><a href="#test_sha-">test_sha</a></li>
<li><a href="#test_dbi-">test_dbi</a></li>
<li><a href="#test_log-">test_log</a></li>
<li><a href="#check_log_path-">check_log_path</a></li>
<li><a href="#check_paths-">check_paths</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>#!/usr/bin/perl -w

<span class="k">my</span> <span class="i">$test</span> = <span class="n">0</span><span class="sc">;</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$test</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="i">STDOUT</span> <span class="q">&quot;Content-Type: text/html; charset=utf-8\n\n&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&lt;DATA&gt;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">eval</span> <span class="i">$data</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;&lt;H1&gt;Syntax  error!&lt;/H1&gt;\n&lt;PRE&gt;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;&lt;/PRE&gt;\n&quot;</span><span class="sc">;</span>
        <span class="k">exit</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>
<span class="c">###__END__</span>

</pre><p></p>
<hr />
<h1><a name="name">NAME</a></h1>
<p>ccinstall.cgi</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>autonomous web installer for cclite</p>
<p>
</p>
<hr />
<h1><a name="description">description</a></h1>
<p>This is a web installer for the cclite configuration file. It makes
a guess at the directory and domain values and provides these as web page.
It, obviously, can't guess database passwords etc.</p>
<p>It will also check mysql for compatibility with cclite.</p>
<p>---------------------------------------------------------------------------
 THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS
 OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,
 OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,
 ANY IMPLIED WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.
 WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,
 INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,
 INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,
 LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,
 REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER
 WHICH THE LIABILITY MAY BE ASSERTED,
 EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.
---------------------------------------------------------------------------</p>
<p>You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</p>
<p>Package types:</p>
<p>0 Generic tarball/generic install [Fedora]
1 Windows
2 Debian/Ubuntu via package
3 Debian/Ubuntu unpackaged</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<pre>
 cclite.cgi
 ccadmin.cgi</pre>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005-2007 GPL Licenced</p>
<p>
</p>
<h3><a name="readconfiguration">readconfiguration</a></h3>
<p>Read the configuration data and return a hash,
normally this routine now exist only in Ccconfiguration.pm
but the install is a 'special case'</p>
<p>Skip comments marked with #
cgi parameters will override configuration file
information, always!</p>
<pre>
<a name="readconfiguration-"></a><span class="k">sub </span><span class="m">readconfiguration</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">$os</span> = <span class="i">$^O</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$dir</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$default_config</span><span class="sc">;</span>

    <span class="c"># if it&#39;s windows use cd to find the directory</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> =~ <span class="q">/^ms/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`cd`</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`pwd`</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># make an informed guess at the config file not explictly supplied</span>
    <span class="i">$dir</span> =~ <span class="q">s/\bcgi-bin.*//</span><span class="sc">;</span>
    <span class="i">$default_config</span> = <span class="q">&quot;${dir}config/cclite.cf&quot;</span><span class="sc">;</span>
    <span class="i">$default_config</span> =~ <span class="q">s/\s//g</span><span class="sc">;</span>

    <span class="c"># either supply it explicitly with full path or it will guess..</span>
    <span class="k">my</span> <span class="i">$configfile</span> = <span class="i">$_</span>[<span class="n">0</span>] || <span class="i">$default_config</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$configfile</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="w">CONFIG</span><span class="cm">,</span> <span class="i">$configfile</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">while</span> <span class="s">(</span><span class="q">&lt;CONFIG&gt;</span><span class="s">)</span> <span class="s">{</span>
            <span class="q">s/\s$//g</span><span class="sc">;</span>
            <span class="k">next</span> <span class="k">if</span> <span class="q">/^#/</span><span class="sc">;</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$value</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\=/</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$value</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$key</span> =~ <span class="k">lc</span><span class="s">(</span><span class="i">$key</span><span class="s">)</span><span class="sc">;</span>    <span class="c">#- make key canonic, all lower</span>
                <span class="i">$configuration</span>{<span class="i">$key</span>} = <span class="i">$value</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">undef</span> <span class="i">$key</span><span class="sc">;</span>
            <span class="k">undef</span> <span class="i">$value</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$configuration</span>{<span class="w">error</span>} = <span class="q">&quot;no configuration file found at $configfile&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="i">%configuration</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_os_and_distribution">get_os_and_distribution</a></h3>
<p>FIXME: Duplicated in Ccu.pm</p>
<p>Now that the package is widening in application
Need a little precision about the platform
This is not infallible, btw...</p>
<p>If the package flag is set, then the supplied default
configuration should work...</p>
<p>package types
0 unpackaged *nix
1 windows
2 debian
3 probable cpanel guessed via public html</p>
<pre>
<a name="get_os_and_distribution-"></a><span class="k">sub </span><span class="m">get_os_and_distribution</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$checkdir</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$package_type</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># 0 is unpackaged *nix, default tarball</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$^O</span> =~ <span class="q">/^ms/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$os</span>           = <span class="q">&#39;windows&#39;</span><span class="sc">;</span>
        <span class="i">$package_type</span> = <span class="n">1</span><span class="sc">;</span>           <span class="c"># 1 is windows</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$^O</span> =~ <span class="q">/^linux/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$os</span> = <span class="q">&#39;linux&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$^O</span> =~ <span class="q">/^openbsd/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$os</span> = <span class="q">&#39;openbsd&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$os</span> = <span class="q">&#39;nocurrentsupport&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># try and find out distribution - changed to lsb_release -a march 2017</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;linux&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$dist_string</span> = <span class="q">`lsb_release -a`</span><span class="sc">;</span>
        <span class="i">$dist_string</span> =~ <span class="q">m/(fedora|ubuntu|debian|red hat)/i</span><span class="sc">;</span>
        <span class="i">$distribution</span> = <span class="k">lc</span><span class="s">(</span><span class="i">$1</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># if ubuntu or debian, test whether packaged by looking</span>
    <span class="c"># in /usr/share/cclite</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$distribution</span> <span class="k">eq</span> <span class="q">&#39;ubuntu&#39;</span> || <span class="i">$distribution</span> <span class="k">eq</span> <span class="q">&#39;debian&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$checkdir</span> = <span class="q">&#39;/usr/share/cclite&#39;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$checkdir</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$package_type</span> = <span class="n">2</span><span class="sc">;</span>    <span class="c"># 2 is debian and derivatives</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$package_type</span> = <span class="n">3</span><span class="sc">;</span>    <span class="c"># debian/ubuntu but unpackaged</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># guessing at cpanel because the whole thing is under the document root</span>
    <span class="k">my</span> <span class="i">$path</span> = <span class="q">`pwd`</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;linux&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$path</span> =~ <span class="q">/public_html/i</span> &amp;&amp; <span class="i">$os</span> <span class="k">eq</span> <span class="q">&#39;linux&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$cpanel</span> =
          <span class="q">`/usr/local/cpanel/cpanel -V`</span><span class="sc">;</span>    <span class="c"># better test for cpanel 07/2012</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$cpanel</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$distribution</span> .= <span class="q">&#39; cpanel&#39;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$distribution</span> .= <span class="i">$sys_message</span>{<span class="q">&#39;probably&#39;</span>} . <span class="q">&#39; cpanel&#39;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_format_base_directory">_format_base_directory</a></h3>
<p>Internal routine, avoid ugly code repetition</p>
<pre>
<a name="_format_base_directory-"></a><span class="k">sub </span><span class="m">_format_base_directory</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$base_directory</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">chomp</span> <span class="i">$base_directory</span><span class="sc">;</span>
    <span class="i">$base_directory</span> =~ <span class="q">s/\s+$//</span><span class="sc">;</span>           <span class="c"># if cgi called</span>
    <span class="i">$base_directory</span> =~ <span class="q">s/\/cgi-bin.*$//</span><span class="sc">;</span>
    <span class="i">$libpath</span> = <span class="q">&quot;$base_directory/lib&quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$base_directory</span><span class="cm">,</span> <span class="i">$libpath</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="write_log_config">write_log_config</a></h3>
<p>Write the logging configuration file</p>
<pre>
<a name="write_log_config-"></a><span class="k">sub </span><span class="m">write_log_config</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$dir</span><span class="cm">,</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log_config</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log_base</span> = <span class="q">&#39;var/cclite/log&#39;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span><span class="sc">;</span>

    <span class="c"># default case...</span>
    <span class="k">my</span> <span class="i">$log_file</span> = <span class="q">&quot;$dir/$log_base/cclite.log&quot;</span><span class="sc">;</span>

    <span class="c"># non-standard debian/ubuntu, especially home/username/cclite</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$package_type</span> == <span class="n">3</span> &amp;&amp; <span class="i">$dir</span> =~ <span class="q">/home/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">@components</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\//</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$log_file</span> =
          <span class="q">&quot;/$components[1]/$components[2]/$components[3]/$log_base/cclite.log&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">-w</span> <span class="i">$log_file</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$error</span> .=
<span class="q">&quot;can&#39;t write:&lt;br/&gt;&lt;pre&gt; $log_file &lt;/pre&gt; &lt;br/&gt;Please change permissions to web cgi user&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">eval</span> <span class="s">{</span> <span class="q">`touch $log_file`</span><span class="sc">;</span> <span class="s">}</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$error</span> .= <span class="i">$@</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="show_problems">show_problems</a></h3>
<p>Print out detected problems for the install
This has html, since maybe the templates haven't
been found at this stage...</p>
<pre>
<a name="show_problems-"></a><span class="k">sub </span><span class="m">show_problems</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span><span class="cm">,</span> <span class="i">$login</span><span class="cm">,</span> <span class="i">@messages</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$errors</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&quot;</span><span class="cm">,</span> <span class="i">@messages</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">print</span> <span class="q">&quot;Content-Type: text/html; charset=utf-8\n\n&quot;</span><span class="sc">;</span>
    <span class="k">print</span> <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">     &lt;html&gt;</span>
<span class="hh">      &lt;head&gt;</span>
<span class="hh">      &lt;link type=&quot;text/css&quot; href=&quot;/styles/cc.css&quot; rel=&quot;stylesheet&quot;&gt;</span>
<span class="hh">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/styles/print.css&quot; media=&quot;print&quot; /&gt;</span>

<span class="hh">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/javascript/jquery-autocomplete/jquery.autocomplete.css&quot; /&gt;</span>
<span class="hh">&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/javascript/jquery-autocomplete/lib/thickbox.css&quot; /&gt;</span>

<span class="hh">&lt;title&gt;Cclite 0.9.4 Installer: Problems&lt;/title&gt;</span>



<span class="hh">&lt;script src=&quot;/javascript/jquery-1.3.2.js&quot;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script type=&#39;text/javascript&#39; src=&#39;/javascript/jquery-tooltip/jquery.qtip-1.0.0-rc3.min.js&#39;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script src=&quot;/javascript/jquery-validation-1.5.5.js&quot;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script src=&quot;/javascript/jquery-cookies.js&quot;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script type=&#39;text/javascript&#39; src=&#39;/javascript/jquery-autocomplete/lib/jquery.bgiframe.min.js&#39;&gt;&lt;/script&gt;</span>

<span class="hh">&lt;script type=&#39;text/javascript&#39; src=&#39;/javascript/jquery-autocomplete/lib/jquery.ajaxQueue.js&#39;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script type=&#39;text/javascript&#39; src=&#39;/javascript/jquery-autocomplete/lib/thickbox-compressed.js&#39;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script type=&#39;text/javascript&#39; src=&#39;/javascript/jquery-autocomplete/jquery.autocomplete.js&#39;&gt;&lt;/script&gt;</span>

<span class="hh">&lt;script src=&quot;/javascript/cookies.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</span>

<span class="hh">&lt;script src=&quot;/javascript/striper.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</span>
<span class="hh">&lt;script src=&quot;/javascript/cclite.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</span>

<span class="hh"> &lt;title&gt;Cclite Installer Errors for $os type $distribution&lt;/title&gt;</span>


<span class="hh">      &lt;/head&gt;</span>
<span class="hh">      &lt;body&gt;</span>
<span class="hh">      &lt;h3&gt;Cclite Installer Errors for $os $distribution running as $login&lt;/h3&gt;</span>
<span class="hh">      &lt;h3&gt;Package type guessed as $package_type&lt;/h3&gt;</span>
<span class="hh">      &lt;table width=&quot;50%&quot;&gt;&lt;tr&gt;&lt;td&gt;$errors&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
<span class="hh">      &lt;br/&gt;&lt;br/&gt;</span>
<span class="hh">      &lt;a href=&quot;http://groups.google.co.uk/group/cclite&quot;&gt;Ask for Help at the Cclite Group&lt;/a&gt;</span>
<span class="hh">      &lt;/body&gt;</span>
<span class="hh">     &lt;/html&gt;</span>
<span class="h">EOT</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="check_template_path">check_template_path</a></h3>
<p>test whether the template path is present and readable</p>
<pre>
<a name="check_template_path-"></a><span class="k">sub </span><span class="m">check_template_path</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$basedir</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$templates</span> = <span class="q">&quot;$basedir/templates&quot;</span><span class="sc">;</span>

    <span class="c"># can&#39;t find templates</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$templates</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    &lt;table&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td&gt;        </span>
<span class="hh">&lt;h5&gt;Error 4:Ccinstall: Cclite installer&lt;/h5&gt;</span>
<span class="hh">Can&#39;t find template directory: $templates</span>
<span class="hh">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
<span class="hh">&lt;br/&gt;&lt;br/&gt;</span>
<span class="hh">Please fix this manually</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="test_sha">test_sha</a></h3>
<p>Test whether digest module is present, otherwise whinge...
Logic rationalised somewhat 1/2009
FIXME: Needs test in test suite</p>
<pre>
<a name="test_sha-"></a><span class="k">sub </span><span class="m">test_sha</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">$type</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>

    <span class="k">eval</span> <span class="s">{</span> <span class="k">require</span> <span class="w">Digest::SHA</span> <span class="s">}</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> != <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    &lt;table&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td&gt;</span>
<span class="hh"> &lt;h5&gt;Error 1:Ccinstall: Cclite installer&lt;/h5&gt;</span>
<span class="hh"> $@</span>
<span class="hh"> &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
<span class="hh"> &lt;br/&gt;</span>
<span class="hh"> Can&#39;t find Digest::SHA </span>
<span class="hh"> Please use perl -MCPAN -e shell or other tool to install</span>
<span class="h">EOT</span>
            <span class="k">undef</span> <span class="i">$type</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

            <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    &lt;table&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td&gt;</span>
<span class="hh"> &lt;h5&gt;Error 1:Ccinstall: Cclite installer&lt;/h5&gt;</span>
<span class="hh"> $@</span>
<span class="hh"> &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
<span class="hh"> &lt;br/&gt;</span>
<span class="hh"> Can&#39;t find Digest::SHA </span>
<span class="hh"> Please use perl -MCPAN -e shell or apt-get libdigest-sha-perl</span>
<span class="hh"> For older releases &lt; 12.04, ask for help</span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$type</span> = <span class="q">&quot;sha2&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$type</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="test_dbi">test_dbi</a></h3>
<p>test whether digest module is present, otherwise whinge...</p>
<pre>
<a name="test_dbi-"></a><span class="k">sub </span><span class="m">test_dbi</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
    <span class="k">eval</span> <span class="s">{</span> <span class="k">require</span> <span class="w">DBI</span> <span class="s">}</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    &lt;table&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td&gt;</span>
<span class="hh"> &lt;h5&gt;Error 2:Ccinstall: Cclite installer&lt;/h5&gt;</span>
<span class="hh"> $@</span>
<span class="hh"> &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</span>
<span class="hh"> &lt;br/&gt;&lt;br/&gt;</span>
<span class="hh"> Please fix manually</span>
<span class="hh"> Please use perl -MCPAN -e shell or other tool to install</span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="test_log">test_log</a></h3>
<p>test whether Log4perl module is present, otherwise whinge...
Now deprecated, since Log4perl isn't required 03/2012</p>
<pre>
<a name="test_log-"></a><span class="k">sub </span><span class="m">test_log</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
    <span class="k">eval</span> <span class="s">{</span> <span class="k">require</span> <span class="w">Log::Log4perl</span> <span class="s">}</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;h5&gt;Error 3:Ccinstall: Cclite installer&lt;/h5&gt;</span>
<span class="hh"> $@ </span>
<span class="hh"> &lt;br/&gt;</span>
<span class="hh"> Please fix manually</span>
<span class="hh"> Please use perl -MCPAN -e shell or other tool to install</span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$message</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="check_log_path">check_log_path</a></h3>
<p>test whether the log path is present and writable
on Fedora/Redhat and commodity hosting this is often of form:</p>
<p>/home/&lt;domain&gt;/var/cclite/log/cclite.log
/home/&lt;domain&gt;/domains/&lt;subdomain&gt;/var/cclite/log/cclite.log</p>
<p>Dead code now, as of 2012, no it's not apparently Jan 2013</p>
<pre>
<a name="check_log_path-"></a><span class="k">sub </span><span class="m">check_log_path</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$dir</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$log_path</span> = <span class="q">&quot;$dir/var/cclite/log&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$found</span>    = <span class="n">0</span><span class="sc">;</span>                       <span class="c">#find the path flag</span>
    <span class="k">my</span> <span class="i">$message</span>  = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    &lt;table&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td&gt;</span>
<span class="hh">&lt;h5&gt;Error 5:Ccinstall: Cclite installer&lt;/h5&gt;</span>
<span class="hh">Can&#39;t find or write to the log directory: $log_path</span>
<span class="hh">does not exist or unreadable (needs chmod o+w, for example)?</span>
<span class="hh">The owner should be the web server or virtual server user</span>
<span class="hh">&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;br/&gt;&lt;br/&gt;</span>
<span class="hh">Please fix this manually</span>
<span class="h">EOT</span>

    <span class="c">#FIXME: remove double slash in some log paths</span>
    <span class="i">$log_path</span> =~ <span class="q">s/\/\//\//</span><span class="sc">;</span>

    <span class="c"># find this log directory and am able to write to it</span>
    <span class="c"># second test added for redhat etc. Jan 2014</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$log_path</span> &amp;&amp; <span class="k">-w</span> <span class="i">$log_path</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$log_path</span> = <span class="q">&#39;/var/cclite/log&#39;</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$log_path</span> &amp;&amp; <span class="k">-w</span> <span class="i">$log_path</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># log path no found, so error message</span>
    <span class="k">return</span> <span class="i">$message</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$found</span> == <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="check_paths">check_paths</a></h3>
<p>Checks that the path to the cclite libraries
exists and is readable. Returns message, if not.</p>
<p>Amended 10.2009 to force libpath and base directory for testing
and general extra flexibility</p>
<p>Amended 7.2010 to simplify and deal with debian non-package install</p>

<pre>
<a name="check_paths-"></a><span class="k">sub </span><span class="m">check_paths</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$package_type</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$libpath</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$os</span> = <span class="i">$^O</span><span class="sc">;</span>

    <span class="c"># if it&#39;s windows use cd to find the directory</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> =~ <span class="q">/^ms/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`cd`</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="i">getcwd</span><span class="s">(</span><span class="s">)</span> || <span class="q">`pwd`</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">chomp</span> <span class="i">$dir</span><span class="sc">;</span>
    <span class="i">$dir</span> =~ <span class="q">s/\bcgi-bin.*//</span><span class="sc">;</span>

    <span class="c"># in standard place, so package is -very probably- being used</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$dir</span> =~ <span class="q">/^\/usr/</span> &amp;&amp; <span class="i">$package_type</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$dir</span> = <span class="q">&#39;/usr/share/cclite&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

 <span class="c"># but, if not in standard place, for example in /home, path is preserved 7/2010</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$dir</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;h5&gt;Error  in ccintall::check_paths&lt;/h5&gt;</span>
<span class="hh"> Can&#39;t find base dir $dir  does not exist or unreadable?</span>
<span class="hh"> Please fix manually</span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="c">###print &quot;os is $os, dir is $dir, package type is $package_type&quot; ;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$dir</span><span class="cm">,</span> <span class="q">&quot;${dir}lib&quot;</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#===================================================================</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">locale</span><span class="sc">;</span>

<span class="k">my</span> <span class="s">(</span>
    <span class="i">%configuration</span><span class="cm">,</span>  <span class="i">%sms_configuration</span><span class="cm">,</span> <span class="i">$libpath</span><span class="cm">,</span>
    <span class="i">$dir</span><span class="cm">,</span>            <span class="i">@messages</span><span class="cm">,</span>          <span class="i">$os</span><span class="cm">,</span>
    <span class="i">$distribution</span><span class="cm">,</span>   <span class="i">$log_config</span><span class="cm">,</span>        <span class="i">$login</span><span class="cm">,</span>
    <span class="i">$package_type</span><span class="cm">,</span>   <span class="i">$newinstall</span><span class="cm">,</span>        <span class="i">$new_sms_install</span><span class="cm">,</span>
    <span class="i">$default_config</span><span class="cm">,</span> <span class="i">$default_sms_config</span><span class="cm">,</span>
<span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$hash_type</span><span class="sc">;</span>    <span class="c"># contains the hash type used for hashing</span>

<span class="k">BEGIN</span> <span class="s">{</span>
    <span class="k">use</span> <span class="w">lib</span> <span class="q">&#39;../../lib&#39;</span><span class="sc">;</span>
    <span class="k">use</span> <span class="w">Ccchecker</span><span class="sc">;</span>
    <span class="k">use</span> <span class="w">CGI::Carp</span> <span class="q">qw(fatalsToBrowser set_message)</span><span class="sc">;</span>
    <span class="k">use</span> <span class="w">Cwd</span><span class="sc">;</span>
    <span class="i">set_message</span><span class="s">(</span>
<span class="q">&quot;Please use the &lt;a title=\&quot;cclite google group\&quot; href=\&quot;http://groups.google.co.uk/group/cclite\&quot;&gt;Cclite Google Group&lt;/a&gt; for help, if necessary&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># checks that the installation is feasible, necessary modules are there</span>

    <span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span> <span class="s">)</span> = <span class="i">get_os_and_distribution</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="s">(</span> <span class="i">$messages</span>[<span class="n">0</span>]<span class="cm">,</span> <span class="i">$dir</span><span class="cm">,</span> <span class="i">$libpath</span> <span class="s">)</span> =
      <span class="i">check_paths</span><span class="s">(</span><span class="i">$package_type</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># check libraries exist</span>

    <span class="c"># make an informed guess at the config file path if not explictly supplied</span>
    <span class="c"># for ccinstall this needs to be the cclite config</span>
    <span class="i">$default_config</span> = <span class="q">&quot;$dir/config/cclite.cf&quot;</span><span class="sc">;</span>

    <span class="c">#FIXME: duplicate slash somewhere in this....</span>
    <span class="i">$default_config</span> =~ <span class="q">s/\/\//\//g</span><span class="sc">;</span>

    <span class="c"># and the readsms config file</span>
    <span class="i">$default_sms_config</span> = <span class="q">&quot;${dir}config/readsms.cf&quot;</span><span class="sc">;</span>
    <span class="i">$default_sms_config</span> =~ <span class="q">s/\s//g</span><span class="sc">;</span>

    <span class="i">%configuration</span> = <span class="i">main::readconfiguration</span><span class="s">(</span><span class="i">$default_config</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="w">error</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># currently the default is not implemented, most values</span>
        <span class="c"># are supplied in _guess_configuration</span>
        <span class="i">$newinstall</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="i">%sms_configuration</span> = <span class="i">main::readconfiguration</span><span class="s">(</span><span class="i">$default_sms_config</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$sms_configuration</span>{<span class="w">error</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># currently the default is not implemented, most values</span>
        <span class="c"># are supplied in _guess_configuration</span>
        <span class="i">$new_sms_install</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="s">}</span>

<span class="c"># if this is a windows or debian style package, already setup, so don&#39;t do this...</span>
<span class="c"># but if it&#39;s a tarball or non-standard debian/ubuntu need to set up log config...</span>

    <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$package_type</span> == <span class="n">0</span> || <span class="i">$package_type</span> == <span class="n">3</span> <span class="s">)</span> &amp;&amp; <span class="i">$newinstall</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># FIXME: no check needed because log4perl withdrawn</span>
        <span class="c">#  ( $messages[6], $log_config ) =</span>
        <span class="c">#    write_log_config( $dir, $os, $distribution, $package_type );</span>

        <span class="i">$messages</span>[<span class="n">3</span>] = <span class="i">check_template_path</span><span class="s">(</span><span class="i">$dir</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># check template directory</span>

        <span class="i">$messages</span>[<span class="n">5</span>] = <span class="i">check_log_path</span><span class="s">(</span><span class="i">$dir</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="s">(</span> <span class="i">$messages</span>[<span class="n">1</span>]<span class="cm">,</span> <span class="i">$hash_type</span> <span class="s">)</span> = <span class="i">test_sha</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>       <span class="c"># test for sha module</span>
    <span class="i">$messages</span>[<span class="n">2</span>] = <span class="i">test_dbi</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>                       <span class="c"># for dbi module</span>
    <span class="c">###$messages[4] = test_log();                    # log4perl no longer necessary</span>

    <span class="i">$login</span> = <span class="k">getpwuid</span><span class="s">(</span><span class="i">$&lt;</span><span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$os</span> <span class="k">ne</span> <span class="q">&#39;windows&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># can&#39;t tell which entry will be present...</span>
    <span class="k">my</span> <span class="i">$test_results</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$message</span> <span class="s">(</span><span class="i">@messages</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$test_results</span> .= <span class="i">$message</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># complain and stop..</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$test_results</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">show_problems</span><span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$package_type</span><span class="cm">,</span> <span class="i">$login</span><span class="cm">,</span> <span class="i">@messages</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

<span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
    <span class="i">show_problems</span><span class="s">(</span> <span class="i">$os</span><span class="cm">,</span> <span class="i">$distribution</span><span class="cm">,</span> <span class="i">$login</span><span class="cm">,</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>              <span class="c"># use the cookie module</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>                   <span class="c"># use the utilities module</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>            <span class="c"># use the validation and javascript routines</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>                <span class="c"># use the main motor</span>
<span class="k">use</span> <span class="w">HTML::SimpleTemplate</span><span class="sc">;</span>  <span class="c"># this is used for cgi and for webservices</span>
<span class="k">use</span> <span class="w">Ccadmin</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>              <span class="c"># probably should be via Cclite.pm only, not directly</span>
<span class="k">use</span> <span class="w">Ccchecker</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">%fields</span> = <span class="i">cgiparse</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$offset</span> = <span class="i">$fields</span>{<span class="w">offset</span>}<span class="sc">;</span>

<span class="c"># hash type is passed into the configuration, only if newinstall</span>
<span class="i">$fields</span>{<span class="w">hash_type</span>} = <span class="i">$hash_type</span> <span class="k">if</span> <span class="s">(</span><span class="i">$newinstall</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#FIXME: no configuration file at this stage, but hard-code horror...</span>
<span class="i">$fields</span>{<span class="w">version</span>} ||= <span class="q">&quot;0.9.4.1&quot;</span><span class="sc">;</span>

<span class="c"># read here to announce OS, cpanel etc.</span>
<span class="k">our</span> <span class="i">%sys_message</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># number of records per page in lists ex-db tables, provided in cclite.cf</span>
<span class="k">my</span> <span class="i">$limit</span> = <span class="i">$fields</span>{<span class="w">limit</span>} || <span class="n">15</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$fields</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$fields</span>{<span class="w">domain</span>} <span class="s">)</span> =
  <span class="i">get_server_details</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># this is in Ccsecure, may need extra measures</span>

<span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>
    <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$templatename</span><span class="cm">,</span> <span class="i">$registry_private_value</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># for the moment</span>

<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$pagename</span> = <span class="i">$fields</span>{<span class="w">name</span>} || <span class="q">&quot;registry.html&quot;</span><span class="sc">;</span>    <span class="c"># default is the index page</span>

<span class="k">my</span> <span class="i">$action</span> = <span class="i">$fields</span>{<span class="w">action</span>} || <span class="q">&quot;updateconfig1&quot;</span><span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">type</span>} ||= <span class="q">&#39;main&#39;</span><span class="sc">;</span>    <span class="c"># show main configuration, if no type</span>

<span class="k">my</span> <span class="i">$table</span> = <span class="i">$fields</span>{<span class="w">subaction</span>}<span class="sc">;</span>
<span class="i">$db</span> = <span class="i">$fields</span>{<span class="w">registry</span>}<span class="sc">;</span>

<span class="c"># A template object referencing a particular directory</span>
<span class="c"># Uses $dir to try and locate template from directory it&#39;s loaded into</span>

<span class="c"># install is multilingual now 03/2012 en default...</span>
<span class="k">my</span> <span class="i">$language</span> = <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;language&#39;</span>} || <span class="q">&#39;en&#39;</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$pages</span> = <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="q">&quot;$dir/templates/html/$language/install&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$user_pages</span> = <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="q">&quot;$dir/templates/html/$language&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="i">$token</span> = <span class="i">$registry_private_value</span> =
  <span class="q">&quot;testtoken&quot;</span><span class="sc">;</span>    <span class="c"># for the moment, calculated later</span>

<span class="c">#</span>
<span class="i">$fields</span>{<span class="w">os</span>}           = <span class="i">$os</span><span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">package_type</span>} = <span class="i">$package_type</span><span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">distribution</span>} = <span class="i">$distribution</span><span class="sc">;</span>

<span class="c"># message at top of install fields, helpful for remote support...</span>
<span class="i">$fields</span>{<span class="w">environment</span>} =
<span class="q">&quot;$sys_message{environmentis}  $fields{os} $fields{distribution} : $sys_message{packagetype} $fields{package_type}&quot;</span><span class="sc">;</span>

<span class="c">#</span>
<span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

<span class="c"># there may or may not be cookies at this stage, used by add registry to create batch paths, if present</span>
<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># these are specific actions which belong to the admin application</span>

<span class="c"># create a trading group which is a database + batch paths for csv, rss etc. etc.</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;addregistry&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =

    <span class="i">add_registry</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>    <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> \<span class="i">%configuration</span><span class="cm">,</span>
        <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>        <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showregistries&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">show_registries</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;checkinstall&quot;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$usable</span><span class="cm">,</span> <span class="i">$diagnosis</span> <span class="s">)</span> = <span class="i">check_cclite_preinstall</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;righthandside&#39;</span>} = <span class="i">$usable</span> . <span class="q">&#39;&lt;br/&gt;&#39;</span> . <span class="i">$diagnosis</span><span class="sc">;</span>
    <span class="i">$pagename</span> = <span class="q">&#39;result.html&#39;</span><span class="sc">;</span>
<span class="s">}</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;updateconfig2&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">update_config2</span><span class="s">(</span> <span class="i">$default_config</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># update readsms.cf, new in February 2014</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;updategammuconfig&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">update_config2</span><span class="s">(</span> <span class="i">$default_sms_config</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#  print &quot;( r:$refresh, m:$metarefresh, e:$error, fr:$fieldsref, h:$html, p:$pagename, c:$cookies )&quot; ;</span>
<span class="c"># this will guess at values, if newinstall is signalled</span>

<span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;updateconfig1&quot;</span> <span class="s">)</span> <span class="s">{</span>

    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
      <span class="i">update_config1</span><span class="s">(</span> <span class="i">$newinstall</span><span class="cm">,</span> <span class="i">$new_sms_install</span><span class="cm">,</span> <span class="i">$default_config</span><span class="cm">,</span>
        <span class="i">$default_sms_config</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$dir</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># get the second set of fields, this is for display convenience...</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="w">righthandside</span>} =
      <span class="i">$pages</span><span class="i">-&gt;Assemble</span><span class="s">(</span> <span class="q">&quot;installvalues_parttwo.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;usable&#39;</span>}<span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;diagnosis&#39;</span>} <span class="s">)</span> =
      <span class="i">check_cclite_preinstall</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c"># this will guess at values, if new_sms_install is signalled</span>
<span class="c">#if ( $action eq &quot;updategammuconfig&quot; ) {</span>
<span class="c">#</span>
<span class="c">#    ( $refresh, $metarefresh, $error, $fieldsref, $pagename, $cookies ) =</span>
<span class="c">#      update_config1( $newinstall, $new_sms_install, $default_sms_config,</span>
<span class="c">#        $fieldsref, $dir );</span>
<span class="c">#</span>
<span class="c">#    # get the second set of fields, this is for display convenience...</span>
<span class="c">#    $fieldsref-&gt;{righthandside} =</span>
<span class="c">#      $pages-&gt;Assemble( &quot;installvalues_parttwo.html&quot;, $fieldsref );</span>
<span class="c">#    ( $fieldsref-&gt;{&#39;usable&#39;}, $fieldsref-&gt;{&#39;diagnosis&#39;} ) =</span>
<span class="c">#      check_cclite_preinstall();</span>
<span class="c">#</span>
<span class="c">#}</span>

<span class="c"># display the a template, if requested</span>
<span class="i">$action</span> =~ <span class="q">/template/</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> = <span class="i">display_template</span><span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># display an action result, all actions are consumed</span>

<span class="c"># my $goodbye = &quot;$messages{goodbye} $cookieref-&gt;{userLogin}&quot;;</span>

<span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;youare&#39;</span>} = <span class="q">&#39;&#39;</span><span class="sc">;</span>
<span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;at&#39;</span>}     = <span class="q">&#39;&#39;</span><span class="sc">;</span>
<span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;action&#39;</span>} = <span class="q">&#39;&#39;</span><span class="sc">;</span>

<span class="c"># flag for logged in users 12/2011</span>
<span class="k">my</span> <span class="i">$userref</span><span class="sc">;</span>
<span class="i">$userref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}    = <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>
<span class="i">$userref</span>-&gt;{<span class="q">&#39;userLoggedin&#39;</span>} = <span class="n">0</span><span class="sc">;</span>

<span class="k">my</span> <span class="s">(</span> <span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="cm">,</span> <span class="i">$c</span><span class="cm">,</span> <span class="i">$d</span> <span class="s">)</span> = <span class="i">update_database_record</span><span class="s">(</span>
    <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
    <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="i">$userref</span><span class="cm">,</span> <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;language&#39;</span>}<span class="cm">,</span>
    <span class="i">$cookieref</span>-&gt;{<span class="q">&#39;token&#39;</span>}
<span class="s">)</span><span class="sc">;</span>

<span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$cookieref</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">$cookieref</span>-&gt;{<span class="i">$key</span>} = <span class="k">undef</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> <span class="k">ne</span> <span class="q">&#39;language&#39;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">my</span> <span class="i">$cookieheader</span> =
  <span class="i">return_cookie_header</span><span class="s">(</span> <span class="n">-1</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;domain&#39;</span>}<span class="cm">,</span> <span class="q">&#39;/&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">%$cookieref</span> <span class="s">)</span><span class="sc">;</span>

<span class="i">display_template</span><span class="s">(</span>

    <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>        <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
    <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookieheader</span><span class="cm">,</span> <span class="i">$token</span>
<span class="s">)</span><span class="sc">;</span>

<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<a name="EOF-"></a></pre></body>

</html>
