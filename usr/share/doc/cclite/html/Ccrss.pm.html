<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccrss.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccrss.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#create_rss_feed">create_rss_feed</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccrss-">package Ccrss</a>
<ul>
<li><a href="#create_rss_feed-">create_rss_feed</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<pre>
 Ccrss.pm</pre>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<pre>
 Sketchy RSS module for Cclite</pre>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<pre>
 This is a sketchy RSS module for Cclite..the idea is to publish 
 and aggregate offer and demand London-wide, for example.</pre>
<pre>
 Ccrss.pm is based on:
 rss.pl -- lightweight CGI-based RSS aggregator
 Copyright (C) 2004 Mark L. Irons</pre>
<pre>
 This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
 (at your option) any later version.</pre>
<pre>
 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.</pre>
<pre>
 You should have received a copy of the GNU General Public License
 along with this program; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 Yes, I'm aware that this is embarrassing Perl 4 code. Improve it! 
 Have done so, I hope...HB 2005 -- MLI</pre>
<pre>
 Note that there's tons of dead code from the original project in here.
 It's left in in case the current module is extended in that direction.</pre>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>rss.pl -- lightweight CGI-based RSS aggregator
Copyright (C) 2004 Mark L. Irons</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>Copyright (C) 2004 Mark L. Irons
(c) Hugh Barnard 2005 GPL Licenced</p>
<pre>
<a name="package-Ccrss-"></a><span class="k">package </span><span class="i">Ccrss</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="c">###use Ccsecure;    # at least for get_server_details()</span>
<span class="k">use</span> <span class="w">XML::RSS</span><span class="sc">;</span>    <span class="c"># generate registries channel, ads channel</span>
<span class="k">use</span> <span class="w">XML::Simple</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">LWP::Simple</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(create_rss_feed)</span><span class="sc">;</span>

<span class="k">our</span> <span class="i">%messages</span>    = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="create_rss_feed">create_rss_feed</a></h3>
<pre>
 this is the real feed creator and storer. It needs to be more
 parameterised, for example, where it stores its created files etc.
 It's designed to run as one cron for multiple registries running
 in one domain on one webserver (if that makes sense..)</pre>

<pre>
<a name="create_rss_feed-"></a><span class="k">sub </span><span class="m">create_rss_feed</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$description</span><span class="cm">,</span> <span class="i">$email</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$rss</span> = <span class="w">new</span> <span class="i">XML::RSS</span><span class="s">(</span> <span class="w">version</span> <span class="cm">=&gt;</span> <span class="q">&#39;1.0&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$title</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;all&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$title</span>     = <span class="q">&quot;$db $messages{&#39;all&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">$sqlstring</span> = <span class="q">&quot;type = \&#39;offered\&#39; or type = \&#39;wanted\&#39;&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;offered&#39;</span>
        || <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;wanted&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$title</span>     = <span class="q">&quot;$db $messages{$fieldsref-&gt;{&#39;type&#39;}}&quot;</span><span class="sc">;</span>
        <span class="i">$sqlstring</span> = <span class="q">&quot;type = \&#39;$fieldsref-&gt;{&#39;type&#39;}\&#39;&quot;</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;type&#39;</span>} <span class="k">eq</span> <span class="q">&#39;match&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$title</span>     = <span class="q">&quot;$db $messages{&#39;matched&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT * FROM om_yellowpages o, om_yellowpages w where (</span>
<span class="hh">(o.id != w.id) and o.type != w.type and o.category = w.category and o.parent = w.parent  ) </span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;unknown feed type:$$fieldsref{&#39;type&#39;}&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$ad_hash_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">type</span>} <span class="k">ne</span> <span class="q">&#39;match&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$ad_hash_ref</span> <span class="s">)</span> = <span class="i">sqlfind</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>   <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span>  <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$ad_hash_ref</span> <span class="s">)</span> =
          <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># empty query result, return</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$ad_hash_ref</span><span class="s">)</span> <span class="s">)</span> || <span class="i">$registryerror</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$ad_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$rss</span><span class="i">-&gt;add_item</span><span class="s">(</span>
            <span class="w">title</span> <span class="cm">=&gt;</span>
<span class="q">&quot;$ad_hash_ref-&gt;{$key}-&gt;{&#39;type&#39;}:$ad_hash_ref-&gt;{$key}-&gt;{&#39;subject&#39;}&quot;</span><span class="cm">,</span>
            <span class="w">link</span> <span class="cm">=&gt;</span>
<span class="q">&quot;$home?subaction=om_yellowpages&amp;userLogin=$ad_hash_ref-&gt;{$key}-&gt;{&#39;fromuserid&#39;}&amp;action=showuser&quot;</span><span class="cm">,</span>
            <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$ad_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;description&#39;</span>}<span class="cm">,</span>
            <span class="w">dc</span>          <span class="cm">=&gt;</span> <span class="s">{</span>
                <span class="w">subject</span> <span class="cm">=&gt;</span> <span class="i">$ad_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;subject&#39;</span>}<span class="cm">,</span>
                <span class="w">creator</span> <span class="cm">=&gt;</span> <span class="q">&quot;$ad_hash_ref-&gt;{$key}-&gt;{&#39;fromuserid&#39;} at $db&quot;</span><span class="cm">,</span>
            <span class="s">}</span><span class="cm">,</span>
            <span class="w">taxo</span> <span class="cm">=&gt;</span> <span class="s">[</span>
                <span class="q">&#39;http://dmoz.org/Society/Organizations/Local_Currency_Systems/&#39;</span><span class="cm">,</span>
<span class="q">&#39;http://dmoz.org/Society/Organizations/Local_Currency_Systems/LETS/&#39;</span>
            <span class="s">]</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># end of foreach row</span>

    <span class="c"># header information for the rss channel</span>

    <span class="i">$rss</span><span class="i">-&gt;channel</span><span class="s">(</span>
        <span class="w">title</span>       <span class="cm">=&gt;</span> <span class="q">&quot;$title&quot;</span><span class="cm">,</span>
        <span class="w">link</span>        <span class="cm">=&gt;</span> <span class="i">$home</span><span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="i">$description</span><span class="cm">,</span>
        <span class="w">dc</span>          <span class="cm">=&gt;</span> <span class="s">{</span>
            <span class="w">date</span>      <span class="cm">=&gt;</span> <span class="q">&#39;2000-08-23T07:00+00:00&#39;</span><span class="cm">,</span>
            <span class="w">subject</span>   <span class="cm">=&gt;</span> <span class="q">&quot;Goods and Services Offers at $db&quot;</span><span class="cm">,</span>
            <span class="w">creator</span>   <span class="cm">=&gt;</span> <span class="i">$email</span><span class="cm">,</span>
            <span class="w">publisher</span> <span class="cm">=&gt;</span> <span class="i">$email</span><span class="cm">,</span>
            <span class="w">rights</span>    <span class="cm">=&gt;</span> <span class="q">&#39;Copyright 2010, Cclite&#39;</span><span class="cm">,</span>
            <span class="w">language</span>  <span class="cm">=&gt;</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;language&#39;</span>}<span class="cm">,</span>
        <span class="s">}</span><span class="cm">,</span>
        <span class="w">syn</span> <span class="cm">=&gt;</span> <span class="s">{</span>
            <span class="w">updatePeriod</span>    <span class="cm">=&gt;</span> <span class="q">&quot;hourly&quot;</span><span class="cm">,</span>
            <span class="w">updateFrequency</span> <span class="cm">=&gt;</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span>
            <span class="w">updateBase</span>      <span class="cm">=&gt;</span> <span class="q">&quot;1901-01-01T00:00+00:00&quot;</span><span class="cm">,</span>
        <span class="s">}</span><span class="cm">,</span>
        <span class="w">taxo</span> <span class="cm">=&gt;</span> <span class="s">[</span>
            <span class="q">&#39;http://dmoz.org/Society/Organizations/Local_Currency_Systems/&#39;</span><span class="cm">,</span>
            <span class="q">&#39;http://dmoz.org/Society/Organizations/Local_Currency_Systems/LETS/&#39;</span>
        <span class="s">]</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$rss</span><span class="i">-&gt;image</span><span class="s">(</span>
        <span class="w">title</span> <span class="cm">=&gt;</span> <span class="i">$title</span><span class="cm">,</span>
        <span class="w">url</span>   <span class="cm">=&gt;</span> <span class="q">&quot;$home/image&quot;</span><span class="cm">,</span>
        <span class="w">link</span>  <span class="cm">=&gt;</span> <span class="i">$home</span><span class="cm">,</span>
        <span class="w">dc</span>    <span class="cm">=&gt;</span> <span class="s">{</span> <span class="w">creator</span> <span class="cm">=&gt;</span> <span class="q">&quot;anon&quot;</span><span class="cm">,</span> <span class="s">}</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$rss</span><span class="i">-&gt;textinput</span><span class="s">(</span>
        <span class="w">title</span>       <span class="cm">=&gt;</span> <span class="q">&quot;quick finder&quot;</span><span class="cm">,</span>
        <span class="w">description</span> <span class="cm">=&gt;</span> <span class="q">&quot;Use the input below to search this registry&quot;</span><span class="cm">,</span>
        <span class="w">name</span>        <span class="cm">=&gt;</span> <span class="q">&quot;query&quot;</span><span class="cm">,</span>
        <span class="w">link</span>        <span class="cm">=&gt;</span> <span class="q">&quot;$home&quot;</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c">#rss path is now /var/www/cclite/public_html/rss/dogtown/en for example</span>
    <span class="k">my</span> <span class="i">$rss_directory</span> =
      <span class="k">join</span><span class="s">(</span> <span class="q">&#39;/&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;rsspath&#39;</span>}<span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;language&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="i">$rss_directory</span> <span class="s">)</span> <span class="s">{</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c">#FIXME: won&#39;t work for Windows though...</span>
        <span class="q">`mkdir -p $rss_directory`</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$feed_file_name</span> = <span class="q">&quot;$fieldsref-&gt;{&#39;type&#39;}\.rdf&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$full_name</span>      = <span class="q">&quot;$rss_directory\/$feed_file_name&quot;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="s">(</span> <span class="k">-w</span> <span class="i">$full_name</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;cannot write to rss feed file:$feed_file_name&quot;</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$rss</span><span class="i">-&gt;save</span><span class="s">(</span><span class="i">$full_name</span><span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$db</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># ugly but removes empty file bug</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
