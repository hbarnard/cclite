<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Textmarketer.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Textmarketer.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#gateway_sms_transaction">gateway_sms_transaction</a></li>
			<li><a href="#_gateway_sms_pin_change">_gateway_sms_pin_change</a></li>
			<li><a href="#_gateway_sms_suspend">_gateway_sms_suspend</a></li>
			<li><a href="#_gateway_sms_change_language">_gateway_sms_change_language</a></li>
			<li><a href="#_gateway_sms_join">_gateway_sms_join</a></li>
			<li><a href="#_gateway_sms_pay">_gateway_sms_pay</a></li>
			<li><a href="#_gateway_sms_send_balance">_gateway_sms_send_balance</a></li>
			<li><a href="#sms_payment_parse">sms_payment_parse</a></li>
			<li><a href="#_check_pin">_check_pin</a></li>
			<li><a href="#_send_sms_mail_message">_send_sms_mail_message</a></li>
			<li><a href="#convert_textmarketer">convert_textmarketer</a></li>
			<li><a href="#_send_textmarketer_sms_message">_send_textmarketer_sms_message</a></li>
			<li><a href="#__outbound_textmarketer_http_sms">__outbound_textmarketer_http_sms</a></li>
			<li><a href="#_charge_one_sms_unit">_charge_one_sms_unit</a></li>
			<li><a href="#_check_digit_iso_7064">_check_digit_iso_7064</a></li>
			<li><a href="#_generate_password">_generate_password</a></li>
			<li><a href="#debug">debug</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccsms::Textmarketer-">package Ccsms::Textmarketer</a>
<ul>
<li><a href="#gateway_sms_transaction-">gateway_sms_transaction</a></li>
<li><a href="#_gateway_sms_pin_change-">_gateway_sms_pin_change</a></li>
<li><a href="#_gateway_sms_suspend-">_gateway_sms_suspend</a></li>
<li><a href="#_gateway_sms_change_language-">_gateway_sms_change_language</a></li>
<li><a href="#_gateway_sms_join-">_gateway_sms_join</a></li>
<li><a href="#_gateway_sms_pay-">_gateway_sms_pay</a></li>
<li><a href="#_gateway_sms_send_balance-">_gateway_sms_send_balance</a></li>
<li><a href="#_sms_payment_parse-">_sms_payment_parse</a></li>
<li><a href="#_check_pin-">_check_pin</a></li>
<li><a href="#_send_sms_mail_message-">_send_sms_mail_message</a></li>
<li><a href="#convert_textmarketer-">convert_textmarketer</a></li>
<li><a href="#_send_textmarketer_sms_message-">_send_textmarketer_sms_message</a></li>
<li><a href="#__outbound_textmarketer_http_sms-">__outbound_textmarketer_http_sms</a></li>
<li><a href="#_charge_one_sms_unit-">_charge_one_sms_unit</a></li>
<li><a href="#_ascii_to_hex-">_ascii_to_hex</a></li>
<li><a href="#_hex_to_ascii-">_hex_to_ascii</a></li>
<li><a href="#_check_digit_iso_7064-">_check_digit_iso_7064</a></li>
<li><a href="#_generate_password-">_generate_password</a></li>
<li><a href="#debug-">debug</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Textmarketer.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for sms, mail etc.
via commercial sms gateway this will have to be modified
for any new gateway supplier</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains the interface for a complete sms based payment
system with pins supplied in the sms messages. The allowed messages are:</p>
<p>and dispatches to the appropriate internal function</p>
<p>Pin number is always first thing can be alphanumeric and is set up as a password
rather than a 5 figure number</p>
<p>SMS Transactions</p>
<p>-&gt; 2cc join                join hugh barnard
                           join hugh barnard <a href="mailto:hugh.barnard@example.com">hugh.barnard@example.com</a></p>
<pre>

                           this sends back a setup message with a web password
                           and a pin for sms etc. everything is active at this stage
                           sets up with sms receipt switched on</pre>
<pre>

-&gt; 2cc suspend             p123456 suspend</pre>
<pre>
                           suspends the account for fraud and for leaving the system                           
                           
-&gt; 2cc Confirm pin         p123456 confirm [not needed if setup from sms]</pre>
<p>-&gt; 2cc Change pin          p123456 change p345678</p>
<p>-&gt; 2cc Pay                 p123456 pay 5 to 07855 524667 for stuff (note need to change strip regex)
                           p123456 pay 5 to 07855524667 for other stuff
                           p123456 pay 5 to 4407855 524667 for stuff
                           p123456 pay test1 10 limes
                           p123456 pay 4477777777 10 limes</p>
<p>-&gt; Query Balance           p123456 balance</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 - 2008 GPL Licenced</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccsms::Textmarketer-"></a><span class="k">package </span><span class="i">Ccsms::Textmarketer</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>

<span class="c">###use re &#39;debug&#39;;  # debugging for regular expressions, useful for problematic SMS messages</span>

<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>

<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">LWP::UserAgent</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>    <span class="c"># new style configuration method</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">CGI</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">utf8</span><span class="sc">;</span>

<span class="c">###open (STDERR, &quot;&gt;&amp;STDOUT&quot;); # send STDERR out to page, then view source when debugging regular expressions</span>

<span class="i">@EXPORT</span> = <span class="q">qw(</span>
  <span class="q">gateway_sms_transaction</span>
  <span class="q">convert_cardboardfish</span>
  <span class="q">debug</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash</p>
<pre>

=cut</pre>
<pre>
<span class="c">#============== change the configuration to your registry and currency for sms</span>

<span class="c"># messages will now use decide_language to get language, in Ccu.pm 08/2011</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%configuration</span>     = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%sms_configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="q">&#39;../../config/readsms.cf&#39;</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># this is a little unnecessary, but can stay for a while</span>
<span class="k">our</span> <span class="i">$registry</span>     = <span class="i">$sms_configuration</span>{<span class="q">&#39;registry&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$currency</span>     = <span class="i">$sms_configuration</span>{<span class="q">&#39;currency&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$sms_user</span>     = <span class="i">$sms_configuration</span>{<span class="q">&#39;user&#39;</span>}<span class="sc">;</span>
<span class="k">our</span> <span class="i">$sms_password</span> = <span class="i">$sms_configuration</span>{<span class="q">&#39;password&#39;</span>}<span class="sc">;</span>

<span class="c"># hierachy of language decision, probably over the top, really...</span>
<span class="k">our</span> <span class="i">$language</span> =
     <span class="i">$sms_configuration</span>{<span class="q">&#39;language&#39;</span>}
  || <span class="i">$configuration</span>{<span class="q">&#39;language&#39;</span>}
  || <span class="q">&#39;en&#39;</span><span class="sc">;</span>

<span class="k">our</span> <span class="i">@sms_sponsor_messages</span> =
  <span class="k">split</span><span class="s">(</span> <span class="q">/,/</span><span class="cm">,</span> <span class="i">$sms_configuration</span>{<span class="q">&#39;sponsor_messages&#39;</span>} <span class="s">)</span><span class="sc">;</span>

<span class="c"># FIXME: need this because the transaction return needs it</span>
<span class="k">my</span> <span class="i">$pages</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>

<span class="c"># set up debugging from readsms configuration file...</span>
<span class="k">our</span> <span class="i">$debug</span> = <span class="i">$sms_configuration</span>{<span class="q">&#39;debug&#39;</span>}<span class="sc">;</span>    <span class="c"># don&#39;t use LWP just log etc.</span>

<span class="c">#=============================================================</span>

</pre><p></p>
<h3><a name="gateway_sms_transaction">gateway_sms_transaction</a></h3>
<p>This does a validation (could move to ccvalidate) and
an initial parse of the incoming message and
then dispatches to the appropriate internal function</p>
<p>The textmarketer version goes through a short code which needs to be stripped off
so parsing and validation is different for this...</p>
<pre>
<a name="gateway_sms_transaction-"></a><span class="k">sub </span><span class="m">gateway_sms_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$return_value</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">debug</span><span class="s">(</span> <span class="q">&#39;fields inwards&#39;</span><span class="cm">,</span> <span class="i">$fields_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no number, so no lookup or no message...reject</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;$fields_ref-&gt;{&#39;message&#39;} from $fields_ref-&gt;{&#39;number&#39;} $messages{&#39;smsoriginblank&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># numbers are stored in database as 447855667524 for example</span>
    <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>} =
      <span class="i">format_for_standard_mobile</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># setup transaction, special case</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} =~ <span class="q">/\s+join\s+/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">_gateway_sms_join</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no number, so no lookup or no message...reject</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;$fields_ref-&gt;{&#39;number&#39;} $messages{&#39;smsmessageblank&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># no one with this number , so no lookup or no message...reject</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;$fields_ref-&gt;{&#39;number&#39;} $messages{&#39;smsnumbernotfound&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># user record available at this point, so change language to user preferred</span>
    <span class="c"># language...</span>
    <span class="i">$language</span> = <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;language&#39;</span>} = <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLang&#39;</span>}<span class="sc">;</span>
    <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="i">$language</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># initial parse to get transaction type</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="c"># experimental language change...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
<span class="q">m/^$sms_configuration{shortcode}\s+(en|zh|ar|pt|nl|el|it|ja|ru|fr|th|de|es|ro|vi|ko|fi|id|bn)/i</span>
      <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;language&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="k">return</span> <span class="i">_gateway_sms_change_language</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># if it hasn&#39;t got a pin, not worth carrying on, tell user</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">m/^$sms_configuration{shortcode}\s+p?(\w+)\s+(\w+)/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pin</span>              = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_type</span> = <span class="i">$2</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
          <span class="q">&quot;from: $fields_ref-&gt;{&#39;number&#39;} $input -malformed transaction&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span>
            <span class="i">$registry</span><span class="cm">,</span>
            <span class="q">&quot;from: $fields_ref-&gt;{&#39;number&#39;} $input $messages{smsnopindetected}&quot;</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$pin_status</span> = <span class="i">_check_pin</span><span class="s">(</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="q">&quot;nok:$pin_status&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$pin_status</span> <span class="k">ne</span> <span class="q">&#39;ok&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># activation is done in _check_pin, these are the allowed operations</span>

    <span class="c"># strip 2cc or other short code before parsing</span>
    <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} =~ <span class="q">s/^$sms_configuration{shortcode}\s+//i</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">#  p123456 confirm</span>
        <span class="k">return</span> <span class="i">$pin_status</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;change&#39;</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># change pin</span>
        <span class="i">$return_value</span> = <span class="i">_gateway_sms_pin_change</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># allow pay or send as keyword to line up with email style...</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;pay&#39;</span> || <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;send&#39;</span> <span class="s">)</span>
    <span class="s">{</span>                                              <span class="c"># payment transaction</span>
        <span class="i">$return_value</span> =
          <span class="i">_gateway_sms_pay</span><span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$return_value</span> = <span class="i">_gateway_sms_send_balance</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;suspend&#39;</span> || <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;freeze&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$return_value</span> = <span class="i">_gateway_sms_suspend</span><span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
          <span class="q">&quot;from: $fields_ref-&gt;{&#39;number&#39;} $input -unrecognised transaction&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>

        <span class="c"># this is a &#39;bad&#39; transaction of some kind...</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$return_value</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_pin_change">_gateway_sms_pin_change</a></h3>
<p>Change pin, same rules (three tries) about pin locking</p>
<pre>
<a name="_gateway_sms_pin_change-"></a><span class="k">sub </span><span class="m">_gateway_sms_pin_change</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>
    <span class="i">$input</span> =~ <span class="q">m/^p?(\w+)\s+change\s+p?(\w+)\s*$/</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_pin</span>    = <span class="i">$2</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hashed_pin</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$new_pin</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$new_pin</span><span class="s">)</span> &gt;= <span class="n">4</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$message</span> = <span class="q">&quot;$messages{&#39;smspinchanged&#39;}&quot;</span><span class="sc">;</span>
        <span class="s">(</span> <span class="k">my</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
            <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>}        = <span class="i">$hashed_pin</span><span class="sc">;</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}   = <span class="n">3</span><span class="sc">;</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinChanged&#39;</span>} = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span> =
          <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># pin is too short, not changed...</span>
        <span class="i">$message</span> = <span class="q">&quot;$messages{&#39;smspinnotchanged&#39;}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># don&#39;t send new pin in email</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># but send it to the user&#39;s phone...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="q">&quot;$messages{&#39;smspinchanged&#39;}: $new_pin&quot;</span><span class="sc">;</span>
        <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;pinchange&#39;</span><span class="cm">,</span>
            <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_suspend">_gateway_sms_suspend</a></h3>
<p>Suspend account, before stopping using or fraud etc.</p>
<pre>
<a name="_gateway_sms_suspend-"></a><span class="k">sub </span><span class="m">_gateway_sms_suspend</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;smssuspend&#39;</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># suspended status for account</span>
    <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userStatus&#39;</span>} = <span class="q">&#39;suspended&#39;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$dummy</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="i">$dummy1</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$dummy2</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># send mail to user</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># send mail to registry supervisor</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registry_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="q">&#39;1&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
        <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">notify_by_mail</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>                       <span class="i">$registry</span><span class="cm">,</span>
        <span class="k">undef</span><span class="cm">,</span>                         <span class="i">$registry_ref</span>-&gt;{<span class="q">&#39;admemail&#39;</span>}<span class="cm">,</span>
        <span class="k">undef</span><span class="cm">,</span>                         <span class="i">$registry_ref</span>-&gt;{<span class="q">&#39;admemail&#39;</span>}<span class="cm">,</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span>
        <span class="k">undef</span><span class="cm">,</span>                         <span class="i">$message</span><span class="cm">,</span>
        <span class="n">6</span><span class="cm">,</span>                             <span class="k">undef</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># end of send mail to registry supervisor</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;suspend&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_change_language">_gateway_sms_change_language</a></h3>
<p>Change user language</p>
<pre>
<a name="_gateway_sms_change_language-"></a><span class="k">sub </span><span class="m">_gateway_sms_change_language</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># change the user language preference...</span>
    <span class="i">$language</span> = <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLang&#39;</span>} = <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;language&#39;</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$dummy</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="i">$dummy1</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$dummy2</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># user record available at this point, so change language to user preferred</span>
    <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="i">$language</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;$messages{&#39;smslanguagechanged&#39;} $fields_ref-&gt;{&#39;language&#39;}&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;language&#39;</span><span class="cm">,</span>
            <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_join">_gateway_sms_join</a></h3>
<p>Set up new user, warn admin by email?
tell user with password and pin via text message...
status of pin and user is defined by readsms.cf</p>
<pre>
<a name="_gateway_sms_join-"></a><span class="k">sub </span><span class="m">_gateway_sms_join</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$message</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="c">###print $debug_file &quot;in join routine&quot; . Dumper $fieldsref . &quot;\n&quot; if ($debug) ;</span>

    <span class="c"># check not already inscribed</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># there&#39;s a user with this number, send sms and refuse</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userId&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;join&#39;</span><span class="cm">,</span>
            <span class="i">$messages</span>{<span class="q">&#39;smssetupnumberinuse&#39;</span>}<span class="cm">,</span>
            <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$messages{&#39;smssetupnumberinuse&#39;}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># for example -2cc join hugh Barnard- and</span>
<span class="c"># in general /2cc join first-name last-name/ or /2cc join first-name last-name email/</span>
<span class="c">#  SELECT userLogin FROM om_users where userLogin like &#39;test%&#39; order by userLogin desc</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$first_name</span><span class="cm">,</span> <span class="i">$last_name</span><span class="cm">,</span> <span class="i">$email</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">m/^2cc\s+join\s+(\w+)\s+(\w+)$/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$first_name</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$last_name</span>  = <span class="i">$2</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">m/^2cc\s+join\s+(\w+)\s+(\w+)\s+(\S+)$/i</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$first_name</span> = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$last_name</span>  = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$email</span>      = <span class="i">$3</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># not enough parseable data to setup</span>
        <span class="k">return</span> <span class="q">&quot;nok:$input $messages{&#39;smsbadjoin&#39;}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># validation for email if supplied</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$email</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># bad email format, not sure how reliable this is...</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$email</span> !~
<span class="q">/^\+?[a-z0-9](([-+.]|[_]+)?[a-z0-9]+)*@([a-z0-9]+(\.|\-))+[a-z]{2,6}$/i</span>
          <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;join&#39;</span><span class="cm">,</span>
                <span class="i">$messages</span>{<span class="q">&#39;bademail&#39;</span>}<span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="q">&#39;nok&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># check that it isn&#39;t duplicated</span>
        <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userEmail&#39;</span>} = <span class="i">$email</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$user_ref</span> =
          <span class="i">check_email_exists</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> \<span class="i">%messages</span><span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># user with this email already exist they must be distinct</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$user_ref</span>-&gt;{<span class="q">&#39;userId&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;join&#39;</span><span class="cm">,</span>
                <span class="i">$messages</span>{<span class="q">&#39;emailexists&#39;</span>}<span class="cm">,</span>
                <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="q">&#39;nok&#39;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># screen names are canonical lower case but...</span>
    <span class="c"># candidate screen name is four of first, three of last</span>
    <span class="k">my</span> <span class="i">$screen_candidate</span> =
      <span class="k">substr</span><span class="s">(</span> <span class="i">$first_name</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">4</span> <span class="s">)</span> . <span class="k">substr</span><span class="s">(</span> <span class="i">$last_name</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">3</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">sqlraw</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>
        <span class="i">$registry</span><span class="cm">,</span>
<span class="q">&quot;SELECT userId,userLogin FROM om_users where lower(userLogin) like \&#39;$screen_candidate%\&#39; order by userLogin asc limit 1&quot;</span><span class="cm">,</span>
        <span class="q">&#39;userId&#39;</span><span class="cm">,</span>
        <span class="q">&#39;&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># there&#39;s something like this already in the database ;</span>
    <span class="k">my</span> <span class="i">$key</span> = <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span>[<span class="n">-1</span>]<span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$key</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$key</span>++<span class="sc">;</span>
        <span class="i">$screen_candidate</span> .= <span class="i">$key</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#FIXME: remove checkdigit stuff for the moment...</span>
    <span class="c">###$screen_candidate .= _check_digit_iso_7064($screen_candidate);</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># force sms receipt for this kind of setup</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} = <span class="n">1</span><span class="sc">;</span>

    <span class="c"># FIXME: These should not be hardcoded, 3 tries, not test yet + active</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPasswordTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPasswordStatus&#39;</span>} =
      <span class="i">$sms_configuration</span>{<span class="q">&#39;userPasswordStatus&#39;</span>}<span class="sc">;</span>

    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userJoindate&#39;</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userLevel&#39;</span>} = <span class="q">&#39;user&#39;</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userLang&#39;</span>}  = <span class="i">$sms_configuration</span>{<span class="q">&#39;language&#39;</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$user_password</span> = <span class="i">_generate_password</span><span class="s">(</span><span class="n">7</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPassword&#39;</span>} = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$user_password</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPasswordChanged&#39;</span>} =

      <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userJoindate&#39;</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c"># add name field</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} = <span class="i">$screen_candidate</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userName&#39;</span>}  = <span class="q">&quot;\u$first_name \u$last_name&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$user_pin</span> = <span class="i">_generate_password</span><span class="s">(</span><span class="n">5</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>}        = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$user_pin</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPinChanged&#39;</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#FIXME: don&#39;t assume that all mobiles are UK based, drop  this..</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userMobile&#39;</span>} =
      <span class="i">format_for_standard_mobile</span><span class="s">(</span> <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;number&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="i">$sms_configuration</span>{<span class="q">&#39;userPinStatus&#39;</span>}<span class="sc">;</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">3</span><span class="sc">;</span>

    <span class="c"># status as in the configuration file...</span>
    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userStatus&#39;</span>} = <span class="i">$sms_configuration</span>{<span class="q">&#39;userStatus&#39;</span>}<span class="sc">;</span>

    <span class="i">$fieldsref</span>-&gt;{<span class="q">&#39;userEmail&#39;</span>} = <span class="i">$email</span><span class="sc">;</span>    <span class="c"># may be blank of course</span>

    <span class="c"># add the user to the registry database</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># send setup done message</span>
    <span class="k">my</span> <span class="i">$setup_complete_message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">Dear $first_name</span>
<span class="hh">Setup for cclite complete</span>
<span class="hh">Screen name: $screen_candidate</span>
<span class="hh">Web password: $user_password</span>
<span class="hh">SMS PIN: $user_pin    </span>
<span class="h">EOT</span>

    <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;join&#39;</span><span class="cm">,</span>
        <span class="i">$setup_complete_message</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_pay">_gateway_sms_pay</a></h3>
<p>Specific transaction written for the tpound
using the gateway messaging gateway, may need modification for other gateways</p>
<pre>
<a name="_gateway_sms_pay-"></a><span class="k">sub </span><span class="m">_gateway_sms_pay</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%fields</span><span class="cm">,</span> <span class="i">%transaction</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">@status</span><span class="cm">,</span>
        <span class="i">$return_value</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">%fields</span> = <span class="i">%$fields_ref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>       <span class="i">$registry</span><span class="cm">,</span>         <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>     <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># FIXME: needs to deliver json etc...</span>
    <span class="k">my</span> <span class="i">$registry_status</span> = <span class="i">get_registry_status</span><span class="s">(</span>
        <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># registry is closed or closing...no pay style transactions allowed...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$registry_status</span> <span class="k">eq</span> <span class="q">&#39;down&#39;</span> || <span class="i">$registry_status</span> <span class="k">eq</span> <span class="q">&#39;closing&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># send SMS to originator to say, can&#39;t be done...</span>
        <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span> <span class="s">{</span>

            <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;registryclosing&#39;</span>} . <span class="q">&#39;:&#39;</span>
              . <span class="i">$messages</span>{<span class="q">&#39;notransfersallowed&#39;</span>}<span class="sc">;</span>
            <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span>
                <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="s">{</span><span class="s">}</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>
        <span class="k">return</span> <span class="q">&quot;nok: $message&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># begin parse on whitespace</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
      <span class="i">_sms_payment_parse</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">debug</span><span class="s">(</span> <span class="q">&quot;payment parse type is $parse_type\n&quot;</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># sms pay message didn&#39;t parse, not worth proceeding</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;pay attempt from $fields{&#39;number&#39;} to $transaction_description_ref-&gt;{&#39;tomobilenumber&#39;} : $messages{&#39;smsinvalidsyntax&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$input $message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># numbers are stored as 447855667524 for example</span>
    <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;tomobilenumber&#39;</span>} =
      <span class="i">format_for_standard_mobile</span><span class="s">(</span>
        <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;tomobilenumber&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># contains only figures so it&#39;s a mobile number</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;touserormobile&#39;</span>} =~ <span class="q">/^\d+\z/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;touserormobile&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># else it&#39;s a userLogin ...</span>
        <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;touserormobile&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># one of the above lookups fails, reject the whole transaction</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;smsnoorigin&#39;</span>}      <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$from_user_ref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;smsnodestination&#39;</span>} <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$to_user_ref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># recipient didn&#39;t confirm pin yet, transaction invalid</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="s">)</span>
        &amp;&amp; <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">ne</span> <span class="q">&#39;active&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">smsunconfirmedpin</span>}<span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$errors</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;:&#39;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&quot;$errors $input&quot;</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;pay attempt from $fields{&#39;number&#39;} to $transaction_description_ref-&gt;{&#39;tomobilenumber&#39;} : $errors&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="q">&#39;fromregistry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

    <span class="c"># no home, not a web transaction</span>
    <span class="i">$transaction</span>{<span class="q">&#39;home&#39;</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="q">&#39;subaction&#39;</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="q">&#39;toregistry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeAmount&#39;</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;quantity&#39;</span>}<span class="sc">;</span>

<span class="c">#FIXME: tradeCurrency : if mentioned in sms overrides default: may not be a good idea?</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;currency&#39;</span>}
      || <span class="i">$currency</span><span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeDate&#39;</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#tradeTitle : added by this routine: now improved 12/2008</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeTitle&#39;</span>} =
<span class="q">&quot;$messages{&#39;smstransactiontitle&#39;} $from_user_ref-&gt;{&#39;userLogin&#39;} -&gt; $to_user_ref-&gt;{&#39;userLogin&#39;}&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDescription</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeDescription&#39;</span>} =
      <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeDestination&#39;</span>} = <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeSource&#39;</span>} = <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>

    <span class="c"># tradestatus from configured sms config or fall back to initial status</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeStatus&#39;</span>} = <span class="i">$sms_configuration</span>{<span class="q">&#39;initialPaymentStatus&#39;</span>}
      || <span class="i">$fields</span>{<span class="q">&#39;initialPaymentStatus&#39;</span>}<span class="sc">;</span>

<span class="c">#FIXME: tradeItem not really identifiable from sms message/possible tax problem too!</span>
    <span class="i">$transaction</span>{<span class="q">&#39;tradeItem&#39;</span>} = <span class="q">&#39;other&#39;</span><span class="sc">;</span>

 <span class="c">#FIXME: mode for this is csv, this is part of a general format upgrade later...</span>
    <span class="i">$transaction</span>{<span class="q">&#39;mode&#39;</span>} = <span class="q">&#39;json&#39;</span><span class="sc">;</span>

    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error3</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#build explicative message, transaction can fall at last hurdle</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$mail_message</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error3</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># message to receiver of credit is sent in their preferred language</span>
        <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span> <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userLang&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$type</span> = <span class="q">&#39;credit&#39;</span><span class="sc">;</span>

        <span class="c"># make currencies plural if qty &gt; 1</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction</span>{<span class="q">&#39;tradeAmount&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$transaction</span>{<span class="q">&#39;tradeCurrency&#39;</span>} =~
              <span class="q">s/y$/ies/i</span><span class="sc">;</span>    <span class="c"># english language currencies</span>
            <span class="i">$transaction</span>{<span class="q">&#39;tradeCurrency&#39;</span>} =~ <span class="q">s/$/s/i</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SMS $messages{&#39;transactionaccepted&#39;} $messages{&#39;from&#39;} $transaction{tradeSource} $messages{&#39;forvalue&#39;} $transaction{tradeAmount} $transaction{tradeCurrency}</span>
<span class="h">EOT</span>

        <span class="i">$mail_message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SMS $messages{&#39;transactionaccepted&#39;} $messages{&#39;to&#39;} $transaction{tradeDestination}  $messages{&#39;forvalue&#39;} $transaction{tradeAmount} $transaction{tradeCurrency}</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$type</span>         = <span class="q">&#39;error&#39;</span><span class="sc">;</span>
        <span class="i">$return_value</span> = <span class="q">&#39;nok&#39;</span><span class="sc">;</span>

        <span class="i">$mail_message</span> = <span class="i">$message</span><span class="sc">;</span>

        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$error3    SMS $messages{&#39;transactionrejected&#39;} $messages{&#39;to&#39;} $transaction{tradeDestination} $messages{&#39;forvalue&#39;} $transaction{tradeAmount} $transaction{tradeCurrency}</span>
<span class="h">EOT</span>

    <span class="s">}</span>

<span class="c"># note that the mail/sms messages are not the same for payment, the person paying</span>
<span class="c"># gets an email and the paid person gets an sms advising them of payment arrival...</span>
    <span class="k">my</span> <span class="i">$mail_error</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$mail_message</span><span class="cm">,</span>
        <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">debug</span><span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$transaction_ref</span> <span class="s">)</span><span class="sc">;</span>

   <span class="c"># send SMS receipt, only if turned on for the user...</span>
   <span class="c">#FIXME: doesn&#39;t deal with SMS for failed transactions, does it to be defined!</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$to_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} &amp;&amp; <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error3</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$to_user_ref</span><span class="cm">,</span> <span class="i">$transaction_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$return_value</span> <span class="k">eq</span> <span class="q">&#39;nok&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;nok: $error3 $message&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_send_balance">_gateway_sms_send_balance</a></h3>
<p>Send balance, via email at present, sms later...
To be done...</p>
<pre>
<a name="_gateway_sms_send_balance-"></a><span class="k">sub </span><span class="m">_gateway_sms_send_balance</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%fields</span> = <span class="s">(</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fields_ref</span> = \<span class="i">%fields</span><span class="sc">;</span>

<span class="c"># html to return html, values to return raw balances and volumes for each currency</span>
<span class="c"># probably should move to json for mobile applications...</span>
    <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} = <span class="q">&#39;values&#39;</span><span class="sc">;</span>

    <span class="s">(</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span> =
      <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span>
        <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$literal_currency</span> = <span class="i">$currency</span><span class="sc">;</span>
    <span class="i">$literal_currency</span> =~ <span class="q">s/y$/ies/i</span><span class="sc">;</span>    <span class="c"># make y currencies plural...</span>

    <span class="c"># current balance for this particular currency</span>
    <span class="c"># May 2012 reveal all currencies in the registry, towards sms multicurrency</span>
    <span class="k">my</span> <span class="i">$balance</span> = <span class="i">$balance_ref</span>-&gt;{<span class="i">$currency</span>}<span class="sc">;</span>

    <span class="c">#FIXME: balance ref key is spaces not trading etc.?</span>
    <span class="k">my</span> <span class="i">$balance_table</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$balance_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$balance_ref</span>-&gt;{<span class="i">$key</span>} =~ <span class="q">s/^\s+$/na/</span><span class="sc">;</span>    <span class="c"># make space = not applicable</span>
        <span class="i">$key</span> =~ <span class="q">s/y$/ies/i</span><span class="sc">;</span>                     <span class="c"># make y currencies plural...</span>
        <span class="i">$balance_table</span> .= <span class="q">&quot;$key:$balance_ref-&gt;{$key}\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$balance_message</span> =
<span class="q">&quot;$messages{smsthebalancefor} $from_user_ref-&gt;{userLogin} $messages{at} $registry $messages{is}:\n$balance_table&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$balance_message</span><span class="cm">,</span>
        <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># send SMS balance, only if turned on for the user...new 16.08.2010</span>
    <span class="c"># blank transaction ref, need to make 1 unit sms currency transaction</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%transaction</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$to_user_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userSmsreceipt&#39;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_textmarketer_sms_message</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;balance&#39;</span><span class="cm">,</span>
            <span class="i">$balance_message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$to_user_ref</span><span class="cm">,</span> \<span class="i">%transaction</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sms_payment_parse">sms_payment_parse</a></h3>
<p>This is now distinct from the transaction preparation etc.</p>
<p>Also, it returns a status, if the parse doesn't contain one
of the necessary elements for a successful transaction. In that
case the transaction -must- fail and it's not worth continuing</p>
<p>Note this now allows decimal currency, allows . and , only for example</p>
<pre>
<a name="_sms_payment_parse-"></a><span class="k">sub </span><span class="m">_sms_payment_parse</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$save_input</span> = <span class="i">$input</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction_description</span><span class="sc">;</span>

    <span class="c"># if parse type remains = 0, then the transaction wasn&#39;t parsed correctly</span>
    <span class="k">my</span> <span class="i">$parse_type</span> = <span class="n">0</span><span class="sc">;</span>

    <span class="c"># make the parse simpler by stripping pin and keyword</span>
    <span class="i">$input</span> =~ <span class="q">s/^p?(\w+)\s+(send|pay)\s+//i</span><span class="sc">;</span>

  <span class="c"># currently allowed sms pay formats, some flexiblity, people won&#39;t remember...</span>

    <span class="c"># 10 to 447779159453|test2: payment in the default currency</span>
    <span class="i">$parse_type</span> = <span class="n">1</span>
      <span class="k">if</span> <span class="s">(</span>
        <span class="i">$input</span> =~ <span class="q">/^(\d+|\d+[\,\.]\d{1,2})\s+to\s+(\d{10,12}|\w+)\s*\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 10 limes to 447779159453|test2: allows the currency to be specified</span>
    <span class="i">$parse_type</span> = <span class="n">2</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
        <span class="q">/^(\d+|\d+[\,\.]\d{1,2})\s+(\w+)\s+to\s+(\d{10,12}|\w+)\s*\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 10 to 447779159453|test2 for numbering</span>
    <span class="i">$parse_type</span> = <span class="n">3</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
        <span class="q">/^(\d+|\d+[\,\.]\d{1,2})\s+to\s+(\d{10,12}|\w+)\s+for\s+(.*)\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 10 limes to 447779159453|test2 for numbering</span>
    <span class="i">$parse_type</span> = <span class="n">4</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
<span class="q">/^(\d+|\d+[\,\.]\d{1,2})\s+(\w+)\s+to\s+(\d{10,12}|\w+)\s+for\s+(.*)\z/xmis</span>
      <span class="s">)</span><span class="sc">;</span>

<span class="c"># send 5 limes to test2 at dalston for demo</span>
<span class="c"># 10 limes to 447779159453|test2 at dalston for numbering : registry is thrown away, compatiblity with email</span>
<span class="c"># this one won&#39;t accept currency default, probably correct...</span>
    <span class="i">$parse_type</span> = <span class="n">5</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
<span class="q">/^(\d+|\d+[\,\.]\d{1,2})\s+(\w+)\s+to\s+(\d{10,12}|\w+)\s+at\s+(\w+)\s+for\s+(.*)\z/xmis</span>
      <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 447779159453|test2 10 limes for numbering</span>
    <span class="i">$parse_type</span> = <span class="n">6</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
        <span class="q">/^(\d{10,12}|\w+)\s+(\d+|\d+[\,\.]\d{1,2})\s+(\w+)\s+for\s+(.*)\z/xmis</span>
      <span class="s">)</span><span class="sc">;</span>

    <span class="c"># 447779159453|test2 10 limes</span>
    <span class="i">$parse_type</span> = <span class="n">7</span>
      <span class="k">if</span> <span class="s">(</span>
        <span class="i">$input</span> =~ <span class="q">/^(\d{10,12}|\w+)\s+(\d+|\d+[\,\.]\d{1,2})\s+(\w+)\z/xmis</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># touserormobile is resolved above when looking up om_users...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$currency</span><span class="sc">;</span>    <span class="c"># taken from top of package</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$2</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$2</span><span class="sc">;</span>           <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">3</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}       = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>}       = <span class="i">$currency</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}    = <span class="i">$3</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">4</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$2</span><span class="sc">;</span>    <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}    = <span class="i">$4</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">5</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$2</span><span class="sc">;</span>    <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;registryunused&#39;</span>} =
          <span class="i">$4</span><span class="sc">;</span>    <span class="c"># this is the registry unused at present</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} = <span class="i">$5</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">6</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$3</span><span class="sc">;</span>    <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} = <span class="i">$4</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">7</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =
          <span class="i">$3</span><span class="sc">;</span>    <span class="c"># FIXME: dangerous, override with $currency?</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;touserormobile&#39;</span>} = <span class="i">$1</span><span class="sc">;</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} = <span class="q">&#39;no description&#39;</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;unparsed pay transaction is:$save_input  $input&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>} =~
      <span class="q">s/\,/\./</span><span class="sc">;</span>    <span class="c"># forward with decimal point only</span>

    <span class="c"># make english language plurals singular for currency, if found...</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$language</span> <span class="k">eq</span> <span class="q">&#39;en&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =~ <span class="q">s/ies$/y/i</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>} =~ <span class="q">s/s$//i</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> \<span class="i">%transaction_description</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_check_pin">_check_pin</a></h3>
<p>put the pin checking and locking processing into one place
used by every transansaction</p>
<p>returns:
ok 	- pin checks
locked 	- account is locked
waiting - account is not activated/transaction attempt
fail	- pin fail, counts down one off counter/locks if zero</p>
<p>less than 1 is test for try count, just-in-case</p>
<pre>
<a name="_check_pin-"></a><span class="k">sub </span><span class="m">_check_pin</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$mail_error</span><span class="cm">,</span> <span class="i">$pin_status</span><span class="cm">,</span> <span class="i">$message</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$hashed_pin</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$pin</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># already locked</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">eq</span> <span class="q">&#39;locked&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
        <span class="i">$mail_error</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># ok, maybe need to reset pin tries though</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">ne</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>} <span class="k">eq</span> <span class="i">$hashed_pin</span>
            || <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$pin</span><span class="s">)</span> &gt;= <span class="n">4</span> &amp;&amp; <span class="i">$debug</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;ok&#39;</span><span class="sc">;</span>

            <span class="k">return</span> <span class="i">$pin_status</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} == <span class="n">3</span> <span class="s">)</span>
              <span class="sc">;</span>    <span class="c"># this is the main case</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>    <span class="c"># reset to three otherwise</span>

        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;fail&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="q">&#39;smspinfail&#39;</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}--<span class="sc">;</span>      <span class="c"># used one pin attempt</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="q">&quot;$registry: $messages{&#39;smslocked&#39;}&quot;</span><span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># waiting and confirm</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">ne</span> <span class="q">&#39;locked&#39;</span> <span class="s">)</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPin&#39;</span>} <span class="k">eq</span> <span class="i">$hashed_pin</span>
            || <span class="s">(</span> <span class="i">$pin</span> <span class="k">eq</span> <span class="q">&#39;1234&#39;</span> &amp;&amp; <span class="i">$debug</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="w">smspinactive</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>  <span class="c"># reset or set pin tries to 3</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;fail&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="q">&#39;smspinfail&#39;</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}--<span class="sc">;</span>    <span class="c"># used one pin attempt</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span>                       = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">0</span><span class="sc">;</span>
            <span class="i">$message</span>                          = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># anything getting to here, needs to update the user record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># send mail to registry supervisor, if pin locked</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$message</span> <span class="k">eq</span> <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registry_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="q">&#39;1&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">notify_by_mail</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span>                       <span class="i">$registry</span><span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span>                         <span class="i">$registry_ref</span>-&gt;{<span class="q">&#39;admemail&#39;</span>}<span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span>                         <span class="i">$registry_ref</span>-&gt;{<span class="q">&#39;admemail&#39;</span>}<span class="cm">,</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span>                         <span class="i">$message</span><span class="cm">,</span>
            <span class="n">6</span><span class="cm">,</span>                             <span class="k">undef</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="c"># end of send mail to registry supervisor</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$mail_error</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$pin_status</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_send_sms_mail_message">_send_sms_mail_message</a></h3>
<p>wrapper for notify_by_mail in package Cclite
with notification type 4</p>
<p>Within notify_by_mail, if net_smtp is switched on, the registry account rather
than the cclite.cf account is used for the mailout, this is preferred because
it separates 'business' between registries 11/2009</p>
<pre>
<a name="_send_sms_mail_message-"></a><span class="k">sub </span><span class="m">_send_sms_mail_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$mail_error</span><span class="cm">,</span> <span class="i">$urlstring</span><span class="cm">,</span> <span class="i">$hash</span><span class="cm">,</span> <span class="i">$smtp</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># SMS setup may not include email, so only send email if defined...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userEmail&#39;</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$mail_error</span> = <span class="i">notify_by_mail</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>
            <span class="i">$registry</span><span class="cm">,</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userName&#39;</span>}<span class="cm">,</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userEmail&#39;</span>}<span class="cm">,</span>
            <span class="i">$configuration</span>{<span class="q">&#39;systemmailaddress&#39;</span>}<span class="cm">,</span>
            <span class="i">$configuration</span>{<span class="q">&#39;systemmailreplyaddress&#39;</span>}<span class="cm">,</span>
            <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
            <span class="i">$smtp</span><span class="cm">,</span>
            <span class="i">$urlstring</span><span class="cm">,</span>
            <span class="i">$message</span><span class="cm">,</span>
            <span class="n">4</span><span class="cm">,</span>
            <span class="i">$hash</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$mail_error</span> = <span class="q">&#39;no email defined&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$mail_error</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="convert_textmarketer">convert_textmarketer</a></h3>
<p>Convert incoming fields as per textmarketer specification</p>
<p># textmarketer plugin for this message format
# this is probably not used in this module...</p>
<pre>
<a name="convert_textmarketer-"></a><span class="k">sub </span><span class="m">convert_textmarketer</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$input</span> =~ <span class="q">/^(\d+)/</span><span class="sc">;</span>    <span class="c"># this is the count for messages</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="i">$1</span><span class="sc">;</span>
    <span class="i">$input</span> =~ <span class="q">s/^(\d+)//</span><span class="sc">;</span>    <span class="c"># remove the count</span>

    <span class="k">my</span> <span class="i">@raw_messages</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\#/</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@message_hash_refs</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$raw_message</span> <span class="s">(</span><span class="i">@raw_messages</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">%message_hash</span><span class="sc">;</span>
        <span class="s">(</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;status&#39;</span>}<span class="cm">,</span>      <span class="i">$message_hash</span>{<span class="q">&#39;number&#39;</span>}<span class="cm">,</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;destination&#39;</span>}<span class="cm">,</span> <span class="i">$message_hash</span>{<span class="q">&#39;dcs&#39;</span>}<span class="cm">,</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;notused&#39;</span>}<span class="cm">,</span>     <span class="i">$message_hash</span>{<span class="q">&#39;datetime&#39;</span>}<span class="cm">,</span>
            <span class="i">$message_hash</span>{<span class="q">&#39;udh&#39;</span>}<span class="cm">,</span>         <span class="i">$message_hash</span>{<span class="q">&#39;message&#39;</span>}
        <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/:/</span><span class="cm">,</span> <span class="i">$raw_message</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$message_hash</span>{<span class="q">&#39;message&#39;</span>} = <span class="i">_hex_to_ascii</span><span class="s">(</span> <span class="i">$message_hash</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># push a reference to this onto a list to be returned</span>
        <span class="k">push</span> <span class="i">@message_hash_refs</span><span class="cm">,</span> \<span class="i">%message_hash</span><span class="sc">;</span>

    <span class="s">}</span>    <span class="c"># endof foreach</span>

    <span class="k">return</span> <span class="s">(</span><span class="i">@message_hash_refs</span><span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_send_textmarketer_sms_message">_send_textmarketer_sms_message</a></h3>
<p>This is specific to textmarketer and is therefore marked as such
Sends an sms message to confirm payment and send back balances</p>
<pre>
<a name="_send_textmarketer_sms_message-"></a><span class="k">sub </span><span class="m">_send_textmarketer_sms_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$to_user_ref</span><span class="cm">,</span>
        <span class="i">$transaction_ref</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#FIXME: add on sponsor message, if present, needs rotating etc. etc.</span>
    <span class="c">#FIXME: needs testing for 140 or below too...</span>
    <span class="k">my</span> <span class="i">$index</span> = <span class="k">rand</span><span class="s">(</span> <span class="s">(</span> <span class="k">scalar</span> <span class="i">@sms_sponsor_messages</span> <span class="s">)</span> - <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># add a sponsor message on, if there&#39;s room</span>
    <span class="k">my</span> <span class="i">$total_length</span> =
      <span class="k">length</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> + <span class="k">length</span><span class="s">(</span> <span class="i">$sms_sponsor_messages</span>[<span class="i">$index</span>] <span class="s">)</span><span class="sc">;</span>
    <span class="i">$message</span> .= <span class="i">$sms_sponsor_messages</span>[<span class="i">$index</span>]
      <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span> <span class="i">@sms_sponsor_messages</span> &amp;&amp; <span class="i">$total_length</span> &lt;= <span class="n">140</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">debug</span><span class="s">(</span> <span class="q">&quot;message is $message&quot;</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># url escape setup message text</span>
    <span class="i">$message</span> = <span class="i">CGI::escape</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$preamble</span> =
<span class="q">&quot;$sms_configuration{&#39;sms_url&#39;}?username=$sms_configuration{&#39;user&#39;}&amp;password=$sms_configuration{&#39;password&#39;}&quot;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$urlstring</span><span class="sc">;</span>

    <span class="c"># makes ccdalston, cclimehouse for index entry on phone etc. but truncates</span>
    <span class="k">my</span> <span class="i">$orig</span> = <span class="i">$sms_configuration</span>{<span class="q">&#39;orig&#39;</span>} . <span class="i">$registry</span><span class="sc">;</span>
    <span class="i">$orig</span> = <span class="k">substr</span><span class="s">(</span> <span class="i">$orig</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">11</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$orig</span><span class="s">)</span> &gt; <span class="n">11</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># credits and pinchanges are notified to the user receiving them...</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;credit&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$urlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$preamble&amp;number=$to_user_ref-&gt;{&#39;userMobile&#39;}&amp;message=$message&amp;orig=$orig&amp;custom=$orig&amp;option=$sms_configuration{&#39;option&#39;}</span>

<span class="h">EOT</span>

    <span class="s">}</span>

<span class="c"># other operations are reported back to the originating user, including failed credit attempts (error type)</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> =~ <span class="q">/balance|join|suspend|language|error|pinchange/</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$urlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$preamble&amp;number=$from_user_ref-&gt;{&#39;userMobile&#39;}&amp;message=$message&amp;orig=$orig&amp;custom=$orig&amp;option=$sms_configuration{&#39;option&#39;}</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$mess</span> = <span class="q">&quot;unknown or unimplemented sms type: $type&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$mess</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$mess&quot;</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># use LWP to send an SMS message via the cardborardfish gateway...</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$http_response</span><span class="s">)</span> = <span class="i">__outbound_textmarketer_http_sms</span><span class="s">(</span><span class="i">$urlstring</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$ret</span> = <span class="i">$http_response</span><span class="i">-&gt;code</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$http_response</span><span class="i">-&gt;code</span> == <span class="n">200</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$x</span> = <span class="i">$http_response</span><span class="i">-&gt;decoded_content</span><span class="sc">;</span>
        <span class="i">debug</span><span class="s">(</span> <span class="q">&quot;return content is $x&quot;</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">_charge_one_sms_unit</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span>
            <span class="i">$transaction_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$x</span> = <span class="i">$http_response</span><span class="i">-&gt;status_line</span><span class="sc">;</span>
        <span class="i">debug</span><span class="s">(</span> <span class="q">&quot;status line is $x&quot;</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;$messages{smserror} $http_response-&gt;code&quot;</span><span class="sc">;</span>
        <span class="i">log_entry</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&quot;nok:$message&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="__outbound_textmarketer_http_sms">__outbound_textmarketer_http_sms</a></h3>
<p>Send the SMS message via a web transaction at carboardfish</p>
<pre>
<a name="__outbound_textmarketer_http_sms-"></a><span class="k">sub </span><span class="m">__outbound_textmarketer_http_sms</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$sms_url</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">debug</span><span class="s">(</span> <span class="i">$sms_url</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$debug</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;OK exiting&lt;\br&gt;\n&quot;</span><span class="sc">;</span>
        <span class="i">debug</span><span class="s">(</span> <span class="q">&quot;debug level $debug exiting&quot;</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$ua</span><span class="i">-&gt;agent</span><span class="s">(</span><span class="q">&quot;cclite\/$configuration{&#39;version&#39;}&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#$ua-&gt;timeout(10);</span>
    <span class="k">my</span> <span class="i">$response</span> = <span class="i">$ua</span><span class="i">-&gt;get</span><span class="s">(</span><span class="i">$sms_url</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span><span class="i">$response</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_charge_one_sms_unit">_charge_one_sms_unit</a></h3>
<p>Transfer an SMS unit from the transaction number to sysaccount
to account for the sent SMS</p>
<p>$type is 'credit' or 'balance' at present. In the case of balance
need to build up a few transaction fields to charge it..always charged
to number and monies put into sysaccount...</p>
<p>FIXME: A number of other things are charged for now, need to
improve the messages below when charging</p>
<pre>
<a name="_charge_one_sms_unit-"></a><span class="k">sub </span><span class="m">_charge_one_sms_unit</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$from_user_ref</span><span class="cm">,</span> <span class="i">$transaction_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># for balances, extra fields to fill in are filled anyway by a credit</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#subaction : om_trades</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;subaction&#39;</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;fromregistry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;toregistry&#39;</span>} = <span class="i">$registry</span><span class="sc">;</span>

        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeDescription&#39;</span>} =
          <span class="q">&quot;$messages{&#39;smsdebitfor&#39;} $type&quot;</span><span class="sc">;</span>

        <span class="c">#tradeSource : manager</span>
        <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeSource&#39;</span>} = <span class="i">$from_user_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="sc">;</span>

    <span class="s">}</span>

<span class="c">#FIXME: tradeItem not really identifiable from sms message/possible tax problem too!</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeItem&#39;</span>} = <span class="q">&#39;other&#39;</span><span class="sc">;</span>

 <span class="c">#FIXME: mode for this is csv, this is part of a general format upgrade later...</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} = <span class="q">&#39;csv&#39;</span><span class="sc">;</span>

    <span class="c">#FIXME: tradestatus is always accepted for sms-debit</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeStatus&#39;</span>} = <span class="q">&#39;accepted&#39;</span><span class="sc">;</span>

    <span class="c"># if HTTP 200, sent OK charge receipt to one unit of sms currency...</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeAmount&#39;</span>}   = <span class="q">&#39;1&#39;</span><span class="sc">;</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeCurrency&#39;</span>} = <span class="q">&#39;sms&#39;</span><span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeDate&#39;</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#tradeTitle : sms debit for sms receipt</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeTitle&#39;</span>} =
      <span class="q">&quot;$messages{&#39;smsdebitfor&#39;} $messages{&#39;smstransactiontitle&#39;}&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDestination : sysadmin is credited in sms currency</span>
    <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeDestination&#39;</span>} = <span class="q">&#39;sysaccount&#39;</span><span class="sc">;</span>

    <span class="c">#FIXME: this should be passed into this subsystem, really...</span>
    <span class="k">my</span> <span class="i">$token</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$trans_error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;fromregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<a name="_ascii_to_hex-"></a><span class="k">sub </span><span class="m">_ascii_to_hex ($)</span> <span class="s">{</span>
    <span class="c">## Convert each ASCII character to a two-digit hex number.</span>
    <span class="s">(</span> <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span> <span class="s">)</span> =~ <span class="q">s/(.|\n)/sprintf(&quot;%02lx&quot;, ord $1)/eg</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$str</span><span class="sc">;</span>
<span class="s">}</span>

<a name="_hex_to_ascii-"></a><span class="k">sub </span><span class="m">_hex_to_ascii ($)</span> <span class="s">{</span>
    <span class="c">## Convert each two-digit hex number back to an ASCII character.</span>
    <span class="s">(</span> <span class="k">my</span> <span class="i">$str</span> = <span class="k">shift</span> <span class="s">)</span> =~ <span class="q">s/([a-fA-F0-9]{2})/chr(hex $1)/eg</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$str</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_check_digit_iso_7064">_check_digit_iso_7064</a></h3>
<p>slightly modified bloodbank check digit scheme
since alphas go in, alphas should come out...</p>
<p>FIXME: this needs debugging...</p>
<pre>
<a name="_check_digit_iso_7064-"></a><span class="k">sub </span><span class="m">_check_digit_iso_7064</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%lookup</span> = <span class="q">qw(0 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 8 8 9 9 0 0</span>
      <span class="q">a 10 b 11 c 12 d 13 e 14 f 15 g 16 h 17 i 18 j 19 k 20 l 21 m 22</span>
      <span class="q">n 23 o 24 p 25 q 26 r 27</span>
      <span class="q">s 28 t 29 u 20 v 31 w 32 x 33 y 34 z 35)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%out_digits</span> = <span class="k">reverse</span><span class="s">(</span><span class="i">%lookup</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@characters</span> = <span class="k">split</span><span class="s">(</span> <span class="q">//</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$weight</span> = <span class="k">length</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sum</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$character</span> <span class="s">(</span> <span class="k">shift</span> <span class="i">@characters</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c">#FIXME: doesn&#39;t deal with rogue characters...</span>
        <span class="i">$sum</span> += <span class="i">$lookup</span>{<span class="i">$character</span>} * <span class="n">2</span>**<span class="i">$weight</span><span class="sc">;</span>
        <span class="i">$weight</span>--<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$check_digit</span> = <span class="n">38</span> - <span class="s">(</span> <span class="i">$sum</span> % <span class="n">37</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$out_digits</span>{<span class="i">$check_digit</span>}<span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="_generate_password">_generate_password</a></h3>
<p>Generate simple password and pin for setup
needs to be changed afterwards..</p>
<pre>
<a name="_generate_password-"></a><span class="k">sub </span><span class="m">_generate_password</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$length</span>   = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$possible</span> = <span class="q">&#39;abcdefghjkmnqrstuvwxyz&#39;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$password</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$password</span><span class="s">)</span> &lt; <span class="i">$length</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$password</span> .=
          <span class="k">substr</span><span class="s">(</span> <span class="i">$possible</span><span class="cm">,</span> <span class="s">(</span> <span class="k">int</span><span class="s">(</span> <span class="k">rand</span><span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$possible</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span> <span class="s">)</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$password</span><span class="sc">;</span>
<span class="s">}</span>

</pre>
<p>
</p>
<h3><a name="debug">debug</a></h3>
<p>Deep debug...</p>

<pre>
<a name="debug-"></a><span class="k">sub </span><span class="m">debug</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pretty</span> = <span class="i">pretty_status</span><span class="s">(</span> <span class="n">3</span><span class="cm">,</span> <span class="q">&#39;OK&#39;</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$debug</span><span class="s">)</span> <span class="s">{</span>

        <span class="c"># just check that it&#39;s being accessed for the moment...</span>
        <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$debug_file</span><span class="cm">,</span> <span class="q">&#39;&gt;&gt;&#39;</span><span class="cm">,</span> <span class="i">$sms_configuration</span>{<span class="q">&#39;debug_file&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>    <span class="c"># Before writing!</span>

        <span class="k">print</span> <span class="i">$debug_file</span> <span class="i">$pretty</span> . <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$debug_file</span> <span class="q">&quot;$time-&gt; message is $message\n&quot;</span>
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$debug_file</span> <span class="q">&quot;$time-&gt; hash&quot;</span> . <span class="w">Dumper</span> <span class="i">$hash_ref</span>
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$hash_ref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$debug_file</span> <span class="q">&quot;-------------------------\n\n&quot;</span><span class="sc">;</span>
        <span class="k">close</span> <span class="i">$debug_file</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>

<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
