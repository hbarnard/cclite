<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccinterfaces.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccinterfaces.pm</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#sms_transaction">sms_transaction</a></li>
			<li><a href="#read_mail_transactions">read_mail_transactions</a></li>
			<li><a href="#read_csv_transactions">read_csv_transactions</a></li>
		</ul>

		<li><a href="#_prettify_dumper">_prettify_dumper</a></li>
		<ul>

			<li><a href="#oscommerce_transaction">oscommerce_transaction</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccinterfaces-">package Ccinterfaces</a>
<ul>
<li><a href="#sms_transaction-">sms_transaction</a></li>
<li><a href="#read_mail_transactions-">read_mail_transactions</a></li>
<li><a href="#read_csv_transactions-">read_csv_transactions</a></li>
<li><a href="#_prettify_dumper-">_prettify_dumper</a></li>
<li><a href="#oscommerce_transaction-">oscommerce_transaction</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccinterfaces.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for sms, mail etc.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains interfaces for mail and SMS to be used by demons
It also contains currently abandoned work for touch-tone
If there's smart card, it'll go here</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccinterfaces-"></a><span class="k">package </span><span class="i">Ccinterfaces</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Data::Dumper</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="c">###use Encode qw(encode decode);</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(sms_transaction</span>
  <span class="q">sms_message_parse</span>
  <span class="q">oscommerce_transaction</span>
  <span class="q">read_mail_transactions</span>
  <span class="q">read_csv_transactions</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash</p>
<pre>

=cut</pre>
<pre>
<span class="c"># language of messages decided now by Ccu::decide_language</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="sms_transaction">sms_transaction</a></h3>
<p>This accepts an SMS  transaction and reformats it into
an ordinary one. It therefore has to do a mobile phone to user name
look up, data reformatting etc.</p>
<p>Mobile phone numbers must have the internation prefix 44.... etc.
This is to enable wide-area registries at some stage...</p>
<p>This will use up a credit, so mabye it should be configured.
This will only go registry-a to registry-a, at present
when you say 'at' it's assumed that the to and from registries
at the same</p>
<p>Text messaging transfer is allowed home -&gt; remote
more expressivity in the message and auth via phone number
For example mobile number 1234 text message:
--------------------------------------------------------------
  1234: [send|snd] 4 duckets to ddawg at dalston for
         advertising and computer help
--------------------------------------------------------------</p>
<pre>
<a name="sms_transaction-"></a><span class="k">sub </span><span class="m">sms_transaction</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$mobilenumber</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c"># mobile number + raw string</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># return values for screen, not really used by scripts</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c">### $input = decode( &#39;UCS-2&#39;, lc($input) );  # if sms is stored as unicode</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$found_count</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
      <span class="i">sms_message_parse</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="q">&#39;sms incomplete message error&#39;</span><span class="cm">,</span>
        <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$found_count</span> &lt; <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction_description</span> = <span class="i">%$transaction_description_ref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span> <span class="i">$mobilenumber</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;toregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;touser&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>          <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;name&#39;</span><span class="cm">,</span>          <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span>          <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># one of the above lookups fails, reject the whole transaction</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
        || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
        || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="q">&#39;sms database lookup error&#39;</span><span class="cm">,</span>
            <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>}<span class="sc">;</span>

    <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
    <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>            <span class="c"># no home, not a web transaction</span>
                                             <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;toregistry&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeCurrency : ducket</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#FIXME: should be multilingual tradeTitle : added by this routine</span>
    <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="q">&quot;SMS transaction: see description&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDescription</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$$touserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#tradeItem : test to see variables</span>
    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#FIXME: this should be taken from a configuration file</span>
    <span class="i">$transaction</span>{<span class="w">initialPaymentStatus</span>} = <span class="q">&#39;waiting&#39;</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="read_mail_transactions">read_mail_transactions</a></h3>
<p>This accepts a /var/spool/mail/xxx and reformats it into
a set of transactions. It therefore has to do a email address to user name
look up, data reformatting etc.</p>
<p>This will only go registry-a to registry-a, at present
when you say 'at' it's assumed that the to and from registries
are the same</p>
<pre>

example mail text
--------------------------------------------------------------
        [send|snd] 4 duckets to ddawg at dalston for
         advertising and computer help
--------------------------------------------------------------</pre>
<p>This will move to GPG encoded mail at -some- stage, real soon now...</p>
<p>This is probably replaced by Ccmailgateway now, reads via POP3 11/2009</p>
<pre>
<a name="read_mail_transactions-"></a><span class="k">sub </span><span class="m">read_mail_transactions</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$mail_file</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$messages</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c"># parse the mail file into messages</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%subject</span><span class="cm">,</span> <span class="i">%from</span><span class="cm">,</span> <span class="i">%message</span><span class="cm">,</span> <span class="i">$fromregistry</span><span class="cm">,</span> <span class="i">$toregistry</span><span class="cm">,</span> <span class="i">$counter</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">### From: &quot;Hugh Barnard&quot; &lt;hugh.barnard@hughbarnard.org&gt;</span>

    <span class="c"># mail file format is &lt;toregistry&gt;.cclite, registry is parsed out</span>
    <span class="i">$mail_file</span> =~ <span class="q">/\057([^\057]+)\056cclite$/</span><span class="sc">;</span>
    <span class="i">$fromregistry</span> = <span class="i">$toregistry</span> = <span class="i">$1</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">MAIL</span><span class="cm">,</span> <span class="i">$mail_file</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$/</span> = <span class="q">&#39;&#39;</span><span class="sc">;</span>    <span class="c"># read paragraphs</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;MAIL&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span><span class="q">/^From/</span><span class="s">)</span> <span class="s">{</span>
            <span class="q">/^Subject:\s*(?:Re:\s*)*(.*)/mi</span><span class="sc">;</span>
            <span class="i">$counter</span>++<span class="sc">;</span>
            <span class="i">$subject</span>{<span class="i">$counter</span>} = <span class="i">$1</span><span class="sc">;</span>
            <span class="q">/From\:.*\&lt;(.*)\&gt;/m</span><span class="sc">;</span>
            <span class="i">$from</span>{<span class="i">$counter</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="s">}</span>       <span class="c"># endif</span>
        <span class="i">$message</span>{<span class="i">$counter</span>} .= <span class="i">$_</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># endwhile</span>
    <span class="k">close</span><span class="s">(</span><span class="w">MAIL</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%subject</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$message</span>{<span class="i">$key</span>} <span class="s">)</span><span class="sc">;</span>      <span class="c"># canonical is lower case</span>
        <span class="k">my</span> <span class="i">@words</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\s+/m</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># fuzzy ark parsing the terms mainly go two-by-two!</span>

        <span class="k">my</span> <span class="i">$counter</span> = <span class="n">0</span><span class="sc">;</span>                       <span class="c"># used for term lookahead</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$description</span><span class="cm">,</span> <span class="i">$currency</span><span class="cm">,</span> <span class="i">$quantity</span><span class="cm">,</span> <span class="i">$touser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$word</span> <span class="s">(</span><span class="i">@words</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> =~ <span class="q">/^(\d+)$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$quantity</span> = <span class="i">$word</span><span class="sc">;</span>    <span class="c"># quantity is the only numeric thing</span>
                <span class="i">$currency</span> =
                  <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>    <span class="c"># currency is next to quantity</span>
                <span class="i">$currency</span> =~ <span class="q">s/s$//</span><span class="sc">;</span>             <span class="c"># singulate or deplural...</span>
            <span class="s">}</span>

            <span class="c"># deals with yahoo footer etc. stupid format though</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> <span class="k">eq</span> <span class="q">&quot;to&quot;</span> &amp;&amp; !<span class="k">length</span><span class="s">(</span><span class="i">$touser</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># found &#39;to&#39;</span>
                <span class="i">$touser</span> = <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>     <span class="c"># touser is next</span>
            <span class="s">}</span>
            <span class="i">$counter</span>++<span class="sc">;</span>
        <span class="s">}</span>
        <span class="s">(</span><span class="i">$description</span><span class="s">)</span> =
          <span class="i">$input</span> =~ <span class="q">/for\s+(\w.*)$/mi</span><span class="sc">;</span>    <span class="c"># description is everything at end</span>
            <span class="c"># look up sending user, receiving user and currency</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>      <span class="i">$fromregistry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
            <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span> <span class="i">$from</span>{<span class="i">$key</span>}<span class="cm">,</span>   <span class="i">$token</span><span class="cm">,</span>     <span class="i">$offset</span><span class="cm">,</span>
            <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>      <span class="i">$toregistry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
            <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$touser</span><span class="cm">,</span>     <span class="i">$token</span><span class="cm">,</span>     <span class="i">$offset</span><span class="cm">,</span>
            <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$fromregistry</span><span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
            <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$currency</span><span class="cm">,</span>     <span class="i">$token</span><span class="cm">,</span>          <span class="i">$offset</span><span class="cm">,</span>
            <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="c"># one of the above lookups fails, reject the whole transaction</span>
        <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
            || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
            || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="c">###send_mail_message($from{$key},&quot;transaction invalid: $input&quot;) ;</span>
        <span class="s">}</span>

        <span class="c"># convert to standard transaction input format, fields etc.</span>
        <span class="c">#fromregistry : chelsea</span>
        <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$fromregistry</span><span class="sc">;</span>

        <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
        <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>           <span class="c"># no home, not a web transaction</span>
                                                <span class="c">#subaction : om_trades</span>
        <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$toregistry</span><span class="sc">;</span>

        <span class="c">#tradeAmount : 23</span>
        <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$quantity</span><span class="sc">;</span>

        <span class="c">#tradeCurrency : ducket</span>
        <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

        <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

        <span class="c">#tradeTitle : added by this routine</span>
        <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="q">&quot;Mail transaction: see description&quot;</span><span class="sc">;</span>

        <span class="c">#tradeDescription</span>
        <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$description</span><span class="sc">;</span>

        <span class="c">#tradeDestination : ddawg</span>
        <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$$touserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

        <span class="c">#tradeItem : test to see variables</span>
        <span class="c">#tradeSource : manager</span>
        <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

        <span class="c"># call ordinary transaction</span>
        <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
          <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;mail&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>                     <span class="c"># end of each on letters</span>
    <span class="k">unlink</span> <span class="i">$mail_file</span><span class="sc">;</span>    <span class="c"># delete mail file when read</span>

    <span class="c"># need to decide how this returns, processes multiple transactions</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$messages</span><span class="cm">,</span> <span class="q">&#39;result.html&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="read_csv_transactions">read_csv_transactions</a></h3>
<p>This accepts a /var/cclite/xxx.csv and reformats it into
a set of transactions.</p>
<p>Prints a new file showing accepted transactions and rejected ones</p>
<p>example text
   0 date     1 from 2 to	3 fromreg 4 toreg  5 currency 6 type 7 taxflag  8 amount   9 description
&quot;10-04-2005&quot;,&quot;ddawg&quot;,&quot;manager&quot;,&quot;dalston&quot;,&quot;dalston&quot;,&quot;ducket&quot;,&quot;credit&quot;,&quot;N&quot;,345,&quot;test1&quot;
This will move to GPG encoded at -some- stage</p>
<pre>

   04/10/2009,&quot;test1&quot;,&quot;test2&quot;,&quot;dalston&quot;,&quot;dalston&quot;,&quot;dally&quot;,&quot;credit&quot;,&quot;N&quot;,345,&quot;batch test&quot;</pre>
<pre>
   'tradeSource' =&gt; 'test1', 'tradeDestination' =&gt; 'test2', 'tradeDescription' =&gt; 'batch test', 
   'tradeTaxflag' =&gt; 'N', 'initialPaymentStatus' =&gt; 'waiting', 
   'tradeTitle' =&gt; 'Batch transaction: see description', 'tradeDate' =&gt; '2009-10-04', 
   'fromregistry' =&gt; 'dalston', 'subaction' =&gt; 'om_trades', 'toregistry' =&gt; 'dalston', 
   'tradeCurrency' =&gt; 'dally', 'tradeAmount' =&gt; '345', 'home' =&gt; ''</pre>
<p>Note that $db is empty, the registries are declared in the transactions
themselves. It's there to keep the function signatures consistent.</p>
<p>Skip # lines which are expected to be comments. Only allow debits, currently.</p>
<pre>
<a name="read_csv_transactions-"></a><span class="k">sub </span><span class="m">read_csv_transactions</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>                <span class="i">$table</span><span class="cm">,</span>      <span class="i">$csv_file</span><span class="cm">,</span>
        <span class="i">$file_name</span><span class="cm">,</span> <span class="i">$configuration_ref</span><span class="cm">,</span> <span class="i">$fields_ref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
        <span class="i">$offset</span><span class="cm">,</span>    <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error_count</span><span class="cm">,</span> <span class="i">$success_count</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">CSV</span><span class="cm">,</span> <span class="i">$csv_file</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;can\&#39;t open csv file: $csv_file&quot;</span><span class="sc">;</span>

    <span class="c"># timestamp output files so that they don&#39;t get confused</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$numeric_date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># results written per registry now...11/2009</span>
    <span class="k">my</span> <span class="i">$results_out</span> =
<span class="q">&quot;$$configuration_ref{csvout}/$db/$file_name\056$numeric_date$time\056html&quot;</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">OUT</span><span class="cm">,</span> <span class="q">&quot;&gt;$results_out&quot;</span> <span class="s">)</span>
      <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;can\&#39;t open csv output file: $results_out&quot;</span><span class="sc">;</span>

    <span class="k">print</span> <span class="i">OUT</span> <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;html&gt;</span>
<span class="hh">&lt;head&gt;    </span>
<span class="hh">      &lt;link href=&quot;/styles/default.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;    </span>
<span class="hh">&lt;title&gt;$db $numeric_date$time&lt;/title&gt;    </span>
<span class="hh">&lt;/head&gt;</span>
<span class="hh">&lt;body&gt;    </span>
<span class="h">EOT</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;CSV&gt;</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="s">(</span>
            <span class="i">$messages</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span>        <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
            <span class="i">%error</span><span class="cm">,</span>    <span class="i">$save</span><span class="cm">,</span>   <span class="i">$bad_registry</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">%transaction</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="q">s/&quot;//g</span><span class="sc">;</span>    <span class="c"># remove quotes</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span><span class="q">/^#|^\s/</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># skip comment lines/header and space lines</span>

        <span class="k">chop</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$save</span> = <span class="i">$_</span><span class="sc">;</span>

        <span class="c"># if the from registry is bad currency lookup etc. won&#39;t work...</span>
        <span class="i">$bad_registry</span> = <span class="n">0</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@transaction_array</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\,/</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># from registry must be same as to registry for the moment, too much</span>
        <span class="c"># complexity doing batch to remote 03/2012</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_array</span>[<span class="n">3</span>] <span class="k">ne</span> <span class="i">$transaction_array</span>[<span class="n">4</span>] <span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;fromregistry&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
            <span class="i">$error</span>{<span class="q">&#39;toregistry&#39;</span>}   = <span class="q">&#39;y&#39;</span><span class="sc">;</span>

        <span class="s">}</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$dberror</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>      <span class="i">$transaction_array</span>[<span class="n">3</span>]<span class="cm">,</span>
            <span class="q">&#39;om_users&#39;</span><span class="cm">,</span>  <span class="q">&#39;*&#39;</span><span class="cm">,</span>
            <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$transaction_array</span>[<span class="n">1</span>]<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span>      <span class="i">$offset</span><span class="cm">,</span>
            <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dberror</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;fromregistry&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
            <span class="i">$bad_registry</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># test destination user in same registry, remote currently not allowed</span>
        <span class="k">my</span> <span class="i">$touserref</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$bad_registry</span> <span class="s">)</span> <span class="s">{</span>

            <span class="s">(</span> <span class="i">$dberror</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
                <span class="i">$class</span><span class="cm">,</span>      <span class="i">$transaction_array</span>[<span class="n">4</span>]<span class="cm">,</span>
                <span class="q">&#39;om_users&#39;</span><span class="cm">,</span>  <span class="q">&#39;*&#39;</span><span class="cm">,</span>
                <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$transaction_array</span>[<span class="n">2</span>]<span class="cm">,</span>
                <span class="i">$token</span><span class="cm">,</span>      <span class="i">$offset</span><span class="cm">,</span>
                <span class="i">$limit</span>
            <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>

        <span class="c"># to user is invalid or absent</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> &amp;&amp; !<span class="i">$bad_registry</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;tradeDestination&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># fail on currency not within this registry, cannot succeed</span>
        <span class="k">my</span> <span class="i">$currencyref</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$bad_registry</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$dberror</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
                <span class="i">$class</span><span class="cm">,</span>          <span class="i">$transaction_array</span>[<span class="n">3</span>]<span class="cm">,</span>
                <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
                <span class="q">&#39;name&#39;</span><span class="cm">,</span>          <span class="i">$transaction_array</span>[<span class="n">5</span>]<span class="cm">,</span>
                <span class="i">$token</span><span class="cm">,</span>          <span class="i">$offset</span><span class="cm">,</span>
                <span class="i">$limit</span>
            <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># one of the above lookups fails, reject the whole transaction</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> &amp;&amp; !<span class="i">$bad_registry</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;tradeSource&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span> &amp;&amp; !<span class="i">$bad_registry</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;tradeCurrency&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># only debit transactions allowed at present, tradeType is NOT</span>
        <span class="c"># part of a genuine transaction, at present!</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_array</span>[<span class="n">6</span>] <span class="k">ne</span> <span class="q">&#39;debit&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;tradeType&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
            <span class="i">$transaction</span>{<span class="w">tradeType</span>} = <span class="i">$messages</span>{<span class="q">&#39;notadebit&#39;</span>}<span class="sc">;</span>
        <span class="s">}</span>

  <span class="c"># tradeAmount only contains numbers and decimal points, allow 123.1 for moment</span>
        <span class="k">if</span> <span class="s">(</span>   <span class="i">$transaction_array</span>[<span class="n">8</span>] !~ <span class="q">/^\d+$/</span>
            &amp;&amp; <span class="i">$transaction_array</span>[<span class="n">8</span>] !~ <span class="q">/^\d+\.\d{1,2}$/</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;tradeAmount&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># convert to standard transaction input format, fields etc.</span>
        <span class="c">#fromregistry : chelsea</span>
        <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$transaction_array</span>[<span class="n">3</span>]<span class="sc">;</span>

      <span class="c"># home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
      <span class="c"># $transaction{home}      = &quot;&quot;;           # no home, not a web transaction</span>

        <span class="c"># subaction : om_trades</span>
        <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$transaction_array</span>[<span class="n">4</span>]<span class="sc">;</span>

        <span class="c">#tradeAmount : 23</span>
        <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$transaction_array</span>[<span class="n">8</span>]<span class="sc">;</span>

        <span class="c">#tradeCurrency : ducket</span>
        <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$transaction_array</span>[<span class="n">5</span>]<span class="sc">;</span>

        <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># read from configuration file in cron job</span>
        <span class="i">$transaction</span>{<span class="w">initialPaymentStatus</span>} =
          <span class="i">$configuration_ref</span>-&gt;{<span class="q">&#39;initialpaymentstatus&#39;</span>}<span class="sc">;</span>

        <span class="c">#validate and reformat date ;</span>
        <span class="k">my</span> <span class="i">$tdate</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_array</span>[<span class="n">0</span>] =~ <span class="q">m/(\d\d)\D(\d\d)\D(\d\d\d\d)/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$tdate</span> = <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$3</span><span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> ? <span class="i">$transaction_array</span>[<span class="n">0</span>] <span class="co">:</span> <span class="q">&quot;$3-$2-$1&quot;</span><span class="sc">;</span>
            <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$tdate</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$error</span>{<span class="q">&#39;tradeDate&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
            <span class="i">$transaction</span>{<span class="w">tradeDate</span>} =
              <span class="q">&quot;&lt;span class=\&quot;failedcheck\&quot;&gt;$transaction_array[0]&lt;/span&gt;&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">#tradeTitle : added by this routine</span>
        <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="i">$messages</span>{<span class="w">batchtransaction</span>}<span class="sc">;</span>

        <span class="c">#tradeDescription</span>
        <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$transaction_array</span>[<span class="n">9</span>]<span class="sc">;</span>

        <span class="c">#tradeDestination : ddawg</span>
        <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$transaction_array</span>[<span class="n">2</span>]<span class="sc">;</span>

        <span class="c">#tradeItem : test to see variables</span>
        <span class="c">#tradeSource : manager</span>
        <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$transaction_array</span>[<span class="n">1</span>]<span class="sc">;</span>

        <span class="c"># this is new 01/2006 and needs adding everywhere</span>
        <span class="i">$transaction</span>{<span class="w">tradeTaxflag</span>} = <span class="i">$transaction_array</span>[<span class="n">7</span>]<span class="sc">;</span>

        <span class="c"># call ordinary transaction</span>
        <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%error</span> <span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># json is the default for this...</span>
            <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} = <span class="i">$fields_ref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} || <span class="q">&#39;json&#39;</span><span class="sc">;</span>

            <span class="c">#FIXME: transaction has two return signatures</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;mode&#39;</span>} <span class="k">ne</span> <span class="q">&#39;json&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
                  <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;batch&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
                    <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                <span class="s">(</span><span class="i">$output_message</span><span class="s">)</span> =
                  <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;batch&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
                    <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>

            <span class="k">print</span> <span class="q">&quot;$output_message \n&quot;</span><span class="sc">;</span>

            <span class="c"># data is OK but there&#39;s something wrong during the transaction</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$transaction_ref</span>-&gt;{<span class="q">&#39;tradeError&#39;</span>} =
                  <span class="q">&#39;&lt;span class=\&quot;failedcheck\&quot;&gt;$error&lt;/span&gt;&#39;</span><span class="sc">;</span>
                <span class="i">$error</span>{<span class="q">&#39;tradeError&#39;</span>} = <span class="q">&#39;y&#39;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c"># add a message to the output transaction and print in output file</span>
        <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span> <span class="k">keys</span> <span class="i">%error</span> <span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%error</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$transaction_ref</span>-&gt;{<span class="i">$key</span>} =
                  <span class="q">&quot;&lt;span class=\&quot;failedcheck\&quot;&gt;$transaction_ref-&gt;{$key}&lt;/span&gt;&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$message</span> =
<span class="q">&quot;&lt;span class=\&quot;failedcheck\&quot;&gt;$messages{transactionrejected}&lt;/span&gt;&quot;</span><span class="sc">;</span>
            <span class="i">$error_count</span>++<span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$message</span> = <span class="i">$messages</span>{<span class="w">transactionaccepted</span>}<span class="sc">;</span>
            <span class="i">$success_count</span>++<span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$x</span> = <span class="w">Dumper</span> <span class="i">$transaction_ref</span> <span class="sc">;</span>

        <span class="k">print</span> <span class="i">OUT</span> <span class="i">_prettify_dumper</span><span class="s">(</span><span class="i">$x</span><span class="s">)</span> . <span class="i">$message</span> . <span class="q">&#39;&lt;br/&gt;&lt;br/&gt;&#39;</span><span class="sc">;</span>

    <span class="s">}</span>    <span class="c"># end of while on csv files</span>

    <span class="k">my</span> <span class="i">%report</span> = <span class="s">(</span> <span class="q">&#39;success&#39;</span><span class="cm">,</span> <span class="i">$success_count</span><span class="cm">,</span> <span class="q">&#39;error&#39;</span><span class="cm">,</span> <span class="i">$error_count</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># need to decide how this returns, processes multiple transactions</span>
    <span class="k">return</span> <span class="s">(</span> \<span class="i">%report</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h2><a name="_prettify_dumper">_prettify_dumper</a></h2>
<p>miniature hack to get dumper output nicer to keep a record
for csv transactions but could be useful later for other batchy
stuff</p>
<pre>
<a name="_prettify_dumper-"></a><span class="k">sub </span><span class="m">_prettify_dumper</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$x</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#$x =~ s/\,//g ;</span>
    <span class="i">$x</span> =~ <span class="q">s/^([^\{]+)\{//g</span><span class="sc">;</span>
    <span class="i">$x</span> =~ <span class="q">s/\}\;//g</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$x</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="oscommerce_transaction">oscommerce_transaction</a></h3>
<p>transaction from oscommerce, authorised with merchantkey
this is a work in progress at present.</p>
<p>Several transactions are generated depending on the (Cclite) user
in the OsCommerce manufacturer fields. This is the 'link' between the two systems</p>
<p>Currently there's still work to be
done to generate a merchant key: hotbits + hashing probably for the moment.</p>

<pre>
<a name="oscommerce_transaction-"></a><span class="k">sub </span><span class="m">oscommerce_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$ok</span><span class="cm">,</span> <span class="i">%transaction</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>    <span class="c"># for code simplicity, really</span>

<span class="c"># test whether the merchant key from the interface = that stored in the registry</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$merror</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>         <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span>  <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;merchant_key&#39;</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">merchant_key</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span>         <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># deduce paying &#39;shopper&#39; from email address sent from osCommerce</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$uerror</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>      <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span>
        <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">email</span>}<span class="cm">,</span>    <span class="i">$token</span><span class="cm">,</span>     <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># (new 2007) get list of allowed IP addresses for oscommerce and</span>
    <span class="c"># for straight through RESTful transactions. no list = anything goes!</span>

    <span class="k">my</span> <span class="i">@allowed_ips</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\s+/</span><span class="cm">,</span> <span class="i">$$registryref</span>{<span class="w">allowed_ip_list</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># loop through allowed ips</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@allowed_ips</span><span class="s">)</span> &gt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$found</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$ip</span> <span class="s">(</span><span class="i">@allowed_ips</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$ip</span> <span class="k">eq</span> <span class="i">$$fieldsref</span>{<span class="w">client_ip</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
                <span class="k">last</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">print</span> <span class="q">&quot;Location: $fields{cancel_url}&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$found</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># deduce currency from currency symbol sent from osCommerce : only one allowed at present</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$cerror</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;code&#39;</span><span class="cm">,</span>
        <span class="i">$fields</span>{<span class="w">currency_code</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;cclite $fields{version} gateway &quot;</span><span class="sc">;</span>

    <span class="c"># invalid &#39;from&#39; user or invalid currency, returns straight away</span>
    <span class="k">if</span> <span class="s">(</span>   !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span>
        || !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span>
        || !<span class="k">length</span><span class="s">(</span><span class="i">$registryref</span><span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$message</span> .= <span class="q">&quot;$messages{merchantkeyerror}:&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$registryref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;$messages{notregisterederror}-&gt;$fields{email}:&quot;</span>
          <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;$messages{currencysymbolerror}-&gt;$fields{currency_code}:&quot;</span>
          <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span>
<span class="q">&quot;Location: $fields{cancel_url}?$fields{osCsid}&amp;payment_error=1&amp;error_message=$message\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># now construct and do a transaction for each &#39;manufacturer&#39; who is, in fact a Cclite &#39;userLogin&#39;</span>
<span class="c"># from om_users, each to payment is of form &quot;to:userLogin&quot;</span>
<span class="c"># this is two-pass, it needs to make sure that ALL the users (manufacturers) are</span>
<span class="c"># present otherwise it won&#39;t process ANY of the order. This is cleaner than</span>
<span class="c"># partially processing the order.</span>
<span class="c">#</span>
    <span class="i">$ok</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/^to:(\w+)/</span> &amp;&amp; <span class="i">$fields</span>{<span class="w">onlinestatus</span>} <span class="k">eq</span> <span class="q">&quot;live&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$touser</span> = <span class="i">$1</span><span class="sc">;</span>    <span class="c"># payment destination</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$terror</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
                <span class="i">$class</span><span class="cm">,</span>      <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span>
                <span class="q">&#39;om_users&#39;</span><span class="cm">,</span>  <span class="q">&#39;*&#39;</span><span class="cm">,</span>
                <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$touser</span><span class="cm">,</span>
                <span class="i">$token</span><span class="cm">,</span>      <span class="i">$offset</span><span class="cm">,</span>
                <span class="i">$limit</span>
            <span class="s">)</span><span class="sc">;</span>
            <span class="i">$ok</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="q">&quot;$messages{manufacturererror}-&gt;$touser&quot;</span>
              <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># don&#39;t go on if even one &#39;manufacturer&#39; is not found</span>
    <span class="k">print</span>
<span class="q">&quot;Location: $fields{cancel_url}?$fields{osCsid}&amp;payment_error=1&amp;error_message=$message\n\n&quot;</span>
      <span class="k">if</span> <span class="s">(</span> !<span class="i">$ok</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$html</span> .= <span class="q">&quot;$key:$fields{$key}&lt;br/&gt;&quot;</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/^to:(\w+)/</span> &amp;&amp; <span class="i">$fields</span>{<span class="w">onlinestatus</span>} <span class="k">eq</span> <span class="q">&quot;live&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$touser</span> = <span class="i">$1</span><span class="sc">;</span>    <span class="c"># payment destination</span>
                 <span class="c"># convert to standard transaction input format, fields etc.</span>
                 <span class="c">#fromregistry : chelsea</span>
            <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$fields</span>{<span class="w">registry</span>}<span class="sc">;</span>
            <span class="i">$transaction</span>{<span class="w">home</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>    <span class="c"># no home, not a web transaction</span>
                                        <span class="c">#subaction : om_trades</span>
            <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

            <span class="c">#toregistry : chelsea, single registry only, currently</span>
            <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$fields</span>{<span class="w">registry</span>}<span class="sc">;</span>

           <span class="c">#tradeAmount : 23 : this value is in the to:userLogin key is quantity</span>
            <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$fields</span>{<span class="i">$key</span>}<span class="sc">;</span>

            <span class="c">#tradeCurrency : ducket</span>
            <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

            <span class="c">#tradeDate : 20050423</span>
            <span class="c"># added by transaction routine at point of processing</span>
            <span class="c"># configured intial status in cclite.cf</span>
            <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$fields</span>{<span class="w">initialPaymentStatus</span>}<span class="sc">;</span>

            <span class="c">#tradeDescription : test</span>
            <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} =
              <span class="q">&quot;store payment from osc: $fields{item_id}&quot;</span><span class="sc">;</span>

            <span class="c">#tradeDestination : ddawg</span>
            <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$touser</span><span class="sc">;</span>

            <span class="c">#tradeItem : test to see variables</span>
            <span class="c">#tradeSource : manager</span>
            <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

            <span class="c"># trade tax flag</span>
            <span class="i">$transaction</span>{<span class="w">tradeTaxflag</span>} = <span class="i">$fields</span>{<span class="w">taxflag</span>}<span class="sc">;</span>

            <span class="c"># make a reference to the transaction hash and</span>
            <span class="c"># call ordinary transaction</span>
            <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span>
                  = <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;osc&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
                    <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>    <span class="c"># endif</span>
        <span class="s">}</span>    <span class="c"># endif: search for manufacturers</span>
    <span class="s">}</span>    <span class="c"># end foreach</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$fields</span>{<span class="w">onlinestatus</span>} <span class="k">eq</span> <span class="q">&quot;live&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;Location: $fields{return_url}?$fields{osCsid}\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
