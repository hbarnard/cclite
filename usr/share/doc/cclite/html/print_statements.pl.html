<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>print_statements.pl</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>print_statements.pl</h1>


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<ul>

		<ul>

			<li><a href="#comments">comments</a></li>
		</ul>

	</ul>

</ul>

<hr name="index" />
</div>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#get_balances_to_date-">package main</a>
<ul>
<li><a href="#get_balances_to_date-">get_balances_to_date</a></li>
<li><a href="#print_statements-">print_statements</a></li>
<li><a href="#style-">style</a></li>
<li><a href="#tablestyle-">tablestyle</a></li>
<li><a href="#paragraph-">paragraph</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<pre>#!/usr/bin/perl 

<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#THE cclite SOFTWARE IS PROVIDED TO YOU &quot;AS IS,&quot; AND WE MAKE NO EXPRESS</span>
<span class="c">#OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,</span>
<span class="c">#OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,</span>
<span class="c">#ANY IMPLIED WARRANTIES OF MERCHANTABILITY,</span>
<span class="c">#FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.</span>
<span class="c">#WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,</span>
<span class="c">#INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,</span>
<span class="c">#INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,</span>
<span class="c">#LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,</span>
<span class="c">#REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER</span>
<span class="c">#WHICH THE LIABILITY MAY BE ASSERTED,</span>
<span class="c">#EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.</span>
<span class="c">#---------------------------------------------------------------------------</span>
<span class="c">#</span>
<span class="c"># these batch scripts are kept as eval, if they fail they print their problems</span>
<span class="c"># onto the status web page</span>

</pre><p>This duplicates show_balance_and_colume somewhat but with date restrictionssince we don't want to include the current transactions in the -previous- balance figures</p>
<p>Although it would be elegant to merge the two, it may just create extra complexity...</p>
<pre>
<a name="get_balances_to_date-"></a><span class="k">sub </span><span class="m">get_balances_to_date</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$statement_month</span><span class="cm">,</span> <span class="i">$statement_year</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> SELECT tradeId,tradeCurrency as currency, sum(tradeAmount) as sum from om_trades </span>
<span class="hh">where tradeType = &#39;credit&#39; and</span>
<span class="hh">tradeDestination = &#39;$user&#39; and</span>
<span class="hh">( tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39; ) and</span>
<span class="hh">tradeDestination != &#39;cash&#39; and (datediff(tradeDate,&#39;$statement_year-$statement_month-1&#39;) &lt; 0)</span>
<span class="hh">group by currency</span>
<span class="hh">union</span>

<span class="hh">SELECT tradeId,tradeCurrency as currency, -(sum(tradeAmount)) as sum from om_trades </span>
<span class="hh">where tradeType = &#39;debit&#39; and</span>
<span class="hh">tradeSource = &#39;$user&#39; and</span>
<span class="hh">( tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39; ) and</span>
<span class="hh">tradeDestination != &#39;cash&#39; and (datediff(tradeDate,&#39;$statement_year-$statement_month-1&#39;) &lt; 0)</span>
<span class="hh">group by currency     </span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="i">%total_balance</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$balance_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;tradeId&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$balance_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$total_balance</span>{ <span class="i">$balance_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;currency&#39;</span>} } +=
          <span class="i">$balance_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;sum&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$balances</span><span class="sc">;</span>

    <span class="c"># this is a little ugly, formatted a second variable for printed</span>
    <span class="c"># and kept a hash ref in &#39;pence&#39; for the cumulative addition 5/2011</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%total_balance</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$printed_balance</span> = <span class="i">$total_balance</span>{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="i">$printed_balance</span> = <span class="k">sprintf</span> <span class="q">&quot;%.2f&quot;</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$printed_balance</span> / <span class="n">100</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">usedecimals</span>} <span class="k">eq</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$balances</span> .= <span class="q">&quot;$key = $printed_balance \n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$balances</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">Previous balances are:</span>
<span class="hh">$balances</span>
<span class="hh">-----------------------</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$balances</span><span class="cm">,</span> \<span class="i">%total_balance</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p>There are three parts to this, like Gaul:</p><p>1. Get the balances on file from previous months for all currencies
2. Print and cumulate the current month
3. Calculate and print balances reported at the end of the month</p>
<p>Since there's now a facility for decimals, all arithmetic is done with
'pence', 'cents' etc and reformatted at the end</p>
<pre>
<a name="print_statements-"></a><span class="k">sub </span><span class="m">print_statements</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>    <span class="i">$db</span><span class="cm">,</span>              <span class="i">$user_hash_ref</span><span class="cm">,</span>
        <span class="i">$document</span><span class="cm">,</span> <span class="i">$statement_month</span><span class="cm">,</span> <span class="i">$statement_year</span><span class="cm">,</span>
        <span class="i">$title</span><span class="cm">,</span>    <span class="i">$table_lines</span><span class="cm">,</span>     <span class="i">$column_headers_hash_ref</span><span class="cm">,</span>
        <span class="i">$token</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># starts at 1 to give headings ...</span>
    <span class="k">my</span> <span class="i">$item_counter</span>      = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_row_counter</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_counter</span>     = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%total_this_month</span><span class="sc">;</span>    <span class="c"># hash keyed by currency</span>

    <span class="c"># individual statement lines..</span>
    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT tradeId,tradeType,tradeDate,tradeTitle, tradeSource,tradeDestination, tradeCurrency, -(tradeAmount) as tradeAmount from om_trades </span>
<span class="hh"> where (tradeSource = &#39;$user_hash_ref-&gt;{&#39;userLogin&#39;}&#39; and tradeType = &#39;debit&#39; and month(tradeDate) = &#39;$statement_month&#39; and year(tradeDate) = &#39;$statement_year&#39;)</span>
<span class="hh">union</span>
<span class="hh">SELECT tradeId,tradeType,tradeDate,tradeTitle, tradeSource,tradeDestination, tradeCurrency, tradeAmount from om_trades </span>
<span class="hh"> where (tradeDestination = &#39;$user_hash_ref-&gt;{&#39;userLogin&#39;}&#39; and tradeType = &#39;credit&#39; and month(tradeDate) = &#39;$statement_month&#39; and year(tradeDate) = &#39;$statement_year&#39;)</span>

<span class="h">EOT</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$trade_hash_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;tradeId&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no trade data, return</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">scalar</span> <span class="k">keys</span> <span class="i">%$trade_hash_ref</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># tradeId,tradeStatus,tradeDate,tradeSource,tradeDestination,tradeMirror,tradeCurrency,tradeType,tradeAmount</span>
<span class="c"># how many records in total in the yellow pages</span>
    <span class="k">my</span> <span class="i">$total_lines</span> = <span class="k">scalar</span> <span class="k">keys</span> <span class="i">%$trade_hash_ref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$table_count</span> = <span class="i">$total_lines</span> / <span class="i">$table_lines</span><span class="sc">;</span>

    <span class="c"># if there&#39;s a remainder increment table count...</span>
    <span class="i">$total_lines</span> % <span class="i">$table_lines</span> ? <span class="i">$table_count</span>++ <span class="co">:</span> <span class="i">$table_count</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$address</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    $user_hash_ref-&gt;{&#39;userName&#39;}</span>
<span class="hh">    $user_hash_ref-&gt;{&#39;userNameornumber&#39;} $user_hash_ref-&gt;{&#39;userStreet&#39;},</span>
<span class="hh">    $user_hash_ref-&gt;{&#39;userTown&#39;} $user_hash_ref-&gt;{&#39;userPostcode&#39;}</span>
<span class="h">EOT</span>

    <span class="c"># address at the top of the statement</span>
    <span class="i">$document</span><span class="i">-&gt;appendParagraph</span><span class="s">(</span>
        <span class="w">text</span>  <span class="cm">=&gt;</span> <span class="i">$address</span><span class="cm">,</span>
        <span class="w">style</span> <span class="cm">=&gt;</span> <span class="q">&#39;Text body&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># formatting done already, perhaps that&#39;s a misteak...</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$balances</span><span class="cm">,</span> <span class="i">$total_balance_todate_ref</span> <span class="s">)</span> =
      <span class="i">get_balances_to_date</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user_hash_ref</span>-&gt;{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="i">$statement_month</span><span class="cm">,</span> <span class="i">$statement_year</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$document</span><span class="i">-&gt;appendParagraph</span><span class="s">(</span>
        <span class="w">text</span>  <span class="cm">=&gt;</span> <span class="i">$balances</span><span class="cm">,</span>
        <span class="w">style</span> <span class="cm">=&gt;</span> <span class="q">&#39;Text body&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;BlueStyle&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># print &quot;total lines are $total_lines\n&quot; ;</span>

    <span class="c"># write out empty table pages + page break paragraph, ready to fill</span>
    <span class="k">for</span> <span class="s">(</span> <span class="i">$x</span> = <span class="n">1</span> <span class="sc">;</span> <span class="i">$x</span> &lt;= <span class="i">$table_count</span> <span class="sc">;</span> <span class="i">$x</span>++ <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$table_id</span> = <span class="q">&quot;t$user_hash_ref-&gt;{&#39;userLogin&#39;}$x&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$table</span> =
          <span class="i">$document</span><span class="i">-&gt;appendTable</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$table_lines</span> + <span class="n">1</span> <span class="s">)</span><span class="cm">,</span> <span class="n">8</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;textStyle</span><span class="s">(</span> <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeDate&#39;</span>}<span class="cm">,</span>
            <span class="q">&#39;BlueStyle&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeDate&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeSource&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeDestination&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeCurrency&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeTitle&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;debit&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$table_id</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span>
            <span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;credit&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>    <span class="c"># endif write out empty table</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$trade_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$current_table</span> = <span class="q">&quot;t$user_hash_ref-&gt;{&#39;userLogin&#39;}$table_counter&quot;</span><span class="sc">;</span>

        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeDate&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeSource&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeDestination&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeCurrency&#39;</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeTitle&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># different column for credits and Debits</span>
        <span class="k">my</span> <span class="i">$column</span><span class="sc">;</span>
        <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeType&#39;</span>} <span class="k">eq</span> <span class="q">&#39;credit&#39;</span>
          ? <span class="s">(</span> <span class="i">$column</span> = <span class="n">6</span> <span class="s">)</span>
          <span class="co">:</span> <span class="s">(</span> <span class="i">$column</span> = <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># running totals but in pence, format at end...</span>
        <span class="i">$total_this_month</span>{ <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeCurrency&#39;</span>} } +=
          <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeAmount&#39;</span>}<span class="sc">;</span>

        <span class="c"># experimental: show decimal places for trades</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">usedecimals</span>} <span class="k">eq</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeAmount&#39;</span>} = <span class="k">sprintf</span> <span class="q">&quot;%.2f&quot;</span><span class="cm">,</span>
              <span class="s">(</span> <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeAmount&#39;</span>} / <span class="n">100</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">my</span> <span class="i">$cell</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$item_counter</span> % <span class="n">2</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">3</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">4</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">6</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$cell</span> = <span class="i">$document</span><span class="i">-&gt;getCell</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="n">7</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$document</span><span class="i">-&gt;cellStyle</span><span class="s">(</span> <span class="i">$cell</span><span class="cm">,</span> <span class="q">&#39;TelCell&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>    <span class="c"># endif write blue cells</span>

        <span class="c">#</span>
        <span class="i">$document</span><span class="i">-&gt;cellValue</span><span class="s">(</span> <span class="i">$current_table</span><span class="cm">,</span> <span class="i">$item_counter</span><span class="cm">,</span> <span class="i">$column</span><span class="cm">,</span>
            <span class="i">$trade_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;tradeAmount&#39;</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$table_row_counter</span>++<span class="sc">;</span>
        <span class="i">$item_counter</span>++<span class="sc">;</span>

        <span class="c"># move to next table and reset table rows</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$table_row_counter</span> &gt; <span class="i">$table_lines</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$table_counter</span>++<span class="sc">;</span>
            <span class="i">$table_row_counter</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>    <span class="c">#end foreach main transaction printing loop</span>

   <span class="c"># print balances for the end of the statement, add previous totals to current</span>
    <span class="k">my</span> <span class="i">$balances_now</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%total_this_month</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$total</span> = <span class="i">$total_this_month</span>{<span class="i">$key</span>} + <span class="i">$total_balance_todate_ref</span>-&gt;{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="c">###   print &quot;$user_hash_ref-&gt;{&#39;userLogin&#39;} $total\n&quot; ;</span>

        <span class="c"># convert to decimals, if switched on</span>
        <span class="i">$total</span> = <span class="k">sprintf</span> <span class="q">&quot;%.2f&quot;</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$total</span> / <span class="n">100</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">usedecimals</span>} <span class="k">eq</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$balances_now</span> .= <span class="q">&quot;Current balance for $key = $total\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$document</span><span class="i">-&gt;appendParagraph</span><span class="s">(</span>
        <span class="w">text</span>  <span class="cm">=&gt;</span> <span class="i">$balances_now</span><span class="cm">,</span>
        <span class="w">style</span> <span class="cm">=&gt;</span> <span class="q">&#39;Text body&#39;</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="c">#create experimental style</span>

<a name="style-"></a><span class="k">sub </span><span class="m">style</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$document</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="i">$document</span><span class="i">-&gt;createStyle</span><span class="s">(</span>
        <span class="q">&quot;BlueStyle&quot;</span><span class="cm">,</span>
        <span class="w">parent</span>     <span class="cm">=&gt;</span> <span class="q">&#39;Text body&#39;</span><span class="cm">,</span>
        <span class="w">family</span>     <span class="cm">=&gt;</span> <span class="q">&#39;paragraph&#39;</span><span class="cm">,</span>
        <span class="w">properties</span> <span class="cm">=&gt;</span> <span class="s">{</span>
            <span class="w">area</span>       <span class="cm">=&gt;</span> <span class="q">&#39;text&#39;</span><span class="cm">,</span>
            <span class="q">&#39;fo:color&#39;</span> <span class="cm">=&gt;</span> <span class="i">rgb2oo</span><span class="s">(</span><span class="q">&#39;blue&#39;</span><span class="s">)</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># create style for cell</span>

<a name="tablestyle-"></a><span class="k">sub </span><span class="m">tablestyle</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$document</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="i">$document</span><span class="i">-&gt;createStyle</span><span class="s">(</span>
        <span class="q">&#39;TelCell&#39;</span><span class="cm">,</span>
        <span class="w">family</span>     <span class="cm">=&gt;</span> <span class="q">&#39;table-cell&#39;</span><span class="cm">,</span>
        <span class="w">properties</span> <span class="cm">=&gt;</span> <span class="s">{</span>
            -<span class="w">area</span> <span class="cm">=&gt;</span> <span class="q">&#39;table-cell&#39;</span><span class="cm">,</span>

            <span class="q">&#39;fo:background-color&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;#BDEDFF&#39;</span><span class="cm">,</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>

</pre><pre>
my ($document) = @_;</pre>
<p>$document-&gt;createStyle ( 'TelCell', family =&gt; 'table-cell',
                        properties =&gt; { -area =&gt; 'table-cell', 
                        'fo:padding-left' =&gt; '1.00mm', 
                        'fo:padding-right' =&gt; '1.00mm', 
                        'fo:padding-top' =&gt; '1.00mm', 
                        'fo:padding-bottom' =&gt; '1.00mm',
                        'fo:background-color' =&gt; rgb2oo('blue'), 
                        'fo:border' =&gt; '0.02mm solid #000000', }
); 
=cut</p>
<pre>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<a name="paragraph-"></a><span class="k">sub </span><span class="m">paragraph</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$document</span><span class="cm">,</span> <span class="i">$text</span><span class="cm">,</span> <span class="i">$break</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$para</span> = <span class="i">$document</span><span class="i">-&gt;appendParagraph</span><span class="s">(</span>
        <span class="w">text</span>  <span class="cm">=&gt;</span> <span class="i">$text</span><span class="cm">,</span>
        <span class="i">style</span> <span class="cm">=&gt;</span> <span class="q">&quot;BlueStyle&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$document</span><span class="i">-&gt;setPageBreak</span><span class="s">(</span><span class="i">$para</span><span class="s">)</span> <span class="k">if</span> <span class="i">$break</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="comments">comments</a></h3>

<pre>
<span class="k">use</span> <span class="w">lib</span> <span class="q">&quot;../../../lib&quot;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">locale</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Log::Log4perl</span><span class="sc">;</span>

<span class="c">#Log::Log4perl-&gt;init( $configuration{&#39;loggerconfig&#39;} );</span>
<span class="c">#our $log = Log::Log4perl-&gt;get_logger(&quot;cclite&quot;);</span>

<span class="k">use</span> <span class="w">OpenOffice::OODoc</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccdirectory</span><span class="sc">;</span>    <span class="c"># yellow pages directory etc.</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>       <span class="c"># security and hashing</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>       <span class="c"># this probably should be delegated</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>         <span class="c"># for gettrades, at least</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>

<span class="k">print</span> <span class="q">&quot;Content-type: text/html\n\n&quot;</span><span class="sc">;</span>

<span class="k">our</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%fields</span> = <span class="i">cgiparse</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#replace entirely with cgi in a while...</span>
<span class="k">my</span> <span class="i">$statement_month</span> = <span class="i">$fields</span>{<span class="q">&#39;month&#39;</span>}     || <span class="i">$ARGV</span>[<span class="n">0</span>]<span class="sc">;</span>
<span class="k">my</span> <span class="i">$statement_year</span>  = <span class="i">$fields</span>{<span class="q">&#39;year&#39;</span>}      || <span class="i">$ARGV</span>[<span class="n">1</span>]<span class="sc">;</span>
<span class="k">my</span> <span class="i">$user_or_all</span>     = <span class="i">$fields</span>{<span class="q">&#39;userorall&#39;</span>} || <span class="i">$ARGV</span>[<span class="n">2</span>] || <span class="q">&#39;all&#39;</span><span class="sc">;</span>

<span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$statement_month</span><span class="s">)</span> || !<span class="k">length</span><span class="s">(</span><span class="i">$statement_year</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="q">&quot;need month and year for statements\n\n&quot;</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$registry</span>  = <span class="i">$$cookieref</span>{<span class="w">registry</span>} || <span class="q">&#39;dalston&#39;</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$language</span>  = <span class="i">$$cookieref</span>{<span class="w">language</span>} || <span class="q">&#39;en&#39;</span><span class="sc">;</span>

<span class="c"># lines in one page of table</span>
<span class="k">my</span> <span class="i">$table_lines</span> = <span class="n">40</span><span class="sc">;</span>

<span class="c"># where to create the open-office output, whilst testing</span>
<span class="k">my</span> <span class="i">$output_file</span> = <span class="q">&quot;/home/hbarnard/cclite-support-files/testing/statements.odt&quot;</span><span class="sc">;</span>

<span class="c"># correct path for output file</span>
<span class="c"># my $output_file = &quot;$configuration{&#39;printdir&#39;}/$registry/$language&quot;</span>

<span class="c"># title of each page</span>
<span class="k">my</span> <span class="i">$title</span> = <span class="q">&quot;Statement&quot;</span><span class="sc">;</span>

<span class="c"># headings for table columns</span>
<span class="k">my</span> <span class="i">$column_headers_hash_ref</span><span class="sc">;</span>

<span class="c"># change these, where necessary, column headers</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeId&#39;</span>}          = <span class="q">&#39;Id&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeStatus&#39;</span>}      = <span class="q">&#39;Status&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeDate&#39;</span>}        = <span class="q">&#39;Date&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeSource&#39;</span>}      = <span class="q">&#39;From&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeDestination&#39;</span>} = <span class="q">&#39;To&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeMirror&#39;</span>}      = <span class="q">&#39;Registry&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeCurrency&#39;</span>}    = <span class="q">&#39;Currency&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeType&#39;</span>}        = <span class="q">&#39;Type&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;tradeTitle&#39;</span>}       = <span class="q">&#39;Description&#39;</span><span class="sc">;</span>

<span class="c"># these don&#39;t correspond to fields...</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;debit&#39;</span>}  = <span class="q">&#39;Money Out&#39;</span><span class="sc">;</span>
<span class="i">$column_headers_hash_ref</span>-&gt;{<span class="q">&#39;credit&#39;</span>} = <span class="q">&#39;Money In&#39;</span><span class="sc">;</span>

<span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># write the printed document out by directory and language...</span>

<span class="k">my</span> <span class="i">$document</span> = <span class="i">odfDocument</span><span class="s">(</span>
    <span class="w">file</span>   <span class="cm">=&gt;</span> <span class="i">$output_file</span><span class="cm">,</span>
    <span class="w">create</span> <span class="cm">=&gt;</span> <span class="q">&#39;text&#39;</span>
<span class="s">)</span><span class="sc">;</span>

<span class="i">style</span><span class="s">(</span><span class="i">$document</span><span class="s">)</span><span class="sc">;</span>
<span class="i">tablestyle</span><span class="s">(</span><span class="i">$document</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># get all users</span>
<span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$user_hash_ref</span> <span class="s">)</span> =
  <span class="i">get_where_multiple</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="q">&#39;*&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
    <span class="n">0</span><span class="cm">,</span> <span class="n">9999999</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$user_hash_ref</span> <span class="s">)</span> <span class="s">{</span>

    <span class="c"># don&#39;t print system accounts as printed statements</span>
    <span class="k">next</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$user_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;userLevel&#39;</span>} <span class="k">eq</span> <span class="q">&#39;sysaccount&#39;</span>
        || <span class="i">$user_hash_ref</span>-&gt;{<span class="i">$key</span>}-&gt;{<span class="q">&#39;userLevel&#39;</span>} <span class="k">eq</span> <span class="q">&#39;admin&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">paragraph</span><span class="s">(</span>
        <span class="i">$document</span><span class="cm">,</span>
<span class="q">&quot;$title for $user_hash_ref-&gt;{$key}-&gt;{&#39;userLogin&#39;} $statement_month/$statement_year&quot;</span><span class="cm">,</span>
        <span class="n">1</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">print_statements</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>   <span class="i">$registry</span><span class="cm">,</span>        <span class="i">$user_hash_ref</span>-&gt;{<span class="i">$key</span>}<span class="cm">,</span>
        <span class="i">$document</span><span class="cm">,</span> <span class="i">$statement_month</span><span class="cm">,</span> <span class="i">$statement_year</span><span class="cm">,</span>
        <span class="i">$title</span><span class="cm">,</span>    <span class="i">$table_lines</span><span class="cm">,</span>     <span class="i">$column_headers_hash_ref</span><span class="cm">,</span>
        <span class="i">$token</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="i">$document</span><span class="i">-&gt;save</span><span class="sc">;</span>
<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
